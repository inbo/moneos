---
params:
  hoofdstuk: "100_watervogels"
knit: (function(inputFile, encoding) {
        rmarkdown::render(inputFile,
                          encoding=encoding,
                          output_dir = paste0(
                          rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, 
                          "/output")
                          )})
title: "watervogeldata"
output:
  bookdown::word_document2
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

```

```{r libraries}

library(tidyverse)
library(lubridate)
#library(inborutils)  ## moet dat nu inbodb worden??
library(inbodb)
library(DBI)
library(rprojroot) ## workaround pad


```

```{r pad}

# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")

```


```{r benodigde-seizoenen}

vroegste_seizoen <- "1991/1992"
laatste_seizoen <- "2021/2022"

seizoenen <-
  (vroegste_seizoen %>% str_sub(0, 4) %>% as.numeric):(laatste_seizoen %>% str_sub(0, 4) %>% as.numeric) %>% 
  paste(., {.+1} %>% as.character() %>% str_sub(3, 5), sep = "/")

seizoenen_query <-
  paste0("'", seizoenen, "'", collapse = ",") %>% 
  paste0("(", ., ")")

```


```{r gebiedsgroepen}
gebiedsgroepenall <- 
  read_delim(paste0(pad_data, "Zeeschelde_gebiedsgroepen.csv"),
             delim = ";") %>% 
   mutate(gebiedscode = as.character(gebiedscode))

gebiedsgroepen <- 
  read_delim(paste0(pad_data, "Zeeschelde_gebiedsgroepen.csv"),
             delim = ";") %>% 
  filter(gebiedsgroeptype_code == "KRWZS") %>% 
  mutate(gebiedscode = as.character(gebiedscode))

```

```{r sigmagebieden}

##Gebiedskenmerken

## lijst met telgebieden aangemaakt met een aantal kenmerken - file Wim  
# Gebied2 <- read_delim(paste0(pad_data, "Gebieden2.csv"),
#              delim = ";")
## Gebied: naam van telgebied zoals in databank
## Estuarien: 1: getijderivier, 0: geen getijderivier (estuariene Sigmaprojectgebieden: 0)
## Vallei: 1: valleigebied; 0: geen valleigebied
## Sigma: 1 Sigmaprojectgebied, 0: geen Sigmaprojectgebied
## NOHaven: 1: Natuurontwikkelingsgebieden van de haven, 0: geen NOgebied van haven
## Voor de Sigmaprojectgebieden is er bijkomende info.

# Sigma2 <- Gebied2 %>% 
#   filter(Sigma == 1) %>% 
#   rename(gebiedsnaam = Gebied)

gebiedsgroepenSigma <- gebiedsgroepenall %>%
  filter(gebiedsgroeptype == "Sigma-gebieden") %>%
  mutate(gebiedscode = as.character(gebiedscode))

gebiedsgroepenSigma_zeeschelde <- gebiedsgroepenall %>%
  filter(gebiedsgroeptype == "Sigma-gebieden") %>%
  filter(rivier == "Zeeschelde") %>% 
  mutate(gebiedscode = as.character(gebiedscode))

##vergelijking tussen de files van Wim en Gunther
# check <- Sigma2 %>%
#   left_join(gebiedsgroepenSigma)
## de file van gebiedsgroepen verschilt een beetje voor de sigmagebieden in Gebied2 (basis natuurindicator) maar niet veel en je kan erover ##discussieren of je sommige gebieden kan tellen als sigmagebied ##
##Burchtse weel zoet water buffer is geen deel van Sigma (zit wel in vallei)
##Kalkense meersen Scherenmeersen is geen apart telgebied volgens de watervogeltelgebieden op S-server (zit bij kalkense meersen)
##NOHaveis is onbekend in watervogeltelgebieden layer
##Lillo fort - LocationWVNaam is in watervogeldatabank FORT Lillo (selectie zal niet gebeuren met Gebied2 set)  

```

```{r valleigebieden}

gebiedsgroepenVallei <- gebiedsgroepenall %>%
  filter(gebiedsgroeptype != "Sigma-gebieden") %>%
  filter(gebiedsgroep == "Vallei") %>%
  mutate(gebiedscode = as.character(gebiedscode))

gebiedsgroepenVallei_zeeschelde <- gebiedsgroepenall %>%
  filter(gebiedsgroeptype != "Sigma-gebieden") %>%
  filter(gebiedsgroep == "Vallei") %>%
  filter(rivier == "Zeeschelde") %>% 
  mutate(gebiedscode = as.character(gebiedscode))
```


```{r query-tellingen}

query_tellingen <- 
"SELECT 
  su.SurveyCode AS ProjectCode
, su.SurveyNaam AS Project
, a.AnalyseSetKey AS AnalyseSetCode
, a.AnalyseSetNaam AS AnalyseSet
, l.RegioWVNaam AS Regio
, l.LocationWVCode AS GebiedsCode
, l.LocationWVNaam AS Gebied
, ss.Seasonname AS Telseizoen
, e.EventLabel AS Telling
, e.SortOrder AS TellingSortOrder
, f.SampleDate AS Teldatum
, s.CoverageCode AS TelvolledigheidCode
, s.CoverageDescription AS Telvolledigheid
, s.IsNulTelling AS Nultelling
FROM FactAnalyseSetOccurrence f
  INNER JOIN DimSurvey su ON su.surveykey = f.surveykey
  INNER JOIN DimAnalyseSet a ON a.AnalyseSetKey = f.AnalyseSetKey
  INNER JOIN DimLocationWV l ON l.locationwvkey = f.locationwvkey
  INNER JOIN DimSeason ss ON ss.Seasonkey = f.seasonkey
  INNER JOIN DimEvent e ON e.eventkey = f.eventkey
  INNER JOIN DimSample s ON s.SampleKey = f.SampleKey
WHERE 1=1
  AND s.samplestatus = 'CHECKED' /**alleen gevalideerde records**/
  AND s.coveragecode not in ('-', 'N')  /**niet getelde tellingen zijn irrelevant**/
;"

query_grouping <- 
"GROUP BY 
  su.SurveyCode
, su.SurveyNaam
, a.AnalyseSetKey
, a.AnalyseSetNaam
, l.RegioWVCode
, l.RegioWVNaam
, l.LocationWVCode
, l.LocationWVNaam
, ss.Seasonname
, e.EventCode
, e.EventLabel
, e.SortOrder
, f.SampleDate
, s.CoverageCode
, s.CoverageDescription
, s.IsNulTelling;"




```


```{r bevragen-warehouse-zeeschelde-tellingen}

query <-
  paste0(str_sub(query_tellingen, end=-2),
         " AND f.AnalyseSetKey = 1 /**alleen Zeescheldetellingen**/",
         " AND ss.seasonname in ",
         seizoenen_query,
         str_sub(query_grouping, end=-2),
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
overzicht_tellingen <- 
  dbGetQuery(con,
             query)
# dbDisconnect(con)

# selectie van de telgebieden gespecifieerd in de Zeeschelde_gebiedsgroepen - KRWZS
overzicht_tellingen <-
  overzicht_tellingen %>% 
  filter(GebiedsCode %in% gebiedsgroepen$gebiedscode)

overzicht_tellingen %>% 
  distinct(Nultelling)

```

 
```{r basis-query bevraging Watervogeldatabank}

basis_query <-
  paste0(
"SELECT
  SU.SurveyCode as ProjectCode
, SU.SurveyNaam as Project
, L.RegioWVCode as RegioCode
, L.RegioWVNaam as Regio
, L.LocationWVCode as GebiedsCode
, L.LocationWVNaam as Gebied
, SS.Seasonname as Telseizoen
, E.EventCode as TellingCode
, E.EventLabel as Telling
, E.SortOrder as TellingSortOrder
, S.sampleDate as Teldatum
, S.CoverageCode as Telvolledigheid
, T.Commonname as NedNaam
, T.scientificname as WetNaam
, T.TaxonGroupCode
, F.Taxoncount as Aantal

FROM FactAnalyseSetOccurrence F
inner join DimSurvey SU on SU.surveykey = F.surveykey
inner join DimLocationWV L on L.locationwvkey = F.locationwvkey
inner join DimSeason SS on SS.Seasonkey = F.seasonkey
inner join DimEvent E on E.eventkey = F.eventkey
inner join DimSample S on F.samplekey = S.samplekey
inner join DimTaxonWV T on T.taxonwvkey = F.taxonwvkey
WHERE 1=1
  AND S.samplestatus = 'CHECKED' /**alleen gevalideerde records**/
  AND S.coveragecode not in ('-', 'N')  /**niet getelde tellingen zijn irrelevant**/
  AND F.taxoncount > 0;"
  )

```


```{r checken details in databank}

# con <- connect_inbo_dbase("W0004_00_Waterbirds")
# 
# q_WVgebiedenLier <- "SELECT *
#                      FROM DimLocationWV
#                      WHERE LocationWVNaam LIKE '%LIER%' AND
#                            LocationWVNaam NOT LIKE '%LIERE%'"
# 
# q_WVgebiedenNete <- "SELECT *
#                      FROM DimLocationWV
#                      WHERE LocationWVNaam LIKE '%Nete%'"
# 
# 
# # Selectie gebieden in Lier                     
# GebiedenLier <- 
#   tbl(src = con, sql(q_WVgebiedenLier)) %>% 
#   select(LocationWVCode, LocationWVNaam, IsStandardizedLocationWV) %>% 
#   collect()
# 
# GebiedenNete <- 
#   tbl(src = con, sql(q_WVgebiedenNete)) %>% 
#   select(LocationWVCode, LocationWVNaam, IsStandardizedLocationWV) %>% 
#   collect()
# 
# # query midmaandelijkse tellingen
# q_midmaandtellingen <- 
#   "SELECT SU.SurveyCode as ProjectCode
# , SU.SurveyNaam as Project
# , L.RegioWVCode as RegioCode
# , L.RegioWVNaam as Regio
# , L.LocationWVCode as GebiedsCode
# , L.LocationWVNaam as Gebied
# , SS.Seasonname as Telseizoen
# , E.EventCode as TellingCode
# , E.EventLabel as Telling
# , E.SortOrder as TellingSortOrder
# , S.sampleDate as Teldatum
# --, S.IceCoverCode as Ijsbedekking
# --, S.SnowCoverCode as Sneeuwbedekking
# , S.CoverageCode as Telvolledigheid
# , T.Commonname as NedNaam
# , T.scientificname as WetNaam
# , T.TaxonGroupCode
# , F.Taxoncount as Aantal
# FROM FactAnalyseSetOccurrence F
# inner join DimSurvey SU on SU.surveykey = F.surveykey
# inner join DimLocationWV L on L.locationwvkey = F.locationwvkey
# inner join DimSeason SS on SS.Seasonkey = F.seasonkey
# inner join DimEvent E on E.eventkey = F.eventkey
# inner join DimSample S on F.samplekey = S.samplekey
# inner join DimTaxonWV T on T.taxonwvkey = F.taxonwvkey
# WHERE 1=1
#   "
# # Selectie midmaandelijkse tellingen in gebieden Lier
# WaterbirdsLier <- 
#   tbl(src = con, 
#       sql(q_midmaandtellingen)) %>% 
#   filter(GebiedsCode %in% !!GebiedenLier$LocationWVCode) %>% 
#   collect()
# 
# WaterbirdsNete <- 
#   tbl(src = con, 
#       sql(q_midmaandtellingen)) %>% 
#   filter(GebiedsCode %in% !!GebiedenNete$LocationWVCode) %>% 
#   collect()
# 
# dbDisconnect(con)
# 
# # Totalen per gebied per seizoen
# Totaal_n_Watervogels_Gebied_seizoen_Lier <- 
#   WaterbirdsLier %>% 
#   group_by(Gebied, Telseizoen) %>% 
#   summarise(Totaal = sum(Aantal, na.rm = TRUE)) %>% 
#   spread(key = Gebied, value = Totaal)
# 
# Totaal_n_Watervogels_Gebied_seizoen_Nete <- 
#   WaterbirdsNete %>% 
#   group_by(Gebied, Telseizoen) %>% 
#   summarise(Totaal = sum(Aantal, na.rm = TRUE)) %>% 
#   spread(key = Gebied, value = Totaal)
# 
# 
# # sla op als spreadsheet
# Totaal_n_Watervogels_Gebied_seizoen_Lier %>% 
#   write_delim(paste0(pad_data, "Totalen_gebiedenLier.csv"),
#               delim = ";")
# 
# Totaal_n_Watervogels_Gebied_seizoen_Nete %>% 
#   write_delim(paste0(pad_data, "Totalen_gebiedenNete.csv"),
#               delim = ";")
# 
# 


```


```{r bevragen-warehouse-zeeschelde-analyseset}

query <-
  paste0(str_sub(basis_query, end=-2),
         " AND F.Analysesetkey in (1) /**alleen boottellingen, i.e. uit ZSCH-analyseset**/",
         " AND SS.seasonname in ",
         seizoenen_query,
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
WaterbirdsBT <- 
  dbGetQuery(con,
             query)
dbDisconnect(con)

# selectie van de telgebieden gespecifieerd in de Zeeschelde_gebiedsgroepen - KRWZS
WaterbirdsBT <-
  WaterbirdsBT %>% 
  filter(GebiedsCode %in% gebiedsgroepen$gebiedscode) %>% 
  mutate(Analyseset = "boottelling")

```


```{r toevoegen-warehouse-MIDMA-zijrivieren-analyseset}

telzones_zijrivieren <- 
  gebiedsgroepen$gebiedscode %>% 
  unique() %>% 
  setdiff(WaterbirdsBT$GebiedsCode %>% 
            unique())

telzones_query <-
  paste0("'", telzones_zijrivieren, "'", collapse = ",") %>% 
  paste0("(", ., ")")

query <-
  paste0(str_sub(basis_query, end=-2),
         " AND F.Analysesetkey in (2, 3, 4) /**alleen midmaandelijkse tellingen, i.e. uit MIDMA-analysesets**/",
         " AND SS.seasonname in ",
         seizoenen_query,
         " AND L.LocationWVCode in ",
         telzones_query,
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
waterbirds_zijrivieren <- 
  dbGetQuery(con,
             query)
dbDisconnect(con)

waterbirds_zijrivieren <- waterbirds_zijrivieren %>% 
mutate(Analyseset = "zijrivier_MIDMA")  

WaterbirdsBT <-
  WaterbirdsBT %>% 
  bind_rows(waterbirds_zijrivieren)

```

```{r bevragen-warehouse-MIDMA-Sigma-analyseset}

telzones_sigma <- 
  gebiedsgroepenall %>% 
  filter(gebiedsgroeptype_code == "SIGMA") %>% 
    pull(gebiedsnaam) 


telzones_query <-
  paste0("'", telzones_sigma, "'", collapse = ",") %>% 
  paste0("(", ., ")")

query <-
  paste0(str_sub(basis_query, end=-2),
         " AND F.Analysesetkey in (2, 3, 4) /**alleen midmaandelijkse tellingen, i.e. uit MIDMA-analysesets**/",
         " AND SS.seasonname in ",
         seizoenen_query,
         " AND L.LocationWVNaam in ",
         telzones_query,
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
waterbirds_sigma <- 
  dbGetQuery(con,
             query)
dbDisconnect(con)

waterbirds_sigma <- waterbirds_sigma %>% 
  mutate(Analyseset = "SIGMA_MIDMA") 

WaterbirdsBT <-
  WaterbirdsBT %>% 
  bind_rows(waterbirds_sigma)

######

telzones_sigma_zeeschelde <- 
  gebiedsgroepenall %>% 
  filter(gebiedsgroeptype_code == "SIGMA") %>% 
  filter(rivier == "Zeeschelde") %>% 
    pull(gebiedsnaam) 


telzones_query <-
  paste0("'", telzones_sigma_zeeschelde, "'", collapse = ",") %>% 
  paste0("(", ., ")")

query <-
  paste0(str_sub(basis_query, end=-2),
         " AND F.Analysesetkey in (2, 3, 4) /**alleen midmaandelijkse tellingen, i.e. uit MIDMA-analysesets**/",
         " AND SS.seasonname in ",
         seizoenen_query,
         " AND L.LocationWVNaam in ",
         telzones_query,
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
waterbirds_sigma_zeeschelde <- 
  dbGetQuery(con,
             query)
dbDisconnect(con)

waterbirds_sigma_zeeschelde <- waterbirds_sigma_zeeschelde %>% 
  mutate(Analyseset = "SIGMA_ZSCH_MIDMA") 

WaterbirdsBT <-
  WaterbirdsBT %>% 
  bind_rows(waterbirds_sigma_zeeschelde)
```

```{r bevragen-warehouse-MIDMA-vallei-analyseset}

telzones_vallei <- 
  gebiedsgroepenVallei %>% 
      pull(gebiedsnaam) 

telzones_query <-
  paste0("'", telzones_vallei, "'", collapse = ",") %>% 
  paste0("(", ., ")")

query <-
  paste0(str_sub(basis_query, end=-2),
         " AND F.Analysesetkey in (2, 3, 4) /**alleen midmaandelijkse tellingen, i.e. uit MIDMA-analysesets**/",
         " AND SS.seasonname in ",
         seizoenen_query,
         " AND L.LocationWVNaam in ",
         telzones_query,
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
waterbirds_vallei <- 
  dbGetQuery(con,
             query)
dbDisconnect(con)

waterbirds_vallei <- waterbirds_vallei %>% 
  mutate(Analyseset = "VALLEI_MIDMA") 

WaterbirdsBT <-
  WaterbirdsBT %>% 
  bind_rows(waterbirds_vallei)

####

telzones_vallei_zeeschelde <- 
  gebiedsgroepenVallei_zeeschelde %>% 
      pull(gebiedsnaam) 

telzones_query <-
  paste0("'", telzones_vallei_zeeschelde, "'", collapse = ",") %>% 
  paste0("(", ., ")")

query <-
  paste0(str_sub(basis_query, end=-2),
         " AND F.Analysesetkey in (2, 3, 4) /**alleen midmaandelijkse tellingen, i.e. uit MIDMA-analysesets**/",
         " AND SS.seasonname in ",
         seizoenen_query,
         " AND L.LocationWVNaam in ",
         telzones_query,
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
waterbirds_vallei_zeeschelde <- 
  dbGetQuery(con,
             query)
dbDisconnect(con)

waterbirds_vallei_zeeschelde <- waterbirds_vallei_zeeschelde %>% 
  mutate(Analyseset = "VALLEI_ZSCH_MIDMA") 

WaterbirdsBT <-
  WaterbirdsBT %>% 
  bind_rows(waterbirds_vallei_zeeschelde)

```


```{r basis-query-tellingen}

basis_query_tellingen <-
"WITH NulTelling AS
  (
  SELECT SampleKey
  FROM
  (
  SELECT sampleKey, sum(taxoncount) as AantalIndividu
  FROM FactAnalyseSetOccurrence
  WHERE AnalyseSetKey = 1
  GROUP BY sampleKey
  )tmp
  WHERE tmp.AantalIndividu = 0
  )
SELECT
  su.SurveyCode AS ProjectCode
, su.SurveyNaam AS Project
, a.AnalyseSetKey AS AnalyseSetCode
, a.AnalyseSetNaam AS AnalyseSet
, l.RegioWVNaam AS Regio
, l.LocationWVCode AS GebiedsCode
, l.LocationWVNaam AS Gebied
, ss.Seasonname AS Telseizoen
, e.EventLabel AS Telling
, e.SortOrder AS TellingSortOrder
, f.SampleDate AS Teldatum
, s.CoverageCode AS TelvolledigheidCode
, s.CoverageDescription AS Telvolledigheid
, CASE WHEN NulTelling.SampleKey IS NOT NULL THEN 1 ELSE 0 END AS IsNulTelling
FROM FactAnalyseSetOccurrence f
  INNER JOIN DimSurvey su ON su.surveykey = f.surveykey
  INNER JOIN DimAnalyseSet a ON a.AnalyseSetKey = f.AnalyseSetKey
  INNER JOIN DimLocationWV l ON l.locationwvkey = f.locationwvkey
  INNER JOIN DimSeason ss ON ss.Seasonkey = f.seasonkey
  INNER JOIN DimEvent e ON e.eventkey = f.eventkey
  INNER JOIN DimSample s ON s.SampleKey = f.SampleKey
  LEFT OUTER JOIN NulTelling ON NulTelling.SampleKey = f.SampleKey
WHERE 1=1
  AND s.samplestatus = 'CHECKED' /**alleen gevalideerde records**/
  AND s.coveragecode not in ('-', 'N')  /**niet getelde tellingen zijn irrelevant**/
;"

grouping_tellingen <-
"GROUP BY
  su.SurveyCode
, su.SurveyNaam
, a.AnalyseSetKey
, a.AnalyseSetNaam
, l.RegioWVCode
, l.RegioWVNaam
, l.LocationWVCode
, l.LocationWVNaam
, ss.Seasonname
, e.EventCode
, e.EventLabel
, e.SortOrder
, f.SampleDate
, s.CoverageCode
, s.CoverageDescription
, s.IsNulTelling
, NulTelling.SampleKey;"
```


```{r bevragen-warehouse-zeeschelde-tellingen}

query <-
  paste0(str_sub(basis_query_tellingen, end=-2),
         " AND f.AnalyseSetKey = 1 /**alleen Zeescheldetellingen**/",
         " AND ss.seasonname in ",
         seizoenen_query,
         str_sub(grouping_tellingen, end=-2), 
         ";"
  )

con <- connect_inbo_dbase("W0004_00_Waterbirds")
overzicht_tellingen <-
  dbGetQuery(con,
             query)
dbDisconnect(con)

# selectie van de telgebieden gespecifieerd in de Zeeschelde_gebiedsgroepen - KRWZS
overzicht_tellingen <-
  overzicht_tellingen %>%
  filter(GebiedsCode %in% gebiedsgroepen$gebiedscode)

```

```{r toevoegen-warehouse-tellingen-MIDMA-zijrivieren}

telzones_zijrivieren <-
  gebiedsgroepen$gebiedscode %>%
  unique() %>%
  setdiff(overzicht_tellingen$GebiedsCode %>%
            unique())

telzones_query <-
  paste0("'", telzones_zijrivieren, "'", collapse = ",") %>%
  paste0("(", ., ")")

query <-
  paste0(str_sub(basis_query_tellingen, end=-2),
         " AND f.Analysesetkey = 2 /**alleen midmaandelijkse tellingen, i.e. uit MIDMA-analysesets - voldoende om enkel analyseset 2 te nemen**/",
         " AND ss.seasonname in ",
         seizoenen_query,
         " AND l.LocationWVCode in ",
         telzones_query,
         str_sub(grouping_tellingen, end=-2),
         ";"
  )


con <- connect_inbo_dbase("W0004_00_Waterbirds")
tellingen_zijrivieren <-
  dbGetQuery(con,
             query)
dbDisconnect(con)

overzicht_tellingen <-
  overzicht_tellingen %>%
  bind_rows(tellingen_zijrivieren)


```


```{r correcties-overzicht_tellingen}

# checken voor dubbels in de dataset
overzicht_tellingen  %>% 
    arrange(Gebied, Telseizoen, Telling, Teldatum, ProjectCode) %>% 
  distinct(Gebied, Telseizoen, Telling, Teldatum, ProjectCode)



```


```{r toevoegentellinging-informatie-gebiedsgroepen}

overzicht_tellingen <- 
  overzicht_tellingen %>% 
  rename_all(tolower) %>% 
  left_join(gebiedsgroepen) %>% 
  select(-telling, -tellingsortorder)

```

```{r overzicht-aantal-tellingen}

overzicht_tellingen <-
  overzicht_tellingen %>%
  mutate(IsNulTelling = if_else(isnultelling == 1, "ja", "nee"))


# overzicht aantal tellingen
aantaltellingen <- overzicht_tellingen %>%
  count(analyseset, telvolledigheidcode, telvolledigheid, isnultelling)

knitr::kable(aantaltellingen)

# volledigheid wintertelseizoen
overzicht_tellingen %>% 
  filter (telseizoen == "2021/22") %>% 
  filter(month(teldatum) %in% c(10, 11, 12, 1, 2, 3)) %>% 
  group_by(gebiedscode, gebied, gebiedsgroep_code) %>% 
  count(telseizoen, sort= TRUE) %>% 
  filter (n < 6) # gebieden met minder dan 6 tellingen vertonen ontbrekende wintertellingen
  


overzicht_tellingen %>% 
  filter (telseizoen == "2020/21") %>% 
  filter (gebiedscode == 2050810) %>% 
  select(gebied, teldatum) %>% #kijk alleen naar teldatum want telling en tellingsortorder kloppen niet in databank
  arrange(teldatum)


```



```{r correcties-WaterbirdsBT}

# checken voor dubbels in de dataset
WaterbirdsBT  %>% 
  group_by_at(vars(-Aantal)) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  filter(n>1) %>% 
  arrange(Gebied, Telseizoen, Telling, Teldatum, NedNaam, ProjectCode)

# Correctie hiervoor
WaterbirdsBT <- 
  WaterbirdsBT  %>% 
  group_by_at(vars(-Aantal)) %>% 
  summarise(Aantal = max(Aantal)) %>% # maximum van de dubbele tellingen
  ungroup()

# Twee gebieden in dataset die er niet thuishoren: 
WaterbirdsBT %>% 
  filter(str_detect(Gebied, "aapskooi|Oude Dijle")) %>% 
  group_by(Gebied) %>% 
  summarise() %>% 
  ungroup()

# Correctie
WaterbirdsBT <- 
  WaterbirdsBT %>% 
  filter(!str_detect(Gebied, "aapskooi|Oude Dijle"))

# Telzones op nederlands grondgebied worden niet meegeteld (strik gesproken geen Zeeschelde). Dit gaat over de teltrajecten (9999999 en 9999998) gelegen op Nederlands grondgebied. Deze teltrajecten zitten niet in de gebiedsgroepen file

# # Enkel wintertellingen
# WaterbirdsBTw <- WaterbirdsBT %>% filter(month(Teldatum) %in% c(10, 11, 12, 1, 2, 3))

```

```{r telseizoen metadata}


laatste_telseizoen <- 
  WaterbirdsBT %>% 
  pull(Telseizoen) %>% 
  unique() %>% 
  sort() %>% 
  last()



```

```{r toevoegen-informatie-gebiedsgroepen}

WaterbirdsBTallcheck <- 
  WaterbirdsBT %>% 
  rename_all(tolower) %>% 
  left_join(gebiedsgroepenall) %>% 
  select(gebiedsgroep_code,
         gebiedsgroep,
         rivier,
         gebiedscode,
         gebied = gebiedsnaam,
         telseizoen,
         teldatum,
         nednaam,
         wetnaam,
         taxongroepcode = taxongroupcode,
         aantal,
         analyseset)

WaterbirdsBTallcheck %>% 
  write_delim(paste0(pad_data, "Watervogels_all_ruwedata.csv"),
              delim = ";")

WaterbirdsBT <- 
  WaterbirdsBT %>% 
  rename_all(tolower) %>% 
  left_join(gebiedsgroepen) %>% 
  select(gebiedsgroep_code,
         gebiedsgroep,
         rivier,
         gebiedscode,
         gebied = gebiedsnaam,
         telseizoen,
         teldatum,
         nednaam,
         wetnaam,
         taxongroepcode = taxongroupcode,
         aantal,
         analyseset)

WaterbirdsBTall <- 
   WaterbirdsBT


```

```{r controle volledigheid}
Aantaltellingenpergebied0 <- WaterbirdsBT %>% 
    filter (telseizoen == "2020/21") %>% 
  count(gebiedsgroep_code, telseizoen, teldatum) 
  
# aantal tellingen per telseizoen ingevoerd 
Aantaltellingenpergebied <- WaterbirdsBT %>% 
  filter(analyseset =="boottelling") %>% 
  filter (telseizoen == "2020/21") %>% 
  distinct(gebiedsgroep_code, gebiedscode, teldatum, telseizoen) %>% 
  count(gebiedsgroep_code, gebiedscode, telseizoen) 
  

knitr::kable(Aantaltellingenpergebied)

Aantaltellingenpergebied <- WaterbirdsBT %>% 
  filter(analyseset =="zijrivier_MIDMA") %>% 
  filter (telseizoen == "2021/22") %>% 
  distinct(gebiedsgroep_code, gebiedscode, teldatum, telseizoen) %>% 
  count(gebiedsgroep_code, gebiedscode, telseizoen) 
  

knitr::kable(Aantaltellingenpergebied)

Aantaltellingenpergebied <- WaterbirdsBT %>% 
  filter(analyseset =="SIGMA_MIDMA") %>% 
  filter (telseizoen == "2021/22") %>% 
  distinct(gebiedsgroep_code, gebiedscode, teldatum, telseizoen) %>% 
  count(gebiedsgroep_code, gebiedscode, telseizoen) 
  

knitr::kable(Aantaltellingenpergebied)

```

```{r optellen-per-gebiedsgroep-rivier MONEOS dataset}

WaterbirdsBT <- 
  WaterbirdsBT %>% 
  filter(analyseset == "boottelling" | analyseset == "zijrivier_MIDMA") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Zeeschelde en Zijrivieren")

WaterbirdsBT_ZSCH <- 
  WaterbirdsBTall %>% 
  filter(analyseset == "boottelling") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "boottelling")

WaterbirdsBT_sigma <- 
  WaterbirdsBTall %>% 
  filter(analyseset == "SIGMA_MIDMA") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Sigma")

WaterbirdsBT_sigma_zeeschelde <- 
  WaterbirdsBTall %>% 
  filter(analyseset == "SIGMA_ZSCH_MIDMA") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Sigma Zeeschelde")

WaterbirdsBT_vallei <- 
  WaterbirdsBTall %>% 
  filter(analyseset == "VALLEI_MIDMA") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Vallei")

WaterbirdsBT_vallei_zeeschelde <- 
  WaterbirdsBTall %>% 
  filter(analyseset == "VALLEI_ZSCH_MIDMA") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Vallei Zeeschelde")


####data ontpolderingen en GGG's Sigma

WaterbirdsBT_sigma_estuarien <- 
  WaterbirdsBTallcheck %>% 
  filter(gebiedsgroep == "GGG" | gebiedsgroep == "Ontpoldering") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Sigma_estuarien")

WaterbirdsBT_sigma_wetland <- 
  WaterbirdsBTallcheck %>% 
  filter(gebiedsgroep == "Wetland") %>% 
  group_by(gebiedsgroep_code,
           gebiedsgroep,
           rivier,
           telseizoen,
           teldatum,
           nednaam,
           wetnaam,
           taxongroepcode) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  mutate(analyseset = "Sigma_wetland")


```


```{r toevoegen-nultellingen, eval=FALSE}

WaterbirdsBT <- 
  WaterbirdsBT %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

WaterbirdsBT_ZSCH <- 
  WaterbirdsBT_ZSCH %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

WaterbirdsBT_sigma <- 
  WaterbirdsBT_sigma %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

WaterbirdsBT_sigma_zeeschelde <- 
  WaterbirdsBT_sigma_zeeschelde %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))


WaterbirdsBT_sigma_estuarien <- 
  WaterbirdsBT_sigma_estuarien %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

WaterbirdsBT_sigma_wetland <- 
  WaterbirdsBT_sigma_wetland %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

WaterbirdsBT_vallei <- 
  WaterbirdsBT_vallei %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

WaterbirdsBT_vallei_zeeschelde <- 
  WaterbirdsBT_vallei_zeeschelde %>% 
  complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
           nesting(nednaam, wetnaam, taxongroepcode),
           fill = list(0))

```


```{r wegschrijven-data}

WaterbirdsBT %>% 
  write_delim(paste0(pad_data, "Watervogels_Zeeschelde.csv"),
              delim = ";")
WaterbirdsBT_ZSCH %>% 
  write_delim(paste0(pad_data, "Watervogels_Zeeschelde_SS.csv"),
              delim = ";")


WaterbirdsBT %>% 
  mutate(maand = month(teldatum)) %>% 
  dplyr::select(-c(taxongroepcode,gebiedsgroep_code, wetnaam, teldatum, analyseset)) %>% 
  dplyr::rename(KRW_zone = gebiedsgroep) %>% 
  write_delim(paste0(pad_data, "Watervogels_ZeescheldeVLIZ.csv"),
              delim = ";")


WaterbirdsBT_sigma %>% 
  write_delim(paste0(pad_data, "Watervogels_Sigma.csv"),
              delim = ";")

WaterbirdsBT_sigma_zeeschelde %>% 
  write_delim(paste0(pad_data, "Watervogels_Sigma_zeeschelde.csv"),
              delim = ";")


WaterbirdsBT_vallei %>% 
  write_delim(paste0(pad_data, "Watervogels_Vallei.csv"),
              delim = ";")
WaterbirdsBT_vallei_zeeschelde %>% 
  write_delim(paste0(pad_data, "Watervogels_Vallei_zeeschelde.csv"),
              delim = ";")

WaterbirdsBT_sigma_estuarien %>% 
  write_delim(paste0(pad_data, "Watervogels_Sigma_estuarien.csv"),
              delim = ";")

WaterbirdsBT_sigma_wetland %>% 
  write_delim(paste0(pad_data, "Watervogels_Sigma_wetland.csv"),
              delim = ";")

```




