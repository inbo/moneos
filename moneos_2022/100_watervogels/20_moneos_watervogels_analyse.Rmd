---
params:
  hoofdstuk: "100_watervogels"
knit: (function(inputFile, encoding) {
        rmarkdown::render(inputFile,
                          encoding=encoding,
                          output_dir = paste0("../", 
                          rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, 
                          "/output")
                          )})
title: "analyse watervogels"
output:
  bookdown::word_document2
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE, fig.showtext = TRUE, dpi = 300)

```


```{r libraries}

library(tidyverse)
library(lubridate)
# library(readxl)
library(INBOtheme)
library(writexl)
library(rprojroot) ## workaround pad
library(RcppRoll)
```


```{r pad}

# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")

```



```{r data-watervogels inlezen}

data_watervogels <- 
  read_delim(paste0(pad_data, "Watervogels_Zeeschelde.csv"),
              delim = ";")

data_watervogels_sigma <- 
  read_delim(paste0(pad_data, "Watervogels_Sigma.csv"),
              delim = ";")

data_watervogels_vallei <- 
  read_delim(paste0(pad_data, "Watervogels_Vallei.csv"),
              delim = ";")

data_watervogels_Zeeschelde_ZR_Sigma <-
  data_watervogels %>% 
  bind_rows(data_watervogels_sigma)

data_watervogels_Zeeschelde_ZR_Sigma_Vallei <-
  data_watervogels_Zeeschelde_ZR_Sigma %>% 
  bind_rows(data_watervogels_vallei)

## toevoegen nultellingen (reeds in data script toegevoegd)
# data_watervogels <- 
#   data_watervogels %>% 
#   complete(nesting(gebiedsgroep_code, gebiedsgroep, rivier, telseizoen, teldatum),
#            nesting(nednaam, wetnaam, taxongroepcode),
#            fill = list(aantal = 0))

# toevoegen jaar en maand
data_watervogels <- 
  data_watervogels %>% 
  mutate(jaar = teldatum %>% 
           ymd() %>% 
           year(),
         maand = teldatum %>% 
           ymd() %>% 
           month())

data_watervogels_Zeeschelde_ZR_Sigma <- 
  data_watervogels_Zeeschelde_ZR_Sigma %>% 
  mutate(jaar = teldatum %>% 
           ymd() %>% 
           year(),
         maand = teldatum %>% 
           ymd() %>% 
           month())

data_watervogels_Zeeschelde_ZR_Sigma_Vallei <- 
  data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
  mutate(jaar = teldatum %>% 
           ymd() %>% 
           year(),
         maand = teldatum %>% 
           ymd() %>% 
           month())

# vroegste en meest recente telseizoen
vroegste_telseizoen <- 
  data_watervogels %>% 
  pull(telseizoen) %>% 
  unique() %>% 
  sort() %>% 
  first()

laatste_telseizoen <- 
  data_watervogels %>% 
  pull(telseizoen) %>% 
  unique() %>% 
  sort() %>% 
  last()


# vroegste en meest recente jaar
vroegste_jaar <- 
  data_watervogels %>% 
  pull(jaar) %>% 
  unique() %>% 
  sort() %>% 
  first()

laatste_jaar <- 
  data_watervogels %>% 
  pull(jaar) %>% 
  unique() %>% 
  sort() %>% 
  last()

```


```{r data-trofische-groep}

data_trofische_groep <- 
  read_delim(paste0(pad_data, "Voedselgilde_Moneosrapport.csv"), 
             delim = ";")  

data_trofische_groep <- data_trofische_groep %>% 
              rename_all(tolower) %>% 
              rename(nednaam = species,
                     trofische_groep = indicator)

# testen voor dubbels in trofische groep
# data_trofische_groep %>% 
#   group_by(Species, Indicator) %>% 
#   summarise(n = n()) %>% 
#   ungroup() %>% 
#   filter(n > 1)
# 
# data_trofische_groep %>% 
#   group_by(Species) %>% 
#   summarise(n = n()) %>% 
#   ungroup() %>% 
#   filter(n > 1)


# toevoegen trofisch groep aan dataset
data_watervogels <- 
  data_watervogels %>% 
  left_join(data_trofische_groep)

```



##### testen voor dubbels

```{r data-controle}

# testen voor dubbels in tellingen
dubbele_tellingen <-
  data_watervogels  %>% 
  group_by_at(vars(-aantal)) %>% 
  mutate(n = n()) %>% 
  ungroup() %>% 
  filter(n>1) %>% 
  arrange()

```

  - Er zijn `r nrow(dubbele_tellingen)` dubbele tellingen in de dataset 


##### rivieren in de dataset

```{r rivieren}

rivieren <- 
  data_watervogels %>%
  distinct(gebiedsgroep_code, gebiedsgroep, rivier)

knitr::kable(rivieren)

```

##### gebiedsindeling T2021

```{r gebiedsindeling T2021}

data_gebiedsindeling_T2021 <- 
  read_delim(paste0(pad_data, "Gebiedsindeling_T2021.csv"), 
             delim = ";")  

data_gebiedsindeling_T2021 <-
  data_gebiedsindeling_T2021 %>% 
  mutate(rivier = case_when(
    niveau4 == "Rupel" ~ "Rupel",
    niveau4 == "GetijdeDurme" ~ "Durme",
    niveau4 == "GetijdeDijle" ~ "Dijle",
    niveau4 == "GetijdeZenne" ~ "Zenne",
    niveau4 == "Monding" ~ "Noordzee",
    niveau2 == "Westerschelde" ~"Westerschelde",
    TRUE ~ "Zeeschelde"
  ))

data_gebiedsindeling_T2021 <- data_gebiedsindeling_T2021 %>% 
  rename(gebiedsgroep = krw) %>% 
  select("niveau1", "niveau2","niveau3", "gebiedsgroep", "rivier") %>% 
  distinct() %>% 
  filter(gebiedsgroep != "Getijdenetes")

knitr::kable(data_gebiedsindeling_T2021)


#### toevoegen gebiedsindeling EMSE
 data_watervogels <- 
  data_watervogels %>% 
  left_join(data_gebiedsindeling_T2021, na.rm = TRUE) %>% 
   mutate(niveau3 = fct_relevel(niveau3, c("Saliniteitsgradient","Oligohalien","Zoet lang verblijf","Zoet kort verblijf", "Rupel","Durme", "Zoet zijrivier")))
   
data_watervogels %>% 
  distinct(niveau3)



# data_watervogels$niveau3  <- factor(data_watervogels1$niveau3, levels = c("Saliniteitsgradient","Oligohalien","Zoet lang verblijf","Zoet kort verblijf", "Rupel","Durme", "Zoet zijrivier")) %>%   

```

##### oppervlakte beschikbaar habitat

```{r data-oppervlakte-slikken}

data_oppecotoop <- 
  read_delim(paste0(pad_data, "OppEcotoop2001_19.csv"), 
             delim = ";")  

# data_oppecotoopKRWZS <- data_oppecotoop %>%
#   filter(str_detect(Fysiotoop, "slik")) %>%
#   group_by(KRWzone,Jaar, Uitbreiding, Natuurlijkheid, Fysiotoop, Geomorf) %>%
#   summarise(somha = sum(SomVanShape_Area/10000))

data_oppecotoop <-
  data_oppecotoop %>% 
  filter(KRWzone != "Tijarm") %>%
  mutate(rivier = case_when(
    Omes == "Rupel" ~ "Rupel",
    KRWzone == "Getijdedurme" ~ "Durme",
        TRUE ~ "Zeeschelde"
  ))

data_oppecotoop <- data_oppecotoop %>% 
  rename(gebiedsgroep = KRWzone) %>%
  left_join(data_gebiedsindeling_T2021, na.rm = TRUE) %>% 
  mutate(niveau3 = fct_relevel(niveau3, c("Saliniteitsgradient","Oligohalien","Zoet lang verblijf","Zoet kort verblijf", "Rupel","Durme", "Zoet zijrivier")))


data_oppzachtslikKRWZS <- data_oppecotoop %>% 
  filter(str_detect(Fysiotoop, "slik")) %>%
  filter(Uitbreiding == 0) %>% ##uitbreidingen worden niet of niet goed geteld vanop de boot bij laagwater
  filter(str_detect(Ecotoop, "zacht")) %>% 
  group_by(niveau3,Jaar,telseizoen) %>% 
  summarise(somha = sum(SomVanShape_Area/10000)) %>%
  rename(jaar = Jaar) %>% 
  ungroup()

data_oppzachtslikKRWZS %>% 
  write_delim(paste0(pad_data, "data_oppzachtslikKRWZS.csv"),
              delim = ";")
#we koppelen de data aan volledige jaren (jaar x = juni x tot juli x+1) of aan winterjaar of wintertelseizoen (okt jaar x - mrt jaar x+1)

###dataset nog niet goed de jaargangen met Zeeschelde III vr 2012,2014,2015,2017,2018 moeten eruit - slechts gedeeltelijke data 
   # filter(KRWzone != "Zeeschelde III + Rupel" 
   #        if Jaar == 2012,) 
###dataset ook nog beperkt aantal jaren - meerdere jaren zouden geintepoleerd kunnen worden - nog uit te zoeken hoe je dat in R doet

library(zoo)


# df %>%
#   group_by(variable) %>%
#     arrange(variable, event.date) %>%
#       mutate(ip.value = na.approx(value, maxgap = 4, rule = 2))


```


##### soorten in de dataset

```{r soorten}

# soortnamen
soortnamen <- 
  data_watervogels %>%
  distinct(nednaam, wetnaam)

#lijst ZS soorten die minstens 30 keer werden waargenomen - EMSE

overzichtsoorten_analyse <-
  data_watervogels %>% 
  group_by(nednaam) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
  filter(aantal > 30) %>% 
  ungroup()

#ontbreken er soorten waarvan we geen dieet opnamen in data trofische groep?

trofische_groep_aanvullen <-
  left_join(overzichtsoorten_analyse, data_trofische_groep) %>% 
  filter(is.na(trofische_groep))

# trofische_groep_aanvullen %>% 
  # write_delim(paste0(pad_data, "trofischegroepaanvullen.csv"),
              # delim = ";")

geen_trofische_groep <- 
  data_watervogels %>%
  filter(is.na(trofische_groep)) %>%
  pull(nednaam) %>%
  unique() %>% 
  sort()

tabel_trofische_groep <- 
  data_watervogels %>%
  filter(!is.na(trofische_groep)) %>%
  distinct(trofische_groep, nednaam) %>% 
  group_by(trofische_groep) %>% 
  summarise(aantal_soorten = n()) %>% 
  ungroup()


```

  - Er zijn `r nrow(soortnamen)` soorten in de dataset
  - `r length(geen_trofische_groep)` soorten hebben geen indicatie van trofische groep
    + `r geen_trofische_groep`
  - de overige soorten behoren tot volgende trofische groepen
    + `r knitr::kable(tabel_trofische_groep)`
    
#### shannon diversity

```{r Shannon index}

  
 
data_watervogels %>% 
    mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
    filter(telseizoen1 %in% c(2001:2021)) %>%  
    # filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% # geen meeuwen of sternen  # geen meeuwen of sternen
    filter(maand %in% c(10:12, 1:3)) %>%
    filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>% 
    # filter(gebiedsgroep != "Getijdedijle en Getijdezenne") %>% #EMSE rapporteert niet over Dijle en Zenne
    group_by(telseizoen1, niveau3) %>% 
    mutate(totaal = sum(aantal, na.rm = TRUE)) %>%
    ungroup() %>% 
    group_by(telseizoen1, niveau3, nednaam,totaal) %>% 
    summarise(aantalsp = sum(aantal, na.rm = TRUE)) %>% 
    filter(aantalsp > 0) %>% 
   mutate(pi = aantalsp/totaal) %>% 
   mutate(lnpi = log(pi)) %>% 
   mutate(pilnpi = pi * lnpi) %>% 
   ungroup() %>% 
   group_by(telseizoen1, niveau3) %>% 
   summarise(H_shannon = sum(pilnpi *-1, na.rm = TRUE)) %>% 
  ungroup() %>%
      ggplot(aes(ordered(telseizoen1), H_shannon, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line(size = 1) + 
    labs(x = "telseizoen", 
       y = "Shannon diversiteit H") +
    theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())+
  scale_y_continuous()

# ggsave(paste0(pad_figuren, "100_figuur_ShannonDiversity_wintervogels.jpg"))
ggsave(paste0(pad_figuren, "100_figuur_ShannonDiversity_wintervogels_metmeeuwen.jpg"))

levels(data_watervogels$niveau3)    
 
```



##### figuur maandelijkse totalen wintervogels Zeeschelde

```{r 100-figuur-maandelijkse-totalen-winter-Zeeschelde, fig.height=5, fig.width=8}

# data_watervogels %>% 
#   filter(str_detect(gebiedsgroep_code, "ZS")) %>% ##♦dit rekent inclusief rupel
#   mutate(datum = paste(jaar, maand, "15", sep = "-") %>% 
#            ymd()) %>% 
#   group_by(telseizoen, datum) %>% 
#   summarise(aantal = sum(aantal)) %>% 
#   ungroup() %>% 
#   ggplot(aes(datum, aantal)) + 
#   geom_col() +
#   scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
#   labs(x = "datum", y = "aantal") +
#   theme(axis.text.x = element_text(angle = 35))
# probleem met deze figuur is dat sinds het stopzetten van de zomertellingen stroomop Antwerpen de zomercijfers niet meer in 1 figuur kunnen gezien worden - dit kan enkel nog in ZS4 waar jaarrond telling is.

data_watervogels %>% 
  filter(rivier == "Zeeschelde") %>% 
  mutate(datum = paste(jaar, maand, "15", sep = "-") %>% 
           ymd()) %>% 
  filter(maand %in% c(10:12, 1:3)) %>%
    # filter(teldatum > "2020-06-01") %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
  group_by(telseizoen, datum) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(datum, aantal)) + 
  geom_col() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(x = "jaar", y = "aantal") +
  theme(axis.text.x = element_text(angle = 90))+
  geom_smooth(aes(color = "trendlijn"))

ggsave(paste0(pad_figuren, "100_figuur_maandelijkse_totalen_ZSwinter.jpg"))


```

##### figuur maandelijkse totalen vogels Zeeschelde IV - Saliniteitsgradiënt
```{r 100-figuur-maandelijkse-totalen-ZeescheldeIV, fig.height=5, fig.width=8}
data_watervogels %>% 
  filter(gebiedsgroep_code == "ZS4") %>% 
  mutate(datum = paste(jaar, maand, "15", sep = "-") %>% 
           ymd()) %>% 
  # filter(maand %in% c(10:12, 1:3)) %>%
  filter(teldatum < "2022-04-01") %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
  group_by(telseizoen,datum) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(datum, aantal)) + 
  geom_col() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(x = "jaar", y = "aantal", title = "Maandelijkse totalen saliniteitsgradiënt") +
  theme(axis.text.x = element_text(angle = 90))+
  geom_smooth(aes(), color = "red")

ggsave(paste0(pad_figuren, "100_figuur_maandelijkse_totalen_ZSIV.jpg"))

data_watervogels %>% 
  filter(gebiedsgroep_code == "ZS4") %>% 
  filter(nednaam == "Scholekster") %>% 
  mutate(datum = paste(jaar, maand, "15", sep = "-") %>% 
           ymd()) %>% 
  filter(maand %in% c(10:12, 1:3)) %>%
  # filter(maand %in% c(4:9)) %>%
  filter(teldatum > "1991-10-01" & teldatum < "2022-04-01") %>% 
  # filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
  group_by(telseizoen,datum) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(datum, aantal)) + 
  geom_col() +
  scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
  labs(title = "scholekster",x = "jaar", y = "aantal") +
  theme(axis.text.x = element_text(angle = 90))+
  geom_smooth(aes(), color = "red")

ggsave(paste0(pad_figuren, "100_figuur_maandelijkse_totalen_saliniteitsgradient_scholekster.jpg"))
```

```{r 100-figuur-maandelijkse-wintertotalen-KRWzones}
data_watervogels %>% 
   # filter(gebiedsgroep_code == "ZS4") %>% 
  mutate(datum = paste(jaar, maand, "15", sep = "-") %>% 
           ymd()) %>% 
  filter(maand %in% c(10:12, 1:3)) %>%
  filter(teldatum > "2005-10-01" & teldatum < "2022-04-01") %>% #
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
   filter(nednaam =="Wintertaling") %>% 
  group_by(telseizoen,datum,gebiedsgroep_code, niveau3) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(datum, aantal)) + 
  geom_col() +
  scale_x_date(date_breaks = "1 month", date_labels = "%m%Y") +
  labs(x = "jaar", y = "aantal") +
  theme(axis.text.x = element_text(angle = 90))+
  geom_smooth(aes(color = "trendlijn")) +
  facet_wrap(~niveau3, ncol = 2, scales = "free")



```

##### figuur verhouding aantallen

```{r 100-figuur-verhouding-aantallen, fig.height=5, fig.width=8}

# figuur met gemiddelde over tellingen per seizoen en gebiedsgroep 
data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
  mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
  # filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>% #Het telgebied oude durme en durme was vroeger samengeteld - dat is een probleem voor de estuariene evaluatie vn de watervogels
  filter(rivier =="Zeeschelde") %>% 
  group_by(telseizoen, niveau3, rivier) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal, fill = niveau3)) + 
  geom_col(position = "fill") +
  scale_y_continuous(breaks = seq(0,1,0.1), labels = paste0(seq(0,100,10),"%")) +
  scale_fill_manual(values = inbo_palette()) +
  labs(x = "telseizoen", 
       y = "") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "100_figuur_verhouding_aantallen_niveau3Zeeschelde.jpg"))

# dit is de oorspronkelijke figuur met de som over alle tellingen 
# data_watervogels %>%
#   filter(maand %in% c(10:12, 1:3)) %>%
#   group_by(telseizoen, gebiedsgroep) %>%
#   summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
#   ungroup() %>%
#   ggplot(aes(ordered(telseizoen), aantal, fill = gebiedsgroep)) +
#   geom_col(position = "fill") +
#   scale_y_continuous(breaks = seq(0,1,0.1), labels = paste0(seq(0,100,10),"%")) +
#   scale_fill_manual(values = inbo.2015.colours()) +
#   labs(x = "telseizoen", y = "") +
#   theme(axis.text.x = element_text(angle = 35),
#         legend.position = "bottom",
#         legend.title = element_blank())

```


##### figuur wintermaxima Zeeschelde

```{r 100-figuur-wintermaxima-Zeeschelde, fig.height=6, fig.width=8}


# figuur met max over tellingen per seizoen en gebiedsgroep 

data_watervogels %>% 
  filter(rivier == "Zeeschelde") %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(telseizoen, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
   ungroup() %>%
   group_by(telseizoen) %>% 
  summarise(maximum = max(som, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), maximum)) + 
  geom_col() +
    labs(x = "telseizoen", 
       y = "wintermaximum per telseizoen") +
    theme(axis.text.x = element_text(angle = 90))

ggsave(paste0(pad_figuren, "100_figuur_wintermaxima_Zeeschelde.jpg"))

wintermaximumZS <- data_watervogels %>% 
  filter(rivier == "Zeeschelde") %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(telseizoen, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen) %>% 
  summarise(maximum = max(som, na.rm = TRUE)) 

knitr::kable(wintermaximumZS)

# tabel met maximum per jaar en in welke maand dit viel
# tabel waarin geteld wordt in welke maand het maximum valt per seizoen /// lukt me niet direct om de code goed te krijgen
# wintermaximummaandZS <- data_watervogels %>% 
#   filter(rivier == "Zeeschelde") %>% 
#   filter(maand %in% c(10:12, 1:3)) %>% 
#   filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
#     group_by(telseizoen, maand) %>% 
#   summarise(som = sum(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   group_by(maand, som) %>% 
#   summarise(maandmax = count(som, na.rm = TRUE)) 
# 
# knitr::kable(wintermaximummaandZS)
```

##### figuur wintermaxima KRW

```{r 100-figuur-wintermaxima-KRWzones, fig.height=6, fig.width=8}


# figuur met max over tellingen per seizoen en gebiedsgroep 

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
  mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
  # filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>% #Het telgebied oude durme en durme was vroeger samengeteld - dat is een probleem voor de estuariene evaluatie vn de watervogels
    group_by(telseizoen, niveau3, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, niveau3) %>% 
  summarise(maximum = max(som, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), maximum)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "wintermaximum per telseizoen") +
  facet_wrap(~niveau3,
             ncol = 2, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))

ggsave(paste0(pad_figuren, "100_figuur_wintermaxima_nivaue3.jpg"))


```

##### figuur wintermaxima zijrivieren

```{r 100-figuur-wintermaxima-zijrivieren, fig.height=6, fig.width=8}

# figuur met max over tellingen per seizoen en gebiedsgroep 

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
  filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>%
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(telseizoen, rivier, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, rivier) %>% 
  summarise(maximum = max(som, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), maximum)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "wintermaximum per telseizoen") +
  facet_wrap(~rivier,
             ncol = 2, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))

ggsave(paste0(pad_figuren, "100_figuur_wintermaxima_rivier.jpg"))
```

#### Natuurindicator berekening IHD-Z

```{r wintermaximum-Natuurindicatorberekening, fig.height=6, fig.width=8}

# IHD-Z: gemiddelde van de seizoensmaxima (excl. meeuwen) over de laatse 5 seizoenen mag niet minder zijn dan 40 000. Dit criterium is afgeleid van de aantallen op de Zeeschelde maar de doelen moeten gehaald worden binnen werkingsgebied IHD-Z
# er is ook een criterium voor het seizoensminimum voor de Zeeschelde (3500) maar door het terugschroeven van de monitoring kan dit niet meer berekend worden (en in de sigma en vallei gebieden is er geen systematische jaarrond watervogeltelling als je dit zou willen evalueren op het volledige IHD-Z gebied)

SeizMax <- function(data, type){
  data %>% 
    mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
    filter(telseizoen1 %in% c(1991:2021)) %>%  
    filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% # geen meeuwen of sternen  # geen meeuwen of sternen
    filter(maand %in% c(10:12, 1:3)) %>%
    group_by(telseizoen1, maand) %>% 
    summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
    group_by(telseizoen1) %>% 
    summarise(Wmax = max(aantal, na.rm = TRUE)) %>% 
    mutate(type = type)
}

Wmax_Zsch <- data_watervogels %>% 
  filter(rivier == "Zeeschelde") %>% 
  SeizMax("Zeeschelde")
Wmax_ZschZR <- SeizMax(data_watervogels, "Zeeschelde + zijrivieren")
Wmax_ZschZRSigma <- SeizMax(data_watervogels_Zeeschelde_ZR_Sigma, "Zeeschelde + zijrivieren + Sigmagebieden")
Wmax_ZschZRSigmaVallei <- SeizMax(data_watervogels_Zeeschelde_ZR_Sigma_Vallei, "Zeeschelde + zijrivieren + Sigmagebieden + Vallei")

# Doelstelling "Zeeschelde IHD-Z" bepaald op basis van winterseizoensgemiddelde tussen 1995-2005 aantal vogels 
Wmax_Zsch %>% 
  filter(telseizoen1%in% c(1995:2005)) %>% 
  summarise(doel = mean(Wmax, na.rm = TRUE))
#gemiddelde max winterseizoen 1995-2005 Zeeschelde is 43282 - het doel is destijds afgerond naar onder en nu verondersteld als te behalen doelstelling binnen Zeeschelde + zijrivieren + Sigmagebieden (wetland + ontpoldering) (maar niet binnen de vallei IHD-Z contour)

Wmax_ZschZR %>% 
  filter(telseizoen1%in% c(1995:2005)) %>% 
  summarise(doel = mean(Wmax, na.rm = TRUE))

Wmax_ZschZRSigmaVallei %>% 
  filter(telseizoen1%in% c(1995:2005)) %>% 
  summarise(doel = mean(Wmax, na.rm = TRUE))


```

```{r bereken glijdendgemiddel met CI, include=FALSE}
# Bereken glijdend gemiddelde met CI
# data = tibble, x = column for x-data, value = column with data for rolling mean, n = width of average(window size)
mav_wm <- function(data, x, value, n){
  rol <- data %>%
    mutate(x = x,
           v = value,
           m = roll_mean(value,n=n, fill = NA),
           sd = roll_sd(value,n=n, fill = NA),
           ci_min = m + 1.96*sd/sqrt(n),
           ci_max = m - 1.96*sd/sqrt(n))
}
mav_ZscZR <- Wmax_ZschZR %>% mav_wm(.$telseizoen1, .$Wmax, 5)
mav_ZscZRSigma <- Wmax_ZschZRSigma %>% mav_wm(.$telseizoen1, .$Wmax, 5)
mav_ZscZRSigmaVallei <- Wmax_ZschZRSigmaVallei %>% mav_wm(.$telseizoen1, .$Wmax, 5)

mav_ZscZR %>% 
  write_delim(paste0(pad_data, "mav_ZscZR.csv"),
              delim = ";")

mav_ZscZRSigma %>% 
  write_delim(paste0(pad_data, "mav_ZscZRSigma.csv"),
              delim = ";")

mav_ZscZRSigmaVallei %>% 
  write_delim(paste0(pad_data, "mav_ZscZRSigmaVallei.csv"),
              delim = ";")


```

```{r plotfunctie natuurindicator, include=FALSE}
# Plot glijdend gemiddelde

# plot_mav <- function(data){
#   if(n_distinct(data$type)<2){
#     data %>% ggplot(aes(x=x)) + 
#       geom_errorbar(aes(ymin=ci_min, ymax=ci_max), width=.2) +
#       geom_point(aes(y=m), size = 2.5, color="blue") +
#       geom_line(aes(y=m), color="blue") +
#       geom_hline(yintercept = 40000, linetype = 2, size = 1.4) +
#       labs(y = "Wintermaximum") +
#       scale_x_continuous(breaks = seq(1990, 2020, by = 5)) + 
#       scale_y_continuous(breaks = seq(0, 85000, by = 20000),
#                          limits = c(0, 85000)) +
#       theme(axis.title.x = element_blank()) }
#   else{
#     data %>% ggplot(aes(x=x)) + 
#       geom_errorbar(aes(ymin=ci_min, ymax=ci_max, color = type), width=.2,
#                     position=position_dodge(0.1)) +
#       geom_point(aes(y=m, color = type), size = 2.5) +
#       geom_line(aes(y=m, color = type)) +
#       geom_hline(yintercept = 40000, linetype = 2, size = 1.4) +
#       labs(y = "Wintermaximum") +
#       scale_x_continuous(breaks = seq(1990, 2020, by = 5)) + 
#       scale_y_continuous(breaks = seq(0, 85000, by = 20000),
#                          limits = c(0, 85000)) +
#       theme(axis.title.x = element_blank()) +
#       scale_color_manual(values=c("blue", "red"))+
#       theme(legend.title=element_blank(),
#             legend.position="top") }
# }

plot_mav <- function(data){
  if(n_distinct(data$type)<2){
    data %>% ggplot(aes(x=x)) + 
      geom_errorbar(aes(ymin=ci_min, ymax=ci_max), width=.2) +
      geom_point(aes(y=m), size = 2.5, color="blue") +
      geom_line(aes(y=m), color="blue") +
      geom_hline(yintercept = 40000, linetype = 2, size = 1.4) +
      labs(y = "Wintermaximum") +
      scale_x_continuous(breaks = seq(1990, 2021, by = 5)) + 
      scale_y_continuous(breaks = seq(0, 85000, by = 20000),
                         limits = c(0, 85000)) +
      theme(axis.title.x = element_blank()) 
  }else if(n_distinct(data$type)>1 & n_distinct(data$type)<3){
    data %>% ggplot(aes(x=x)) + 
      geom_errorbar(aes(ymin=ci_min, ymax=ci_max, color = type), width=.2,
                    position=position_dodge(0.1)) +
      geom_point(aes(y=m, color = type), size = 2.5) +
      geom_line(aes(y=m, color = type)) +
      geom_hline(yintercept = 40000, linetype = 2, size = 1.4) +
      labs(y = "Wintermaximum") +
      scale_x_continuous(breaks = seq(1990, 2021, by = 5)) + 
      scale_y_continuous(breaks = seq(0, 85000, by = 20000),
                         limits = c(0, 85000)) +
      theme(axis.title.x = element_blank()) +
      scale_color_manual(values=c("blue", "red"))+
      theme(legend.title=element_blank(),
            legend.position="top") 
    }else{
    data %>% ggplot(aes(x=x)) + 
      geom_errorbar(aes(ymin=ci_min, ymax=ci_max, color = type), width=.2,
                    position=position_dodge(0.1)) +
      geom_point(aes(y=m, color = type), size = 2.5) +
      geom_line(aes(y=m, color = type)) +
      geom_hline(yintercept = 40000, linetype = 2, size = 1.4) +
      labs(y = "Wintermaximum") +
      scale_x_continuous(breaks = seq(1990, 2021, by = 5)) + 
      scale_y_continuous(breaks = seq(0, 105000, by = 20000),
                         limits = c(0, 105000)) +
      theme(axis.title.x = element_blank()) +
      scale_color_manual(values=c("blue", "red","green"))+
      theme(legend.title=element_blank(),
            legend.position="top")
      }
        }
```

```{r 100-figuur-wintermaximum-Natuurindicatorberekening, fig.height=6, fig.width=8"}

# , fig.cap="Vijfjarig glijdend gemiddelde van het wintermaximum van het totaal aantal watervogels in de getijderivieren van het Zeeschelde-estuarium."

mav_ZscZR %>% plot_mav()

ggsave(paste0(pad_figuren, "100_figuur_Natuurindicator_glijdendgemiddelde_ZSZR.jpg"))

mav_ZscZR %>% bind_rows(mav_ZscZRSigma) %>% 
  plot_mav()

ggsave(paste0(pad_figuren, "100_figuur_Natuurindicator_glijdendgemiddelde_ZSZR_Sigma.jpg"))

mav_ZscZR %>% bind_rows(mav_ZscZRSigma) %>% bind_rows(mav_ZscZRSigmaVallei) %>% 
  plot_mav()

ggsave(paste0(pad_figuren, "100_figuur_Natuurindicator_glijdendgemiddelde_ZSZR_Sigma_Vallei.jpg"))


```

### IHD overwinterende watervogels - soortdoelstellingen S-IHD besluit



```{r berekening s-IHD soortdoelstellingen}

# populatiedoelstellingen te bepalen obv dataset IHD-Z werkingsgebied: Zeeschelde + zijrivieren + Sigmagebieden + vallei
# pijlstaart : winter seizoensgemiddelde telseizoen 2000/01 tot 2005/06
# wintertaling : winter seizoensgemiddelde telseizoen 1998/99 tot 2005/06
# krakeend: winter seizoensgemiddelde telseizoen 2002/03 tot 2006/07
# tafeleend: winter seizoensgemiddelde telseizoen 2001/02 tot 2006/07
# bergeend: winter seizoensgemiddelde telseizoen 1992/93 tot 2006/07
# slobeend: winter seizoensgemiddelde telseizoen 2001/02 tot 2006/07
# kleine zwaan : winter seizoensgemiddelde telseizoen 2001/02 tot 2006/07 (niet gespecifieerd in S-IHD rapport maar hier verondersteld)
# kokmeeuw : winter seizoensgemiddelde telseizoen 2001/02 tot 2006/07 (niet gespecifieerd in S-IHD rapport maar hier verondersteld)

##### doelstellingen op basis van Zeeschelde + zijrivieren

doelpijlstaart <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Pijlstaart") %>% 
     filter(telseizoen1 %in% c(2000:2005)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelwintertaling <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Wintertaling") %>% 
     filter(telseizoen1 %in% c(1998:2005)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelkrakeend <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Krakeend") %>% 
     filter(telseizoen1 %in% c(2002:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doeltafeleend <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Tafeleend") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelbergeend <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Bergeend") %>% 
     filter(telseizoen1 %in% c(1992:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelslobeend <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Slobeend") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelkleinezwaan <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Kleine Zwaan") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelkokmeeuw <- data_watervogels %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Kokmeeuw") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()


##### doelstellingen op basis van Zeeschelde + zijrivieren + Sigmagebieden + vallei

doelpijlstaart_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Pijlstaart") %>% 
     filter(telseizoen1 %in% c(2000:2005)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelwintertaling_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Wintertaling") %>% 
     filter(telseizoen1 %in% c(1998:2005)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelkrakeend_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Krakeend") %>% 
     filter(telseizoen1 %in% c(2002:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doeltafeleend_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Tafeleend") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelbergeend_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Bergeend") %>% 
     filter(telseizoen1 %in% c(1992:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelslobeend_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Slobeend") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelkleinezwaan_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Kleine Zwaan") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

doelkokmeeuw_IHDZzone <- data_watervogels_Zeeschelde_ZR_Sigma_Vallei %>% 
     mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
     filter(nednaam == "Kokmeeuw") %>% 
     filter(telseizoen1 %in% c(2001:2006)) %>%  
     filter(maand %in% c(10:12, 1:3)) %>% 
  group_by(telseizoen1,maand) %>% 
  summarise(somaantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen1) %>% 
  summarise(gemidtelseizoen1 = mean(somaantal)) %>% 
  ungroup() %>% 
  summarise(doel = mean(gemidtelseizoen1)) %>% 
  round(digits = 0) %>% 
  pull()

#   
# doelpijlstaart <- pijlstaart %>% 
#   group_by(telseizoen) %>% 
#   summarise(jaartot = sum(aantal, na.rm = TRUE))
#   
# 
# 
# mav_ZscZR <- Wmax_ZschZR %>% mav_wm(.$telseizoen1, .$Wmax, 5)
# mav_ZscZRSigma <- Wmax_ZschZRSigma %>% mav_wm(.$telseizoen1, .$Wmax, 5)
# mav_ZscZRSigmaVallei <- Wmax_ZschZRSigmaVallei %>% mav_wm(.$telseizoen1, .$Wmax, 5)

```


##### figuur wintergemiddelde aantallen per KRWzone

```{r 100-figuur-aantallen-niveau3, fig.height=6, fig.width=8}


# figuur met gemiddelde over tellingen per seizoen en gebiedsgroep 
data_watervogels %>%
  filter(maand %in% c(10:12, 1:3)) %>%
  mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
  filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>%
  filter(telseizoen1 > 2008) %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
  group_by(telseizoen, niveau3, rivier) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(telseizoen, niveau3) %>%
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(ordered(telseizoen), aantal)) +
  geom_col() + 
  labs(x = "telseizoen",
       y = "aantal wintergemiddelde") +
  facet_wrap(~niveau3,
             ncol = 2, scales = "free") +
  theme(axis.text.x = element_text(angle = 90)) 
  

#ggsave(paste0(pad_figuren, "100_figuur_wintergemiddelde_niveau3.jpg"))

#variant1
data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
  filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>%
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(telseizoen, niveau3, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, niveau3) %>% 
  summarise(aantal = mean(som, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), aantal)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "wintergemiddeld aantal watervogels") +
  facet_wrap(~niveau3,
             ncol = 2, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))
 
  

ggsave(paste0(pad_figuren, "100_figuur_meanwinter_niveau3.jpg"))

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(telseizoen, gebiedsgroep, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, gebiedsgroep) %>% 
  summarise(aantal = mean(som, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), aantal)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "wintergemiddeld aantal watervogels") +
  facet_wrap(~gebiedsgroep,
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90))

#variant2 inzoemen vanaf telseizoen 2009
data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>%
  mutate(telseizoen1 = as.numeric(str_sub(telseizoen, 1, 4))) %>% 
  filter(gebiedsgroep != "Getijdedurme" | telseizoen1 > 2012) %>%
filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    filter(teldatum > "2009-06-01") %>% 
    group_by(telseizoen, gebiedsgroep, maand) %>% 
  summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, gebiedsgroep) %>% 
  summarise(aantal = mean(som, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), aantal)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "wintergemiddeld aantal watervogels") +
  facet_wrap(~gebiedsgroep,
             ncol = 2, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))


# dit is de oorspronkelijke figuur met de som over alle tellingen 
# data_watervogels %>% 
#   filter(maand %in% c(10:12, 1:3)) %>% 
#   group_by(telseizoen, gebiedsgroep) %>% 
#   summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   ggplot(aes(ordered(telseizoen), aantal)) + 
#   geom_col() +
#   labs(x = "telseizoen", 
#        y = "aantal") +
#   facet_wrap(~gebiedsgroep, scales = "free_y") +
#   theme(axis.text.x = element_text(angle = 90))

```


##### figuur wintergemiddelde aantallen per zijrivier

```{r 100-figuur-aantallen-zijrivieren, fig.height=4, fig.width=12}

# figuur met gemiddelde over tellingen per seizoen en zijrivier 
data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3),
         rivier %in% c("Dijle", "Rupel", "Zenne")) %>% 
filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(rivier,telseizoen, maand) %>% 
   summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, rivier) %>% 
  summarise(aantal = mean(som, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "gemiddeld per maand aantal watervogels per winterseizoen") +
  facet_wrap(~rivier) +
  theme(axis.text.x = element_text(angle = 90))

ggsave(paste0(pad_figuren, "100_figuur_aantallen_zijrivieren.jpg"))

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3),
         rivier %in% c("Dijle", "Rupel", "Zenne")) %>% 
filter(taxongroepcode != "S" & taxongroepcode != "MS") %>% #meeuwen en sternen niet meetellen worden pas sinds 1999 geteld
    group_by(rivier,telseizoen, maand) %>% 
   summarise(som = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>%
  group_by(telseizoen, rivier) %>% 
  summarise(aantal = mean(som, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal)) + 
  geom_col() +
  labs(x = "telseizoen", 
       y = "gemiddeld per maand aantal watervogels per winterseizoen") +
  facet_wrap(~rivier, scales = "free") +
  theme(axis.text.x = element_text(angle = 90))

# dit is de oorspronkelijke figuur met de som over alle tellingen 
# data_watervogels %>% 
#   filter(maand %in% c(10:12, 1:3),
#          rivier %in% c("Dijle", "Rupel", "Zenne")) %>% 
#   group_by(telseizoen, rivier) %>% 
#   summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   ggplot(aes(ordered(telseizoen), aantal)) + 
#   geom_col() +
#   labs(x = "telseizoen", 
#        y = "aantal") +
#   facet_wrap(~rivier, scales = "free_y") +
#   theme(axis.text.x = element_text(angle = 90))

```


##### figuur wintergemiddelde aantallen per trofische groep

```{r 100-figuur-aantallen-trofische-groep, fig.height=5, fig.width=7}

# figuur met gemiddelde over tellingen per seizoen, gebiedsgroep en trofische groep
# data_watervogels %>% 
#   filter(maand %in% c(10:12, 1:3)) %>% 
#   filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
#   filter(jaar >= 2009,
#          telseizoen != "2008/09") %>% 
#   filter(!is.na(trofische_groep)) %>% 
#   group_by(telseizoen, teldatum, trofische_groep, gebiedsgroep, rivier) %>% 
#   summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   group_by(telseizoen, trofische_groep, gebiedsgroep, rivier) %>% 
#   summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   group_by(telseizoen, gebiedsgroep, trofische_groep) %>% 
#   summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
#   geom_point(aes(shape = gebiedsgroep)) +
#   geom_line() +
#   labs(x = "telseizoen", 
#        y = "aantal") +
#   facet_wrap(~trofische_groep,
#              scales = "free_y") +
#   theme(axis.text.x = element_text(angle = 90),
#         legend.position = "bottom",
#         legend.title = element_blank())

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  # filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(jaar >= 2009,
         telseizoen != "2008/09") %>% 
  filter(!is.na(trofische_groep)) %>% 
  group_by(telseizoen, maand, trofische_groep, niveau3) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, trofische_groep, niveau3) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "wintergemiddelde") +
  facet_wrap(~trofische_groep,
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "100_figuur_aantallen_trofische_groep_niveau3.jpg"))

##welke soorten -- achtergrond bespreking
data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(jaar >= 2012,
         telseizoen != "2011/12") %>% 
  filter(!is.na(trofische_groep)) %>%
  filter(trofische_groep=="Nbenth") %>% 
  group_by(telseizoen, maand, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
  geom_point(aes(shape = gebiedsgroep)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "aantal") +
  facet_wrap(~nednaam) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(jaar >= 2012,
         telseizoen != "2011/12") %>% 
  filter(!is.na(trofische_groep)) %>%
  filter(trofische_groep=="Nherb") %>% 
  group_by(telseizoen, maand, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
  geom_point(aes(shape = gebiedsgroep)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "aantal") +
  facet_wrap(~nednaam) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(telseizoen > "2011/12") %>% 
  filter(!is.na(trofische_groep)) %>%
  filter(trofische_groep=="Nomn") %>% 
  filter(nednaam %in% c("Kokmeeuw")) %>% 
  group_by(telseizoen, maand, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
  geom_point(aes(shape = gebiedsgroep)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "aantal") +
  facet_wrap(~nednaam) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(jaar >= 2012,
         telseizoen != "2011/12") %>% 
  filter(!is.na(trofische_groep)) %>%
  filter(trofische_groep=="Npisc") %>% 
  group_by(telseizoen, maand, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, trofische_groep, gebiedsgroep, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
  geom_point(aes(shape = gebiedsgroep)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "aantal") +
  facet_wrap(~nednaam) +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())
```

##### figuur abundante soorten met > 5% per KRWzone voor en na 2009

```{r 100-figuur-abundante-soorten, fig.height=5, fig.width=7}

abundante_wintervogels <- data_watervogels %>% 
    # filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
     group_by(niveau3, nednaam) %>% 
  mutate(totaal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(niveau3) %>% 
  mutate(totaalgebiedsgroep = sum(aantal, na.rm = TRUE)) %>% 
  mutate(perc = (totaal/totaalgebiedsgroep)*100) %>% 
  filter(perc > 5) %>% 
  ungroup() %>% 
  select(nednaam) %>%
  distinct(nednaam) %>% 
  arrange(nednaam)
  

# #Create a custom color scale for species: 10 colors needed and order of color must be the same for each species
# library(RColorBrewer)
# myColors <- brewer.pal(10,"Set3")
# names(myColors) <- levels(abundante_wintervogels$nednaam)
# colScale <- scale_colour_manual(name = "nednaam",values = myColors)
# # lukt me niet om dit te doen werken


data_watervogels %>% 
    # filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(telseizoen >= "2009/10") %>% 
   group_by(niveau3, nednaam) %>% 
  mutate(totaal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(niveau3) %>% 
  mutate(totaalgebiedsgroep = sum(aantal, na.rm = TRUE)) %>% 
  mutate(perc = (totaal/totaalgebiedsgroep)*100) %>% 
  filter(perc > 5) %>%
  ggplot(aes(ordered(niveau3), aantal, fill = nednaam)) + 
  geom_col(position = "fill") +
  scale_y_continuous(breaks = seq(0,1,0.1), labels = paste0(seq(0,100,10),"%")) +
   scale_fill_manual(values=c("#CC0000", "#006600", "#669999", "#00CCCC",
                              "#660099", "#CC0066", "#FF9999", "#FF9900",
                              "black", "red", "green", "blue", "yellow")) +
  labs(x = "Niveau3 zones", 
       y = "") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank()) 
  


ggsave(paste0(pad_figuren, "100_figuur_abundante_soortenna2009.jpg"))



data_watervogels %>% 
    # filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(jaar <= 2009,
         telseizoen != "2009/10") %>% 
   group_by(niveau3, nednaam) %>% 
  mutate(totaal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(niveau3) %>% 
  mutate(totaalgebiedsgroep = sum(aantal, na.rm = TRUE)) %>% 
  mutate(perc = (totaal/totaalgebiedsgroep)*100) %>% 
  filter(perc > 5) %>%
  ggplot(aes(ordered(niveau3), aantal, fill = nednaam)) + 
  geom_col(position = "fill") +
  scale_y_continuous(breaks = seq(0,1,0.1), labels = paste0(seq(0,100,10),"%"))+
  scale_fill_manual(values=c("#CC0000", "#006600", "#669999", "#00CCCC",
                             "#660099", "#CC0066", "#FF9999", "#FF9900",
                             "black", "red", "green", "blue", "yellow")) +
  labs(x = "Niveau3 zones", 
       y = "") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())


ggsave(paste0(pad_figuren, "100_figuur_abundante_soortenvoor2009.jpg"))


```

##### figuur wintergemiddelde aantallen voor abundante soorten Zeeschelde

```{r 100-figuur-aantallen-abundante-soorten, fig.height=5, fig.width=7}

# data_watervogels %>% 
#   filter(nednaam %in% c("Bergeend", "Krakeend", "Wilde Eend", "Wintertaling")) %>% 
#   filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
#   filter(maand %in% c(10:12, 1:3)) %>% 
#   filter(jaar >= 2009,
#          telseizoen != "2008/09") %>% 
#   group_by(telseizoen, gebiedsgroep, nednaam, rivier) %>% 
#   summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   group_by(telseizoen, gebiedsgroep, nednaam) %>% 
#   summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
#   geom_point(aes(shape = gebiedsgroep)) +
#   geom_line() +
#   labs(x = "telseizoen", 
#        y = "aantal") +
#   facet_wrap(~nednaam, 
#              scales = "free_y") +
#   theme(axis.text.x = element_text(angle = 90),
#         legend.position = "bottom",
#         legend.title = element_blank())

data_watervogels %>% 
  filter(nednaam %in% c("Bergeend", "Krakeend", "Wilde Eend", "Wintertaling")) %>% 
  # filter(rivier == "Zeeschelde") %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(jaar >= 2009,
         telseizoen != "2008/09") %>% 
  group_by(telseizoen, niveau3, nednaam, maand) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "gemiddeld aantal") +
  facet_wrap(~nednaam, 
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())


ggsave(paste0(pad_figuren, "100_figuur_aantallen_abundante_soorten_niveau3.jpg"))

```


##### figuur wintergemiddelde aantallen voor viseters en steltlopers

```{r 100-figuur-aantallen-visetend-en-steltlopers, fig.height=5, fig.width=7}

data_watervogels %>%
  filter(nednaam %in% c("Aalscholver", "Fuut", "Blauwe Reiger")) %>%
  # filter(str_detect(gebiedsgroep_code, "ZS")) %>%
  filter(maand %in% c(10:12, 1:3)) %>%
  filter(jaar >= 2009,
         telseizoen != "2008/09") %>%
  group_by(telseizoen, niveau3, nednaam, rivier) %>%
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(telseizoen, niveau3, nednaam) %>%
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(ordered(telseizoen), aantal, group = niveau3, color = niveau3)) +
  geom_point(aes(shape = niveau3)) +
  geom_line() +
  labs(x = "telseizoen",
       y = "gemiddeld aantal") +
  facet_wrap(~nednaam,
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "100_figuur_aantallen_viseters_niveau3.jpg"))

data_watervogels %>%
  filter(nednaam %in% c("Aalscholver", "Fuut", "Visdief", "Blauwe Reiger")) %>%
  filter(str_detect(gebiedsgroep_code, "ZS")) %>%
  filter(maand %in% c(4:9)) %>%
  filter(jaar >= 2009,
         telseizoen != "2008/09") %>%
  group_by(telseizoen, gebiedsgroep, nednaam, rivier) %>%
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(telseizoen, gebiedsgroep, nednaam) %>%
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) +
  geom_point(aes(shape = gebiedsgroep)) +
  geom_line() +
  labs(x = "telseizoen",
       y = "gemiddeld aantal zomer") +
  facet_wrap(~nednaam,
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "100_figuur_gemid_aantallenzomer_viseters.jpg"))

data_watervogels %>%
  filter(nednaam %in% c("Aalscholver", "Fuut", "Visdief", "Blauwe Reiger")) %>%
  # filter(str_detect(gebiedsgroep_code, "ZS")) %>%
  filter(maand %in% c(4:9)) %>%
  filter(jaar >= 2009,
         telseizoen != "2008/09") %>%
  group_by(telseizoen, niveau3, nednaam, rivier) %>%
  summarise(aantal = max(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(telseizoen, niveau3, nednaam) %>%
  summarise(aantal = max(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(ordered(telseizoen), aantal, group = niveau3, color = niveau3)) +
  geom_point(aes(shape = niveau3)) +
  geom_line() +
  labs(x = "telseizoen",
       y = "max aantal zomer") +
  facet_wrap(~nednaam,
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

data_watervogels %>% 
  filter(nednaam %in% c("Kluut", "Kievit", "Tureluur", "Wulp", "Scholekster", "Bonte Strandloper")) %>% 
  filter(trofische_groep == "Nbenth") %>% 
  filter(str_detect(gebiedsgroep_code, "ZS4")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(jaar >= 2005,
         telseizoen != "2004/05") %>% 
  group_by(telseizoen, niveau3, nednaam, maand) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "gemiddeld aantal") +
  facet_wrap(~nednaam, 
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

# data_watervogels %>% 
#   filter(nednaam %in% c("Scholekster")) %>% 
#   filter(trofische_groep == "Nbenth") %>% 
#   filter(str_detect(gebiedsgroep_code, "ZS4")) %>% 
#   filter(maand %in% c(10:12, 1:3)) %>% 
#   filter(jaar >= 2019,
#          telseizoen != "2004/05") %>% 
#   group_by(telseizoen, gebiedsgroep, nednaam, maand) %>%
#   summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
#   ungroup() %>%
#   # group_by(telseizoen, gebiedsgroep, nednaam) %>% 
#   # summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   # ungroup() %>% 
#   ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
#   geom_point(aes(shape = gebiedsgroep)) +
#   geom_line() +
#   labs(x = "telseizoen", 
#        y = "gemiddeld aantal") +
#   facet_wrap(~nednaam, 
#              scales = "free_y") +
#   theme(axis.text.x = element_text(angle = 90),
#         legend.position = "bottom",
#         legend.title = element_blank())
# 
# 
# data_watervogels %>% 
#   filter(nednaam %in% c("Aalscholver", "Fuut", "Tureluur", "Wulp")) %>% 
#   filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
#   filter(maand %in% c(10:12, 1:3)) %>% 
#   filter(jaar >= 2005,
#          telseizoen != "2004/05") %>% 
#   group_by(telseizoen, gebiedsgroep, nednaam, maand) %>% 
#   summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   group_by(telseizoen, gebiedsgroep, nednaam) %>% 
#   summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
#   ungroup() %>% 
#   ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
#   geom_point(aes(shape = gebiedsgroep)) +
#   geom_line() +
#   labs(x = "telseizoen", 
#        y = "gemiddeld aantal") +
#   facet_wrap(~nednaam, 
#              scales = "free_y") +
#   theme(axis.text.x = element_text(angle = 90),
#         legend.position = "bottom",
#         legend.title = element_blank())

ggsave(paste0(pad_figuren, "100_figuur_aantallen_steltlopers.jpg"))

```
##### figuur wintergemiddelde vogeldichtheid per zones

```{r dichtheden winter watervogels per zone}

##gekoppelde dataset bevat nog beperkt aantal jaren en aantal jaargangen moeten er nog uit


  data_watervogels %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  # filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(niveau3 != "Zoet zijrivier") %>% 
  filter(telseizoen %in% c("2001/02","2010/11","2013/14","2016/17","2019/20")) %>%
  filter(nednaam != "Tafeleend" & nednaam != "Kuifeend") %>%
  filter(trofische_groep != "Npisc" & trofische_groep != "Nherb") %>% 
  left_join(data_oppzachtslikKRWZS, by = c("niveau3","telseizoen")) %>% 
  group_by(telseizoen, maand, niveau3, somha) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha) %>% 
  summarise(dichtheid = mean(aantal/somha, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), dichtheid, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() + 
    labs(x = "telseizoen", 
       y = "dichtheid overwinterende watervogel (#/ha)") +
    theme(axis.text.x = element_text(angle = 0),
        legend.position = "bottom",
        legend.title = element_blank())+
  scale_y_continuous(breaks = seq(0,140,20))

ggsave(paste0(pad_figuren, "100_figuur_dichtheid.jpg"))


##Zeeschelde IV wintertrends
data_watervogels %>% 
  filter(str_detect(gebiedsgroep_code, "ZS4")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(telseizoen %in% c("2001/02","2010/11","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20","2020/21",
                           "2021/22")) %>%
  filter(nednaam != "Tafeleend" & nednaam != "Kuifeend") %>%
  filter(trofische_groep != "Npisc" & trofische_groep != "Nherb") %>% 
  left_join(data_oppzachtslikKRWZS, by = c("niveau3","telseizoen")) %>% 
  group_by(telseizoen, maand, niveau3, somha) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha) %>% 
  summarise(dichtheid = mean(aantal/somha, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), dichtheid, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() + 
    labs(x = "telseizoen", 
       y = "dichtheid overwinterende watervogel (#/ha)") +
    theme(axis.text.x = element_text(angle = 0),
        legend.position = "bottom",
        legend.title = element_blank())+
  scale_y_continuous(breaks = seq(0,20,2))

ggsave(paste0(pad_figuren, "100_figuur_dichtheidZS4.jpg"))

##Zeeschelde IV wintertrends trofische groepen

data_watervogels %>% 
  filter(str_detect(gebiedsgroep_code, "ZS4")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  filter(telseizoen %in% c("2001/02","2010/11","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20","2020/21",
                           "2021/22")) %>%
  filter(nednaam != "Tafeleend" & nednaam != "Kuifeend") %>%
  filter(trofische_groep != "Npisc" & trofische_groep != "Nherb") %>% 
  left_join(data_oppzachtslikKRWZS, by = c("niveau3","telseizoen")) %>%  
  group_by(telseizoen, maand, niveau3, somha,trofische_groep) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha,trofische_groep) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha,trofische_groep) %>% 
  summarise(dichtheid = mean(aantal/somha, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), dichtheid, group = trofische_groep, color = trofische_groep)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() + 
    labs(x = "telseizoen", 
       y = "dichtheid overwinterende watervogel (#/ha)") +
    theme(axis.text.x = element_text(angle = 0),
        legend.position = "bottom",
        legend.title = element_blank())+
  scale_y_continuous(breaks = seq(0,20,2))



##Zeeschelde IV jaartrends telseizoen
data_watervogels %>% 
  filter(str_detect(gebiedsgroep_code, "ZS4")) %>% 
  # filter(maand %in% c(10:12, 1:3)) %>% 
  filter(telseizoen %in% c("2001/02","2010/11","2012/13","2013/14","2014/15","2015/16","2016/17","2017/18","2018/19","2019/20","2020/21",
                           "2021/22")) %>%
  filter(nednaam != "Tafeleend" & nednaam != "Kuifeend") %>%
  filter(trofische_groep != "Npisc" & trofische_groep != "Nherb") %>% 
  left_join(data_oppzachtslikKRWZS, by = c("niveau3","telseizoen")) %>% 
  group_by(telseizoen, maand, niveau3, somha) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, niveau3, somha) %>% 
  summarise(dichtheid = mean(aantal/somha, na.rm = TRUE)) %>% 
  ggplot(aes(ordered(telseizoen), dichtheid, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() + 
    labs(x = "telseizoen", 
       y = "dichtheid overwinterende watervogel (#/ha)") +
    theme(axis.text.x = element_text(angle = 0),
        legend.position = "bottom",
        legend.title = element_blank())+
  scale_y_continuous(breaks = seq(0,20,2))

# oppervlakte veranderingen exclusief uitbreidingen (enge planimetrie)

data_watervogels %>% 
  # filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(telseizoen %in% c("2001/02","2010/11","2013/14","2016/17","2019/20")) %>%
  left_join(data_oppzachtslikKRWZS, by = c("niveau3","telseizoen")) %>% 
  filter(!is.na(somha)) %>%
  group_by(telseizoen, niveau3, somha) %>% 
  ggplot(aes(ordered(telseizoen), somha, group = niveau3, color = niveau3)) + 
  geom_point(aes(shape = niveau3)) +
  geom_line() + 
    labs(x = "telseizoen", 
       y = "Oppervlakte slik zacht substraat (ha)")+
    theme(axis.text.x = element_text(angle = 0),
        legend.position = "bottom",
        legend.title = element_blank())
  
ggsave(paste0(pad_figuren, "100_figuur_habitatoppervlakte.jpg"))


```

##### figuur exotentrends

```{r 100-figuur-exotentrends, fig.height=5, fig.width=7}

##hiervoor zou er ideaal uit de databank een label moeten zijn voor exoten - dan kan er een figuur gemaakt worden met
##cumulatief aantal waargenomen exotische soorten, het aantal waargenomen soorten en de soorten die gevestigd zijn 
##dit kan bv zijn soorten die minstens 2 jaar na elkaar met meer dan 2 ind. in gebiedsgroep geteld zijn (al de rest is niet van belang)
##als er nieuwe soort vestigt duikt die hier meteen op als alert (indien nog niet doorgegeven via tellers...)

data_watervogels %>% 
  filter(nednaam %in% c("Nijlgans", "Canadese Gans", "Soepeend", "Boerengans")) %>% 
  filter(str_detect(gebiedsgroep_code, "ZS")) %>% 
  filter(maand %in% c(10:12, 1:3)) %>% 
  # filter(jaar >= 2009,
         # telseizoen != "2008/09") %>% 
  group_by(telseizoen, gebiedsgroep, nednaam, maand) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(telseizoen, gebiedsgroep, nednaam) %>% 
  summarise(aantal = mean(aantal, na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(ordered(telseizoen), aantal, group = gebiedsgroep, color = gebiedsgroep)) + 
  geom_point(aes(shape = gebiedsgroep)) +
  geom_line() +
  labs(x = "telseizoen", 
       y = "gemiddeld aantal") +
  facet_wrap(~nednaam, 
             scales = "free_y") +
  theme(axis.text.x = element_text(angle = 90),
        legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "100_figuur_aantallen_exoten.jpg"))

```


```{r meta-data}

meta_data <- 
  enframe(c(vroegste_telseizoen = vroegste_telseizoen, 
            laatste_telseizoen = laatste_telseizoen, 
            vroegste_jaar = vroegste_jaar,
            laatste_jaar = laatste_jaar,
            aantal_soorten = nrow(soortnamen)),
          name = "naam", value = "waarde")

meta_data %>% 
  write_delim(paste0(pad_data, "meta_data.csv"),
              delim = ";")

```

