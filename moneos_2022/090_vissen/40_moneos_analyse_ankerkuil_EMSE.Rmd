---
params:
  hoofdstuk: "090_vissen"
knit: (function(inputFile, encoding) {
        rmarkdown::render(inputFile,
                          encoding=encoding,
                          output_dir = paste0(
                          "/output")
                          )})
                          rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, 
title: "analyse visdata ankerkuil"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

```


```{r libraries}

library(tidyverse)
library(lubridate)
library(writexl)
library(readxl)
# library(yarrr)
library(wesanderson)
library(gridExtra)
library(cowplot)

library(INBOtheme)
library(inbodb)

library(rprojroot) ## workaround pad

```


```{r pad}

# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")

```


```{r excel sheets}

sheets <- NULL

```


```{r EMSE tabellen}

sleutelsoorten_EMSE <-
  read_xlsx(str_c(pad_data, "sleutelsoorten EMSE.xlsx"))

func_groepen_EMSE <-
  read_xlsx(str_c(pad_data, "functionele groepen.xlsx")) %>% 
  mutate(Soort = str_to_lower(Soort))

levels_indeling <-
  c("Mar/Est -- Benth", "Mar/Est -- Plankt", "Mar/Est -- Pisc",
    "Diadr -- Benth", "Diadr -- Omn", "Diadr -- Pisc",
    "Zoetw -- Benth", "Zoetw -- Omn", "Zoetw -- Pisc")

```

##### datasets voor aantal en gewicht:

-   *G:/Mijn Drive/INBODATA/PROJECTEN/PRJ_SCHELDE/VNSC/Rapportage_INBO/2022/090_vissen/data/ankerkuil_aantallen_2012_2021.csv*
-   *G:/Mijn Drive/INBODATA/PROJECTEN/PRJ_SCHELDE/VNSC/Rapportage_INBO/2022/090_vissen/data/ankerkuil_gewicht_2012_2021.csv*

```{r inlezen-data}

soortenlijst <- 
  read_xlsx(str_c(pad_data, "soorten_Zeeschelde.xlsx"), sheet = "EMSE")

ankerkuil_aantal <- 
  read_delim(paste0(pad_data, "ankerkuil_aantallen_2012_2021.csv"),
             delim = ";")

ankerkuil_gewicht <- 
  read_delim(paste0(pad_data, "ankerkuil_gewicht_2012_2021.csv"),
             delim = ";")

data_ankerkuil <- 
  ankerkuil_aantal %>% 
  pivot_longer(cols = `tiendoornige stekelbaars`:last_col(),
               names_to = "soort",
               values_to = "aantal") %>%
  left_join(ankerkuil_gewicht %>% 
              select(-uren, -volume) %>% 
              pivot_longer(cols = `tiendoornige stekelbaars`:last_col(),
                           names_to = "soort",
                           values_to = "gewicht")) %>% 
  mutate(gewicht = if_else(aantal == 0, 0, gewicht),
         seizoen = recode(seizoen,
                          VJ = "voorjaar",
                          NJ = "najaar",
                          Z = "zomer"),
         seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar")),
         locatie = factor(locatie, levels = c(c("Doel", "Antwerpen", "Steendorp", "Branst")))) %>%
  # filter(!str_detect(soort, "garnaal|garnalen|gammarus|krab|kreeft|inktvis|octopus|zeekat")) %>%
  group_by(soort) %>% 
  mutate(anyN = any(aantal > 0)) %>% 
  ungroup() %>% 
  filter(anyN) %>% 
  select(-anyN) %>% 
  left_join(soortenlijst %>% 
              select(-opmerking))


vroegste_jaar <-
  data_ankerkuil %>% 
  pull(jaar) %>% 
  min()

laatste_jaar <-
  data_ankerkuil %>% 
  pull(jaar) %>% 
  max()

```


```{r enkel-vissen}

soorten <- 
  data_ankerkuil %>% 
  distinct(soort) %>% 
  pull(soort)

# soorten_invertebraten <-
#   c("wolhandkrab", "grijze garnalen", "steurgarnalen", "gammarus", "noordzeekrab", "japanse steurgarnaal", "penseelkrab")

soorten_invertebraten <-
  soorten %>% 
  keep(~ str_detect(., "garnaal|garnalen|gammarus|krab|kreeft|inktvis|octopus|zeekat")) 

soorten_vis <-
  setdiff(soorten, soorten_invertebraten) %>% 
  {.[order(.)]}

data_ankerkuil <- 
  data_ankerkuil %>% 
  filter(soort %in% soorten_vis)

```


```{r aantal-en-gewicht-per-kub}

data_ankerkuil <- 
  data_ankerkuil %>% 
  mutate(aantal_per_kub = aantal/volume,
         gewicht_per_kub = gewicht/volume)

```


```{r indeling EMSE rapportage}

data_ankerkuil %>% 
  distinct(salgroep)

data_ankerkuil %>% 
  distinct(dieet)

data_ankerkuil <- 
  data_ankerkuil %>% 
  mutate(salgroep_detail = salgroep,
         salgroep = case_when(
           salgroep_detail %in% c("mariene migranten", "mariene dwaalgasten", "estuarien residenten") ~ "mariene en estuariene soorten",
           salgroep_detail %in% c("diadromen") ~ "diadrome soorten",
           salgroep_detail %in% c("zoetwatersoorten") ~ "zoetwatersoorten"
         ),
         indeling = case_when(
           salgroep == "mariene en estuariene soorten" & dieet == "benthivoren" ~ "Mar/Est -- Benth",
           salgroep == "mariene en estuariene soorten" & dieet == "piscivoren" ~ "Mar/Est -- Pisc",
           salgroep == "mariene en estuariene soorten" & dieet == "planktivoren" ~ "Mar/Est -- Plankt",
           salgroep == "diadrome soorten" & dieet == "benthivoren" ~ "Diadr -- Benth",
           salgroep == "diadrome soorten" & dieet == "piscivoren" ~ "Diadr -- Pisc",
           salgroep == "diadrome soorten" & dieet == "omnivoren" ~ "Diadr -- Omn",
           salgroep == "zoetwatersoorten" & dieet == "benthivoren" ~ "Zoetw -- Benth",
           salgroep == "zoetwatersoorten" & dieet == "piscivoren" ~ "Zoetw -- Pisc",
           salgroep == "zoetwatersoorten" & dieet == "omnivoren" ~ "Zoetw -- Omn"),
         indeling = factor(indeling, levels = levels_indeling),
         in_indeling = !is.na(indeling)) %>% 
  left_join(sleutelsoorten_EMSE %>% rename(indeling_SL = indeling))

indeling_EMSE <-
  data_ankerkuil %>% 
  distinct(soort, salgroep, dieet, in_indeling, indeling, indeling_SL)

# levels(data_ankerkuil$indeling)
# levels(indeling_EMSE$indeling)

```

#### relatie aantal - gewicht

```{r relatie-aantal-gewicht}

# data_ankerkuil %>%
#   ggplot(aes(aantal, gewicht)) +
#   geom_point() +
#   geom_smooth(span = 10, se = FALSE) +
#   facet_wrap(~soort,
#              scales = "free",
#              ncol = 5)

data_ankerkuil %>% 
  ggplot(aes(aantal + 1, gewicht + 1)) +
  geom_point() +
  geom_smooth(span = 10, se = FALSE) +
  scale_x_log10(breaks = c(0,1,10,100,1000,10000,100000,1000000,10000000) + 1, labels = function(x) x-1) +
  scale_y_log10(breaks = c(0,1,10,100,1000,10000,100000,1000000,10000000) + 1, labels = function(x) x-1) +
  labs(x = "aantal",
       y = "gewicht") +
  facet_wrap(~soort, 
             scales = "free",
             ncol = 8)

# # ggsave(paste0(pad_figuren, "relatie_aantal_gewicht.jpg"))

```


#### aantal soorten

```{r aantal-soorten}

# aantal_soorten_seizoen_locatie <- 
#   data_ankerkuil %>% 
#   filter(aantal > 0) %>% 
#   distinct(jaar, seizoen, locatie, soort) %>% 
#   count(jaar, seizoen, locatie, name = "soorten")
# 
# aantal_soorten_seizoen_locatie %>% 
#   ggplot(aes(jaar, soorten, fill = ordered(jaar), color = ordered(jaar))) +
#   geom_col(position = position_dodge(width = 0.8),
#            width = 0.7,
#            alpha = 0.8) +
#   geom_text(aes(y = soorten + 2, label = soorten),
#             position = position_dodge(width = 0.8),
#             size = 4, color = "steelblue4") +
#   scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
#   # labs(fill = "jaar",
#   #      color = "jaar") +
#   guides(fill="none",
#          color = "none") +
#   facet_grid(seizoen ~ locatie)
# 
# ggsave(paste0(pad_figuren, "aantal_soorten_seizoen_locatie.jpg"))


aantal_soorten_seizoen_locatie <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, seizoen, locatie, soort) %>% 
  count(jaar, seizoen, locatie, name = "soorten") %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, locatie, soort) %>% 
              count(jaar, locatie, name = "soorten") %>% 
              mutate(seizoen = "totaal over seizoenen")) %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, seizoen, soort) %>% 
              count(jaar, seizoen, name = "soorten") %>% 
              mutate(locatie = "totaal over locaties")) %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, soort) %>% 
              count(jaar, name = "soorten") %>% 
              mutate(seizoen = "totaal over seizoenen",
                     locatie = "totaal over locaties")) %>% 
  mutate(seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar", "totaal over seizoenen")),
         locatie = factor(locatie, levels = c("Doel", "Antwerpen", "Steendorp", "Branst", "totaal over locaties")))

aantal_soorten_seizoen_locatie %>% 
  ggplot(aes(jaar, soorten, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(width = 0.8),
           width = 0.7,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 3, label = soorten),
            position = position_dodge(width = 0.8),
            size = 3, color = "steelblue4") +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # labs(fill = "jaar",
  #      color = "jaar") +
  guides(fill="none",
         color = "none") +
  facet_grid(seizoen ~ locatie) +
  theme(strip.text = element_text(size = 12))

ggsave(paste0(pad_figuren, "aantal_soorten_seizoen_locatie.jpg"), width = 12, height = 10)


aantal_soorten_seizoen <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, seizoen, locatie, soort) %>% 
  count(jaar, seizoen, locatie, name = "soorten") %>% 
  group_by(jaar, seizoen) %>%
  summarise(soorten = round(mean(soorten))) %>% 
  ungroup() %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, locatie, soort) %>% 
              count(jaar, locatie, name = "soorten") %>% 
              group_by(jaar) %>% 
              summarise(soorten = round(mean(soorten))) %>% 
              ungroup() %>% 
              mutate(seizoen = "totaal over seizoenen")) %>% 
  mutate(seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar", "totaal over seizoenen")))

aantal_soorten_seizoen %>% 
  ggplot(aes(seizoen, soorten, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(width = 0.8),
           width = 0.6,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 1, label = soorten),
            position = position_dodge(width = 0.8),
            size = 2, color = "steelblue4") +
  labs(fill = "jaar",
       color = "jaar")

ggsave(paste0(pad_figuren, "aantal_soorten_seizoen.jpg"), width = 8, height = 4)


aantal_soorten_locatie <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, seizoen, locatie, soort) %>% 
  count(jaar, seizoen, locatie, name = "soorten") %>% 
  group_by(jaar, locatie) %>%
  summarise(soorten = round(mean(soorten))) %>% 
  ungroup() %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, seizoen, soort) %>% 
              count(jaar, seizoen, name = "soorten") %>% 
              group_by(jaar) %>% 
              summarise(soorten = round(mean(soorten))) %>% 
              ungroup() %>% 
              mutate(locatie = "totaal over locaties")) %>% 
  mutate(locatie = factor(locatie, levels = c("Doel", "Antwerpen", "Steendorp", "Branst", "totaal over locaties")))

aantal_soorten_locatie %>% 
  ggplot(aes(locatie, soorten, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(width = 0.8),
           width = 0.6,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 1, label = soorten),
            position = position_dodge(width = 0.8),
            size = 2, color = "steelblue4") +
  labs(fill = "jaar",
       color = "jaar")

ggsave(paste0(pad_figuren, "aantal_soorten_locatie.jpg"), width = 8, height = 4)


aantal_soorten_totaal <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, soort) %>% 
  count(jaar, name = "soorten")

aantal_soorten_totaal %>% 
  ggplot(aes(jaar, soorten, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(width = 0.8),
           width = 0.7,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 2, label = soorten),
            position = position_dodge(width = 0.8),
            size = 3, color = "steelblue4") +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # labs(fill = "jaar",
  #      color = "jaar") +
  guides(fill="none",
         color = "none")

ggsave(paste0(pad_figuren, "aantal_soorten_totaal.jpg"), width = 6, height = 4)

```


#### overzicht gevangen soorten

```{r overzicht-gevangen-soorten}

tabel_gevangen_soorten <-
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar,
         aantal > 0) %>% 
  mutate(seizoen_locatie = factor(paste(seizoen, locatie, sep = "_"),
                                  levels = sapply(c("voorjaar", "zomer", "najaar"),
                                                  function(x) paste(x, c("Doel", "Antwerpen", "Steendorp", "Branst"), sep = "_")) %>%
                                    c())) %>%
  select(seizoen_locatie, soort) %>% 
  mutate(aanwezig = "x") %>% 
  spread(seizoen_locatie, aanwezig, fill = "")

knitr::kable(tabel_gevangen_soorten)

sheets[["gevangen_soorten"]] <- tabel_gevangen_soorten
  

# write_xlsx(list(gevangen_soorten = tabel_gevangen_soorten),
#            paste0(pad_tabellen, "tabellen_vissen.xlsx"))

```


#### relatief aantal gevangen individuen

```{r relatief-aantal-gevangen-individuen, fig.height=6, fig.width=6}

relatief_aantal <- 
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar) %>% 
  group_by(seizoen, locatie) %>%
  mutate(relatief_aantal = aantal/sum(aantal),
         relatief_gewicht = gewicht/sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(soort) %>% 
  mutate(soort2 = ifelse(any(relatief_aantal >= 0.05 | relatief_gewicht >= 0.05), soort, "rest")) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie, soort2) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie) %>% 
  mutate(soort2 = soort2,
         aantal = round(aantal/sum(aantal)*100)) %>% 
  ungroup() %>% 
  rename(soort = soort2) %>% 
  mutate(soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest")))

relatief_aantal %>% 
  mutate(aantal = if_else(aantal == 0, NA_real_, aantal)) %>% 
  ggplot(aes(x ="", y = aantal, fill = soort)) +
  geom_col(position = "fill") +
  # geom_text(aes(label = soort),
  #            size = 3) +
  geom_text(aes(label = aantal, size = aantal),
            position = position_fill(vjust = 0.5),
            show.legend = FALSE) +
  coord_polar("y", start=0) +
  facet_grid(locatie ~ seizoen) +
  labs(x = NULL,
       y = NULL) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  theme(
    # legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "relatief_aantal_gevangen_individuen.jpg"))

```


#### relatieve biomassa gevangen individuen

```{r relatieve-biomassa-gevangen-individuen, fig.height=6, fig.width=6}

relatief_gewicht <- 
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar) %>% 
  group_by(seizoen, locatie) %>%
  mutate(relatief_aantal = aantal/sum(aantal),
         relatief_gewicht = gewicht/sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(soort) %>% 
  mutate(soort2 = ifelse(any(relatief_aantal >= 0.05 | relatief_gewicht >= 0.05), soort, "rest")) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie, soort2) %>% 
  summarise(gewicht = sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie) %>% 
  mutate(soort2 = soort2,
         gewicht = round(gewicht/sum(gewicht)*100)) %>% 
  ungroup() %>% 
  rename(soort = soort2) %>% 
  mutate(soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest")))

relatief_gewicht %>% 
  mutate(gewicht = if_else(gewicht == 0, NA_real_, gewicht)) %>% 
  ggplot(aes(x ="", y = gewicht, fill = soort)) +
  geom_col(position = "fill") +
  # geom_text(aes(label = soort),
  #            size = 3) +
  geom_text(aes(label = gewicht, size = gewicht),
            position = position_fill(vjust = 0.5),
            show.legend = FALSE) +
  coord_polar("y", start=0) +
  facet_grid(locatie ~ seizoen) +
  labs(x = NULL,
       y = NULL) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  theme(
    # legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "relatieve_biomassa_gevangen_individuen.jpg"))

```


#### aantallen EMSE

```{r aantallen EMSE}

mult_kub <- 1000

gemiddeld_aantal_EMSE <- 
  data_ankerkuil %>% 
  filter(in_indeling) %>% 
  group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = sum(aantal_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
  ungroup() %>% 
  add_row(aantal_per_kub = NA, indeling = "Diadr -- Benth", jaar = vroegste_jaar:laatste_jaar) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling))

gemiddeld_aantal_EMSE %>% 
  mutate(aantal_per_kub = aantal_per_kub*mult_kub) %>%
  ggplot(aes(jaar, aantal_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  # geom_linerange(aes(ymin = 0, ymax = aantal_per_kub),
  #                size = 4) +
  # geom_text(aes(y = aantal_per_kub + 0.3, label = aantal_per_kub), 
  #           position = position_dodge(width = 0.925),
  #           size = 3) +
  # scale_fill_viridis_c() +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "aantallen_EMSE.jpg"), width = 8, height = 6)


gemiddeld_aantal_niet_EMSE <- 
  data_ankerkuil %>% 
  filter(!in_indeling,
         !is.na(dieet)) %>% 
  group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = sum(aantal_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
  ungroup()

gemiddeld_aantal_niet_EMSE %>% 
  mutate(aantal_per_kub = aantal_per_kub*mult_kub) %>%
  ggplot(aes(jaar, aantal_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  # geom_linerange(aes(ymin = 0, ymax = aantal_per_kub),
  #                size = 4) +
  # geom_text(aes(y = aantal_per_kub + 0.3, label = aantal_per_kub), 
  #           position = position_dodge(width = 0.925),
  #           size = 3) +
  # scale_fill_viridis_c() +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  guides(fill = "none",
         color = "none") +
  facet_wrap(salgroep ~ dieet, scales = "free_y")

ggsave(paste0(pad_figuren, "aantallen_niet_EMSE.jpg"), width = 4, height = 3)

```


#### gewicht EMSE

```{r gewicht EMSE}

mult_kub <- 1000

gemiddeld_gewicht_EMSE <- 
  data_ankerkuil %>% 
  filter(in_indeling) %>% 
  group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
  summarise(gewicht_per_kub = sum(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, salgroep, dieet, indeling) %>%
  summarise(gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  add_row(gewicht_per_kub = NA, indeling = "Diadr -- Benth", jaar = vroegste_jaar:laatste_jaar) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling))

gemiddeld_gewicht_EMSE %>% 
  mutate(gewicht_per_kub = gewicht_per_kub*mult_kub) %>%
  ggplot(aes(jaar, gewicht_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  # geom_linerange(aes(ymin = 0, ymax = gewicht_per_kub),
  #                size = 4) +
  # geom_text(aes(y = gewicht_per_kub + 0.3, label = gewicht_per_kub), 
  #           position = position_dodge(width = 0.925),
  #           size = 3) +
  # scale_fill_viridis_c() +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "biomassa_EMSE.jpg"), width = 8, height = 6)


gemiddeld_gewicht_niet_EMSE <- 
  data_ankerkuil %>% 
  filter(!in_indeling,
         !is.na(dieet)) %>% 
  group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
  summarise(gewicht_per_kub = sum(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, salgroep, dieet, indeling) %>%
  summarise(gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup()

gemiddeld_gewicht_niet_EMSE %>% 
  mutate(gewicht_per_kub = gewicht_per_kub*mult_kub) %>%
  ggplot(aes(jaar, gewicht_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  # geom_linerange(aes(ymin = 0, ymax = gewicht_per_kub),
  #                size = 4) +
  # geom_text(aes(y = gewicht_per_kub + 0.3, label = gewicht_per_kub), 
  #           position = position_dodge(width = 0.925),
  #           size = 3) +
  # scale_fill_viridis_c() +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) +
  guides(fill = "none",
         color = "none") +
  facet_wrap(salgroep ~ dieet, scales = "free_y")

ggsave(paste0(pad_figuren, "biomassa_niet_EMSE.jpg"), width = 4, height = 3)

```


#### diversiteit EMSE

```{r diversiteit EMSE}
# EH = H / ln(S)

gemiddeld_diversiteit_EMSE <- 
  data_ankerkuil %>% 
  filter(in_indeling) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = aantal/sum(aantal)) %>% 
  summarise(N = n(),
            H_sh = -sum(relatief_aantal*log(relatief_aantal)),
            H_gs = 1-sum(relatief_aantal^2),
            D_sh = exp(H_sh),
            D_gs = 1/(1-H_gs),
            E_sh = H_sh/log(N)) %>%
  ungroup() %>% 
  group_by(jaar, salgroep, dieet, indeling) %>%
  summarise(N = mean(N),
            H_sh = mean(H_sh),
            H_gs = mean(H_gs),
            D_sh = mean(D_sh),
            D_gs = mean(D_gs),
            E_sh = mean(E_sh)) %>% 
  ungroup() %>% 
  add_row(N = NA, H_sh = NA, H_gs = NA, D_sh = NA, D_gs = NA, indeling = "Diadr -- Benth", jaar = vroegste_jaar:laatste_jaar) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling))

gemiddeld_diversiteit_EMSE %>% 
  ggplot(aes(jaar, N, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = "aantal soorten") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_N_EMSE.jpg"), width = 8, height = 6)

gemiddeld_diversiteit_EMSE %>% 
  ggplot(aes(jaar, H_sh, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(y = "shannon diversity index H") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_H_shannon_EMSE.jpg"), width = 8, height = 6)


gemiddeld_diversiteit_EMSE %>%
  ggplot(aes(jaar, H_gs, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # labs(y = "shannon diversiteit H") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

gemiddeld_diversiteit_EMSE %>% 
  ggplot(aes(jaar, D_sh, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = "shannon true diversiteit D") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_D_shannon_EMSE.jpg"), width = 8, height = 6)


gemiddeld_diversiteit_EMSE %>%
  ggplot(aes(jaar, D_gs, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # labs(y = "shannon diversiteit H") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")


gemiddeld_diversiteit_EMSE %>% 
  ggplot(aes(jaar, E_sh, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = "shannon eveness E") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_E_shannon_EMSE.jpg"), width = 8, height = 6)


gemiddeld_diversiteit_EMSE %>% 
  ggplot(aes(jaar, N, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(),
           width = 0.7,
           alpha = 0.25) +
  geom_col(aes(y = D_sh),
           position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = "N -- D") +
  guides(fill = "none",
         color = "none") +
  facet_wrap(~ indeling, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_N_D_EMSE.jpg"), width = 8, height = 6)

```


#### relatieven aantallen EMSE

```{r}

relatieve_aantallen_EMSE <- 
  data_ankerkuil %>% 
  filter(in_indeling) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = aantal/sum(aantal),
         relatief_gewicht = gewicht/sum(gewicht)) %>% 
  mutate(max_aantal = relatief_aantal == max(relatief_aantal),
         max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  # mutate(max_aantal = relatief_aantal >= 0.5,
  #        max_gewicht = relatief_gewicht >= 0.5) %>%
  ungroup() %>% 
  group_by(jaar, soort, salgroep, dieet, indeling) %>%
  # summarise(relatief_aantal = mean(relatief_aantal),
  #           relatief_gewicht = mean(relatief_gewicht)) %>%
  summarise(relatief_aantal = mean(relatief_aantal),
            relatief_gewicht = mean(relatief_gewicht),
            max_aantal = any(max_aantal),
            max_gewicht = any(max_gewicht)) %>%
  ungroup() %>% 
  # group_by(jaar, salgroep, dieet, indeling) %>%
  # mutate(max_aantal = relatief_aantal == max(relatief_aantal),
  #        max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  # # mutate(max_aantal = relatief_aantal >= 0.5,
  # #        max_gewicht = relatief_gewicht >= 0.5) %>%
  # ungroup() %>%
  group_by(soort) %>% 
  mutate(soort = ifelse(any(max_aantal | max_gewicht), soort, "rest")) %>%
  ungroup() %>% 
  # mutate(soort = if_else(max_aantal | max_gewicht, soort, "rest")) %>%
  group_by(jaar, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = relatief_aantal/sum(relatief_aantal)) %>% 
  ungroup() %>% 
  left_join(data_ankerkuil %>% 
              filter(in_indeling) %>% 
              filter(aantal > 0) %>% 
              group_by(jaar, seizoen, locatie, salgroep, dieet, indeling) %>%
              summarise(N = n()) %>% 
              ungroup() %>% 
              group_by(jaar, salgroep, dieet, indeling) %>%
              summarise(N = mean(N)) %>% 
              ungroup()) %>% 
  add_row(N = NA, relatief_aantal = NA, indeling = "Diadr -- Benth", jaar = vroegste_jaar:laatste_jaar) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest")))

# relatieve_aantallen_EMSE %>% 
#   distinct(soort) %>% pull(soort)


# my_pal_yarr <- 
#   c(piratepal(palette = "info2", 
#             trans = 1,
#             plot.result = F,
#             length.out = length(levels(relatieve_aantallen_EMSE$soort))-1) %>% 
#   unname(), 
#   "grey")

my_pal_wes <- 
c(wes_palette("FantasticFox1", 
            type = "continuous", 
            n = length(levels(relatieve_aantallen_EMSE$soort))-1) %>% 
  unname(), 
  "darkslategrey")
names(my_pal_wes) <-
  levels(relatieve_aantallen_EMSE$soort)

# relatieve_aantallen_EMSE %>% 
#   ggplot(aes(jaar, relatief_aantal*N, fill = soort)) +
#   geom_col(position = position_stack(),
#            width = 0.7,
#            alpha = 0.9) +
#   scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
#   # scale_y_log10() +
#   # scale_fill_brewer(palette = "Paired") +
#   scale_fill_manual(values = my_pal_wes) +
#   labs(y = "aantal soorten") +
#   facet_wrap(~ indeling, scales = "free_y")

# ggsave(paste0(pad_figuren, "diversiteit_N_EMSE.jpg"), width = 8, height = 6)


data_split <-
  relatieve_aantallen_EMSE %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*N, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = "aantal soorten",
                         fill = ind) + 
                    theme(legend.justification = c(0,1))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  ggplot(aes(jaar, relatief_aantal*N, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(y = "aantal soorten") +
  facet_wrap(~ indeling, scales = "free_y") +
  theme(legend.position = "none")

plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                              align = "h"),
                    NULL,
                    ncol = 1, rel_heights = c(0.1,1,0.2)),
          ncol = 3, rel_widths = c(1.5,0.1,1))

ggsave(paste0(pad_figuren, "relatieve_aantallen_EMSE.jpg"), width = 12, height = 6, bg = "white")

```


#### sleutelsoorten aantallen

```{r sleutelsoorten aantal}

sleutelsoorten <- c("fint", "spiering", "rivierprik", "haring", "zeebaars", "ansjovis")

data_ankerkuil %>% 
  filter(soort %in% sleutelsoorten) %>% 
  mutate(jaar_num = as.numeric(ordered(jaar)),
         periode_num = case_when(
           seizoen == "voorjaar" ~ jaar_num + 0.25,
           seizoen == "zomer" ~ jaar_num + 0.5,
           seizoen == "najaar" ~ jaar_num + 0.75,
           TRUE ~ jaar_num
         )) %>% {
           ggplot(., aes(periode_num, aantal_per_kub, color = locatie)) +
             geom_line(size = 1) +
             scale_x_continuous(breaks = unique(.$jaar_num), labels = unique(.$jaar)) +
             labs(x = NULL,
                  y = expression(paste("aantal individuen per ", m^3))) + 
             facet_wrap(~soort,
                        scales = "free_y") +
             theme(axis.text.x = element_text(angle = 90))
         }
# ggsave(paste0(pad_figuren, "aantallen_sleutelsoorten.jpg"))


data_ankerkuil %>%  
  group_by(jaar, seizoen, locatie) %>%
  mutate(relatief_aantal = aantal/sum(aantal)*100) %>% 
  ungroup() %>% 
  filter(soort %in% sleutelsoorten) %>% 
  mutate(jaar_num = as.numeric(ordered(jaar)),
         periode_num = case_when(
           seizoen == "voorjaar" ~ jaar_num + 0.25,
           seizoen == "zomer" ~ jaar_num + 0.5,
           seizoen == "najaar" ~ jaar_num + 0.75,
           TRUE ~ jaar_num
         )) %>% {
           ggplot(., aes(periode_num, relatief_aantal, color = locatie)) +
             geom_line(size = 1) +
             scale_x_continuous(breaks = unique(.$jaar_num), labels = unique(.$jaar)) +
             labs(x = NULL,
                  y = expression(paste("% van gevangen aantal individuen"))) + 
             facet_wrap(~soort,
                        scales = "free_y") +
             theme(axis.text.x = element_text(angle = 90))
         }
# ggsave(paste0(pad_figuren, "relatieve_aantallen_sleutelsoorten.jpg"))

```


#### sleutelsoorten biomassa

```{r sleutelsoorten biomassa}

sleutelsoorten <- c("fint", "spiering", "rivierprik", "haring", "zeebaars", "ansjovis")

data_ankerkuil %>% 
  filter(soort %in% sleutelsoorten) %>% 
  mutate(jaar_num = as.numeric(ordered(jaar)),
         periode_num = case_when(
           seizoen == "voorjaar" ~ jaar_num + 0.25,
           seizoen == "zomer" ~ jaar_num + 0.5,
           seizoen == "najaar" ~ jaar_num + 0.75,
           TRUE ~ jaar_num
         )) %>% {
           ggplot(., aes(periode_num, gewicht_per_kub, color = locatie)) +
             geom_line(size = 1) +
             scale_x_continuous(breaks = unique(.$jaar_num), labels = unique(.$jaar)) +
             labs(x = NULL,
                  y = expression(paste("gemiddelde biomassa  ", g/m^3))) + 
             facet_wrap(~soort,
                        scales = "free_y") +
             theme(axis.text.x = element_text(angle = 90))
         }
# ggsave(paste0(pad_figuren, "biomassa_sleutelsoorten.jpg"))


data_ankerkuil %>%  
  group_by(jaar, seizoen, locatie) %>%
  mutate(relatief_gewicht = gewicht/sum(gewicht)*100) %>% 
  ungroup() %>% 
  filter(soort %in% sleutelsoorten) %>% 
  mutate(jaar_num = as.numeric(ordered(jaar)),
         periode_num = case_when(
           seizoen == "voorjaar" ~ jaar_num + 0.25,
           seizoen == "zomer" ~ jaar_num + 0.5,
           seizoen == "najaar" ~ jaar_num + 0.75,
           TRUE ~ jaar_num
         )) %>% {
           ggplot(., aes(periode_num, relatief_gewicht, color = locatie)) +
             geom_line(size = 1) +
             scale_x_continuous(breaks = unique(.$jaar_num), labels = unique(.$jaar)) +
             labs(x = NULL,
                  y = expression(paste("% van gevangen biomassa"))) + 
             facet_wrap(~soort,
                        scales = "free_y") +
             theme(axis.text.x = element_text(angle = 90))
         }
# ggsave(paste0(pad_figuren, "relatieve_biomassa_sleutelsoorten.jpg"))

```


#### sleutelsoorten diversiteit


#### exoten

```{r}

exoten <-
  c("blauwbandgrondel", "regenboogforel", "giebel", "snoekbaars", "zonnebaars", "zwartbekgrondel", "reuzenkapiteinvis", "naakte grondel", "terapon jarbua") %>%
  union(soortenlijst %>% filter(!is.na(Exoot)& Exoot) %>% pull(soort))

tabel_gevangen_exoten <-
  data_ankerkuil %>% 
  filter(soort %in% exoten) %>% 
  group_by(jaar, locatie) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  pivot_wider(names_from = locatie,
              values_from = aantal)

knitr::kable(tabel_gevangen_exoten)

sheets[["gevangen_exoten"]] <- tabel_gevangen_exoten

# write_xlsx(list(gevangen_exoten = tabel_gevangen_exoten),
#            paste0(pad_tabellen, "tabellen_vissen.xlsx"))
  

tabel_percentage_exoten <-
  data_ankerkuil %>% 
  filter(soort %in% exoten) %>% 
  group_by(jaar, locatie) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  left_join(data_ankerkuil %>% 
              group_by(jaar, locatie) %>% 
              summarise(totaal = sum(aantal, na.rm = TRUE))) %>% 
  mutate(percentage = round(aantal/totaal*100, 2)) %>% 
  pivot_wider(id_cols = jaar,
              names_from = locatie,
              values_from = percentage)

knitr::kable(tabel_percentage_exoten)

sheets[["percentage_exoten"]] <- tabel_percentage_exoten

# write_xlsx(list(percentage_exoten = tabel_percentage_exoten),
#            paste0(pad_tabellen, "tabellen_vissen.xlsx"))


tabel_exoten_soort <-
  data_ankerkuil %>% 
  filter(soort %in% exoten) %>% 
  group_by(jaar, locatie, soort) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  arrange(soort, jaar) %>% 
  pivot_wider(id_cols = c(soort, jaar),
              names_from = locatie,
              values_from = aantal)

knitr::kable(tabel_exoten_soort)


tabel_exoten_soort <-
  data_ankerkuil %>% 
  filter(soort %in% exoten,
         jaar == laatste_jaar) %>% 
  group_by(jaar, locatie, soort) %>% 
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>% 
  arrange(soort) %>% 
  pivot_wider(id_cols = soort,
              names_from = locatie,
              values_from = aantal)

knitr::kable(tabel_exoten_soort)

sheets[["exoten_soort"]] <- tabel_exoten_soort


```


```{r wegschrijven tabellen}

write_xlsx(sheets,
           paste0(pad_tabellen, "tabellen_vissen.xlsx"))

```


#### EMSE indeling

```{r soortverschillen}

setdiff(soorten_EMSE$Soort, sleutelsoorten$soort)
setdiff(sleutelsoorten$soort, func_groepen_EMSE %>%  filter(Species != "NA") %>%  pull(Soort))

setdiff(soortenlijst %>%  filter(inEMSE) %>% pull(soort), soorten_vis)
setdiff(soorten_vis, soortenlijst %>%  filter(inEMSE) %>% pull(soort))

```


```{r}

soortenlijst_check <-
  soortenlijst %>% 
  mutate(Salgroep_detail = Salgroep,
         Salgroep = case_when(
           Salgroep_detail %in% c("Mariene migranten", "Mariene dwaalgasten", "Estuarien residenten") ~ "Mariene en Estuariene soorten",
           Salgroep_detail %in% c("Diadromen") ~ "Diadrome soorten",
           Salgroep_detail %in% c("Zoetwatersoorten") ~ "Zoetwatersoorten"
         ),
         indeling = case_when(
           Salgroep == "Mariene en Estuariene soorten" & Dieet == "Benthivoren" ~ "Mar/Est -- Benth",
           Salgroep == "Mariene en Estuariene soorten" & Dieet == "Piscivoren" ~ "Mar/Est -- Pisc",
           Salgroep == "Mariene en Estuariene soorten" & Dieet == "Planktivoren" ~ "Mar/Est -- Plankt",
           Salgroep == "Diadrome soorten" & Dieet == "Benthivoren" ~ "Diadr -- Benth",
           Salgroep == "Diadrome soorten" & Dieet == "Piscivoren" ~ "Diadr -- Pisc",
           Salgroep == "Diadrome soorten" & Dieet == "Omnivoren" ~ "Diadr -- Omn",
           Salgroep == "Zoetwatersoorten" & Dieet == "Benthivoren" ~ "Zoetw -- Benth",
           Salgroep == "Zoetwatersoorten" & Dieet == "Piscivoren" ~ "Zoetw -- Pisc",
           Salgroep == "Zoetwatersoorten" & Dieet == "Omnivoren" ~ "Zoetw -- Omn"),
         in_indeling = !is.na(indeling))

soortenlijst_check <-
  soortenlijst_check %>% 
  filter(!inEMSE) %>% 
  select(soort, Salgroep, Dieet, indeling) %>% 
  arrange(soort)

soortenlijst_check <-
  soortenlijst_check %>% 
  left_join(sleutelsoorten %>% 
              rename(indeling_SL = indeling)) %>% 
  mutate(., sleutelsoort = !is.na(.$indeling_SL)) %>% 
  # select(-Salgroep_detail, -Salgroep) %>% 
  relocate(sleutelsoort, .before = indeling)

soortenlijst_check %>% 
  mutate(across(everything(), as.character)) %>% 
  mutate(across(everything(), ~replace_na(.,"NA"))) %>% 
  write_xlsx(str_c(pad_data, "soorten niet in EMSE.xlsx"))

```


```{r figuur indeling}

data_ankerkuil %>%
  group_by(jaar, seizoen, locatie, soort, in_indeling) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(soort, in_indeling) %>%
  summarise(`N>0` = sum(aantal > 0, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(`N>0` > 0) %>%
  arrange(`N>0`, soort) %>%
  ggplot(aes(fct_inorder(soort), `N>0`+0.1, fill = in_indeling)) +
  geom_col() +
  scale_y_log10(breaks = c(1,3,10,30,100,300)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "soort",
       y = "aantal afvissingen waarbij N>0") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1))

data_ankerkuil %>%
  group_by(jaar, seizoen, locatie, soort, inEMSE, in_indeling) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(soort, inEMSE, in_indeling) %>%
  summarise(`N>0` = sum(aantal > 0, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(`N>0` > 0) %>%
  arrange(`N>0`, soort) %>%
  ggplot(aes(fct_inorder(soort), `N>0`+0.1, fill = in_indeling)) +
  geom_col() +
  scale_y_log10(breaks = c(1,3,10,30,100,300)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "soort",
       y = "aantal afvissingen waarbij N>0") +
  facet_wrap(~inEMSE, scales = "free_x", labeller = "label_both") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1))

data_ankerkuil %>%
  mutate(`EMSE - Indeling` = str_c(inEMSE, in_indeling, sep = " - ")) %>% 
  group_by(jaar, seizoen, locatie, soort, `EMSE - Indeling`) %>%
  summarise(aantal = sum(aantal, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(soort, `EMSE - Indeling`) %>%
  summarise(`N>0` = sum(aantal > 0, na.rm = TRUE)) %>%
  ungroup() %>%
  filter(`N>0` > 0) %>%
  arrange(`N>0`, soort) %>%
  ggplot(aes(fct_inorder(soort), `N>0`+0.1, fill = `EMSE - Indeling`)) +
  geom_col() +
  scale_y_log10(breaks = c(1,3,10,30,100,300)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "soort",
       y = "aantal afvissingen waarbij N>0") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1))


data_ankerkuil %>%
  group_by(soort, in_indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(aantal_per_kub, soort) %>%
  ggplot(aes(fct_inorder(soort), aantal_per_kub*100000, fill = in_indeling)) +
  geom_col() +
  scale_y_log10(breaks = c(0.1,0.3,1,3,10,30,100,300,1000,3000,10000,30000,100000)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "soort",
       y = "gem aantal per 100000 kub per vangst") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1))

data_ankerkuil %>%
  group_by(soort, in_indeling) %>%
  summarise(gewicht_per_kub = mean(gewicht_per_kub, na.rm = TRUE)) %>%
  ungroup() %>%
  arrange(gewicht_per_kub, soort) %>%
  ggplot(aes(fct_inorder(soort), gewicht_per_kub*100000, fill = in_indeling)) +
  geom_col() +
  scale_y_log10(breaks = c(0.1,0.3,1,3,10,30,100,300,1000,3000,10000,30000,100000)) +
  scale_fill_brewer(palette = "Set1") +
  labs(x = "soort",
       y = "gem gewicht per 100000 kub per vangst") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1))

```


```{r meta-data}

meta_data <- 
  enframe(c(vroegste_jaar = vroegste_jaar,
            laatste_jaar = laatste_jaar,
            aantal_soorten = 
              data_ankerkuil %>% 
              filter(!is.na(aantal),
                     aantal > 0) %>% 
              distinct(soort) %>% 
              nrow(),
            aantal_soorten_laatste_jaar = 
              data_ankerkuil %>% 
              filter(!is.na(aantal),
                     aantal > 0,
                     jaar == laatste_jaar) %>% 
              distinct(soort) %>% 
              nrow()),
          name = "naam", value = "waarde")

meta_data %>% 
  write_delim(paste0(pad_data, "vissen_meta_data.csv"),
              delim = ";")

```
