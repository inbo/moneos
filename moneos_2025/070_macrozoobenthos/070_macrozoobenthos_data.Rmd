---
params:
  hoofdstuk: "070_macrozoobenthos"
knit: (function(inputFile, ...) {
        rmarkdown::render(inputFile,
                          output_dir = paste0(rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, "/output"))})
title: "Macrozoöbenthos data"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

```


```{r libraries}

library(tidyverse)
library(lubridate)
library(readxl)
library(writexl)
library(rprojroot)
library(janitor)
library(ggpmisc)

```


```{r pad}

# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

#source("../pad.R")
source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")

pad_data
```

```{r data load}

#Voorverwerking van de benthosdata gebeurde in de map G:\\PRJ_SCHELDE\Benthos\Wet weight biomassa en conversies\02-Data.Cleaning.Moneos

benthos23 <- read_excel(paste0(pad_data, "BenthosSpatial2023_klaar.vr.MONEOS.xlsx"), sheet = "Sheet1") 

benthos23.analyt <- benthos23 %>% 
  dplyr::mutate(tidaal = ifelse(str_detect(fysiotoop, "sub"), "subtidaal", "intertidaal"))  %>% 
  dplyr::rename(waterlichaam  = KRWzone) %>% 
    dplyr::mutate(waterlichaam = recode(waterlichaam, "Zeeschelde IV"= "Saliniteitsgradient", "Zeeschelde III"= "Oligohalien", "Zeeschelde II"= "Zoet lang verblijf", "Zeeschelde I"= "Zoet kort verblijf"))
  
# historisch file was corrupt - grote fout in gebeurd, dus terug naar onderstaande file en opnieuw alle correcties doorlopen

benthos2008_heden <- read_excel(paste0(pad_data, "macrobenthos_data_2008_2022NIETAANTELEVEREN.xlsx"), sheet = "macrobenthos") %>% 
  dplyr::mutate(densiteit = round(densiteit, 0)) %>% 
  dplyr::mutate(biomassa2 = ifelse((biomassa == 0|is.na(biomassa)) & densiteit >0 & soort == "Oligochaeta", 0.000114*densiteit+0.166, biomassa)) %>% 
  dplyr::mutate(densiteit2 = ifelse((densiteit == 0|is.na(densiteit)) & biomassa >0 & soort == "Oligochaeta", 5650*biomassa+4610, densiteit)) %>% 
  dplyr::mutate(densiteit = ifelse(soort == "geen", NA, densiteit)) %>% 
   dplyr::mutate(biomassa = ifelse(soort == "geen", NA, biomassa)) %>% 
  dplyr::mutate(biomassa2 = ifelse(soort=="Acari" & densiteit > 0, 0.0314, biomassa)) %>% 
  dplyr::mutate(densiteit2 = ifelse(densiteit2 == 0 & soort !="geen", 314, densiteit2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(densiteit2 <2000 & biomassa == 0, 0.0314, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(soort == "Oligochaeta" & biomassa2 == 0, densiteit2*0.000114+0.166, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(soort %in% c("Nematoda", "geen"), NA, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(biomassa2 == 0 & soort %in% c("Manayunkia aestuarina", "Streblospio sp", "Streblospio benedicti"), densiteit2*0.0000308+0.031, biomassa2)) %>% 
   dplyr::mutate(biomassa2 = ifelse(biomassa2 == 0 & soort %in% c("Collembola", "Onychiuridae"), 0.0314, biomassa2)) %>% 
     dplyr::mutate(biomassa2 = ifelse(is.na(biomassa2) & soort %in% c("Collembola", "Onychiuridae", "Podura aquatica"), 0.0314, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(soort == "Apocorophium lacustre" & biomassa2>5 & densiteit2<1000, densiteit2*0.0000888+0.247, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(str_detect(soort, "orophium|sellus|oreia|ammaru") & biomassa2 == 0, densiteit2*0.0000915+0.128, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(biomassa2 == 0 & str_detect(soort, "Baetis|Chiro"), 0.0314, biomassa2)) %>% 
    dplyr::mutate(densiteit2 = ifelse(soort %in% c("geen"), NA, densiteit2)) %>% 
    dplyr::mutate(biomassa2 = ifelse(soort == "Oligochaeta" & is.na(biomassa2), densiteit2*0.000114+0.166, biomassa2)) %>%
    dplyr::mutate(biomassa2 = ifelse(is.na(biomassa2) & soort %in% c("Manayunkia aestuarina", "Streblospio sp", "Streblospio benedicti", "Marenzelleria neglecta", "Pygospio elegans"), densiteit2*0.0000308+0.031, biomassa2)) %>%
    dplyr::mutate(biomassa2 = ifelse(str_detect(soort, "orophium|sellus|oreia|ammaru") & is.na(biomassa2), densiteit2*0.0000915+0.128, biomassa2)) %>%
    dplyr::mutate(biomassa2 = ifelse(soort == "Ceratopogonidae", densiteit2*0.00005+0.000145, biomassa2))  %>% dplyr::mutate(biomassa2 = ifelse(soort == "Corbicula fluminea" & (biomassa2 == 0.0314 | is.na(biomassa2)), 10, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(soort == "Potamocorbula amurensis" & is.na(biomassa2), 10, biomassa2)) %>% 
  dplyr::mutate(biomassa2 = ifelse(!soort %in% c("geen", "Nematoda") & is.na(biomassa2), 0.0314, biomassa2)) %>% 
  dplyr::mutate(densiteit2 = ifelse(!soort %in% c("geen", "Nematoda") & is.na(densiteit2), 314, densiteit2))


benthos2008_heden %>% 
  dplyr::filter(densiteit2 <100000) %>% 
  ggplot(aes(x=densiteit2, y=biomassa2)) +
  #xlim(0,200000)+
  #ylim(0,60)+
  geom_point()+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

benthos2008_heden %>% 
  #dplyr::filter(densiteit <1500000) %>% 
  ggplot(aes(x=biomassa, y=densiteit)) +
  xlim(0,50)+
  ylim(0,200000)+
  geom_point()+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))

benthos22 <- read_excel(paste0(pad_data, "Benthos2022.xlsx"), sheet = "Sheet1") %>% 
  dplyr::filter(str_detect(soort, "Oligo") & str_detect(CampagneCode, "Sp"))

  ggplot(data=benthos22, aes(x=aantal, y=AFDW)) +
    geom_point()+
  stat_poly_line() +
  stat_poly_eq(use_label(c("eq", "R2")))


%>% 
  dplyr::filter(densiteit == 0)

#gezamenlijke dataframe maken

benthos2008_heden_vs2025 <- benthos2008_heden %>% 
  dplyr::bind_rows(benthos23)

#analyseversie
benthos2008_heden_vs2025.analyt <-  benthos2008_heden_vs2025 %>% 
  dplyr::mutate(tidaal = ifelse(str_detect(fysiotoop, "sub"), "subtidaal", "intertidaal")) %>% 
  dplyr::rename(waterlichaam  = KRWzone) %>% 
    dplyr::mutate(waterlichaam = recode(waterlichaam, "Zeeschelde IV"= "Saliniteitsgradient", "Zeeschelde III"= "Oligohalien", "Zeeschelde II"= "Zoet lang verblijf", "Zeeschelde I"= "Zoet kort verblijf"))


#######################################################################
#locatie details met X,Y Lambert72 MAAR nog geen z berekeningen voor sub stalen!!! Hier ook niet nodig maar wel nog todo.Locatie-info vorige campagnes in de overzichtsfile onder de sheet "locaties"

locaties.23 <- read_excel(paste0(pad_data, "locaties2023_ONAF.xlsx"), sheet = "Sheet1") %>% 
  dplyr::select(locatie = LocatieCode, campagne = CampagneCode, X=Lambert72XBegin, Y=Lambert72YBegin) %>% 
  dplyr::filter(campagne == "Spatial2023") %>% 
  dplyr::mutate(campagne = "spatial 2023")

#checken dat alleen de juiste locaties erin zitten- klopt
unique(str_sort(locaties.23$locatie %>% substr(0,2)))

locaties_alltime <- read_excel(paste0(pad_data, "benthos_data2008-2022_rapportage2024.xlsx"), sheet = "locaties") 
#ook eens checken voor de oude lijst - daarin zitten de Dijle locaties nog als "DI" en "DL", dit is nog uit te zoeken of dat een betekenisvol verschil was of enkel een interpretatiefout - Opletten met dat hier aan te passen - eerst nagaan of deze codering ook voor sediment of andere begeleidende data op deze manier is gebruikt en er geen inconsistenties ontstaan - verder alles ok
unique(str_sort(locaties_alltime$locatie %>% substr(0,2)))

#gezamenlijke locatiefile maken
locaties2008_heden_vs2025 <- locaties_alltime %>% 
  dplyr::bind_rows(locaties.23)


write_xlsx(list(macrobenthos = benthos2008_heden_vs2025, locaties = locaties2008_heden_vs2025),
           path = paste0(pad_data, "Macrobenthos2008_heden_rapportage2025.xlsx"))




outlier.oli <- benthos2008_heden_vs2025.analyt %>% 
  dplyr::filter(Taxa_groep == "Oligochaeta" & jaar == 2020) %>%
  dplyr::filter(densiteit > 500000 & biomassa <10)

```


```{r jaar}

jaar_recent <- 
  benthos23.analyt %>% 
  distinct(jaar) %>% 
  pull(jaar)

```


```{r controleren-fysiotoop}

benthos23.analyt %>% 
  distinct(tidaal, fysiotoop) %>% 
  arrange(tidaal, fysiotoop)

```


##### aantal stalen:

```{r aantal-stalen}

aantal_stalen <- 
  benthos23.analyt %>% 
  distinct(locatie) %>% 
  nrow()

aantal_stalen_waterlichaam_fysiotoop <-
  benthos23.analyt %>%
  distinct(locatie, tidaal, fysiotoop, waterlichaam) %>%  
  count(waterlichaam, tidaal, fysiotoop) %>% 
  knitr::kable()

aantal_stalen_waterlichaam_fysiotoop

```

  - Er zijn `r aantal_stalen` stalen in de dataset voor `r jaar_recent` 
  - het aantal stalen per waterlichaam en fysiotoop:
  
  `r aantal_stalen_waterlichaam_fysiotoop`


##### lege stalen:

```{r lege-stalen}

lege_stalen_waterlichaam_fysiotoop <-
  benthos23.analyt %>%
  dplyr::filter(soort == "geen") %>%  
  count(waterlichaam, tidaal, fysiotoop) %>% 
  knitr::kable()

lege_stalen_waterlichaam_fysiotoop

lege_stalen <-
  benthos23.analyt %>%
  dplyr::filter(soort == "geen") %>% 
  dplyr::select(locatie, soort)


```

  - er zijn `r nrow(lege_stalen)` lege stalen in de dataset
  
  `r knitr::kable(lege_stalen)` 

  
##### aantal soorten:

```{r soorten-recent}
soortendata <-  benthos23.analyt %>%
  dplyr::filter(soort != "geen")

soorten <- 
  soortendata %>%
  dplyr::filter(soort != "geen") %>% 
  distinct(soort)

soorten_per_waterlichaam <-
  soortendata %>% 
  distinct(waterlichaam, soort) %>% 
  count(waterlichaam)

soorten_per_waterlichaam
```


  - Er zijn `r nrow(soorten)` soorten(groepen) aangetroffen in de dataset 
    + `r pull(soorten, soort)`

  - Het aantal soorten per waterlichaam is:
  
  `r knitr::kable(soorten_per_waterlichaam)` 


##### biomassa versus densiteit

```{r biomassa-vs-densiteit, fig.height=4, fig.width=6}

benthos23.analyt %>%
  dplyr::filter(!is.na(biomassa), !is.na(densiteit)) %>%
  #dplyr::filter(Taxa_groep != "Bivalvia") %>% 
  ggplot(aes(biomassa + min(biomassa[biomassa > 0]), densiteit + min(densiteit[densiteit > 0]))) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10()

```


##### data worden samengevoegd met historische gegevens

```{r inlezen-checken-historische-data}

#this has been done in pre-processing phase

```


##### biomassa versus densiteit historische gegevens

```{r biomassa-vs-densiteit_historisch, fig.height=4, fig.width=6}

benthos2008_heden_vs2025.analyt %>% 
  ggplot(aes(densiteit, biomassa)) +
  geom_point()

benthos2008_heden_vs2025.analyt %>% 
  ggplot(aes(densiteit + 1, biomassa + min(biomassa[biomassa > 0], na.rm = TRUE))) +
  geom_point() +
  scale_x_log10() +
  scale_y_log10()

zero_densiteit_nonzero_biomassa <-
  benthos2008_heden_vs2025.analyt %>% 
  filter(densiteit == 0,
         biomassa != 0) %>% 
  select(locatie, waterlichaam, fysiotoop, soort, densiteit, biomassa)

zero_biomassa_nonzero_densiteit <-
  benthos2008_heden_vs2025.analyt %>% 
  filter(densiteit != 0,
         biomassa == 0) %>% 
  select(locatie, waterlichaam, fysiotoop, soort, densiteit, biomassa)

negatieve_biomassa <-
  data_macrobenthos_historisch.2 %>%
  filter(biomassa < 0) %>%
  select(locatie, waterlichaam, fysiotoop, soort, densiteit, biomassa)
  
extreme_biomassa <-
  data_macrobenthos_historisch.2 %>%
  filter(biomassa > 200) %>%
  select(locatie, waterlichaam, fysiotoop, soort, densiteit, biomassa)

```

  - Er zijn `r nrow(zero_densiteit_nonzero_biomassa)` cases van soorten met aantal = 0 en biomassa > 0:

  - Er zijn `r nrow(zero_biomassa_nonzero_densiteit)` cases van soorten met aantal > 0 en biomassa = 0:

<br/>
  
  - Er zijn `r nrow(negatieve_biomassa)` cases van soorten met biomassa < 0
  
    + negatieve biomassa wordt op NA gezet

    `r knitr::kable(negatieve_biomassa)`

<br/>
  
  - Er is één outlier met extreem hoge biomassa
  
    `r knitr::kable(extreme_biomassa)`




```{r samenvoegen recent-historisch}


data_macrobenthos2008_2022.0 <-
  data_macrobenthos_historisch.2 %>% 
  bind_rows(sheetmacrobenthos2022) %>% 
  dplyr::mutate(tidaal = recode(tidaal, "inter" = "intertidaal", "sub"= "subtidaal", "subtidaal" = "subtidaal", "Intertidaal" = "intertidaal")) %>% 
  dplyr::mutate(densiteit = round(densiteit,0)) %>% 
  dplyr::distinct()
                             
# in sommige jaren is er "geen" behouden ook al zijn er andere soorten in het staal gevonden (vaak doordat geen op fractieniveau is toegekend en nadien bij een summarize behouden is) -> wegfilteren
FALSEgeen <- data_macrobenthos2008_2022.0 %>%
  dplyr::distinct() %>% 
  dplyr::group_by(locatie) %>% 
  dplyr::mutate(Nspecs = length(soort)) %>%
  dplyr::ungroup() %>% 
  dplyr::mutate(teveel = ifelse(soort == "geen" & Nspecs > 1, "Y", "N")) %>% 
  dplyr::select(locatie, teveel) %>% 
  dplyr::distinct() %>%
  dplyr::group_by(locatie) %>% 
  dplyr::mutate(dubbels = length(locatie)) %>% 
  dplyr::filter(!(dubbels == 2 & teveel == "N"))
  

data_macrobenthos2008_2022 <- data_macrobenthos2008_2022.0 %>% 
  left_join(FALSEgeen, by = "locatie") %>% 
  dplyr::filter(!(soort == "geen" & teveel == "Y")) %>% 
  dplyr::mutate(waterloop = recode(waterloop, "Zeeschelde I trj_Ml_Gb\n" = "Zeeschelde I trj_Ml_Gb",  "Zeeschelde I tijarm Zwijnaarde\n" = "Zeeschelde I tijarm Zwijnaarde" )) %>% 
  dplyr::select(!c("teveel", "dubbels"))


data_macrobenthos_locaties <- 
  data_macrobenthos_historisch_locaties %>% 
  bind_rows(sheetlocaties2022)


```



##### jaren in de finale dataset:

```{r jaren}

jaren <-
  data_macrobenthos2008_2022 %>% 
  distinct(jaar) %>% 
  pull(jaar)

jaar_range <-
  range(jaren)

```


  - `r jaren`


##### finale data weggeschreven naar:

```{r filenames}

file_name <-
  paste0(paste0(pad_data, "/Nieuwe_datafile/"), "macrobenthos_data_", paste(jaar_range, collapse = "_"), "NIETAANTELEVEREN", ".xlsx")

```

  - `r file_name`


```{r wegschrijven-data, eval=FALSE}

write_xlsx(list(macrobenthos = data_macrobenthos2008_2022,
                locaties = data_macrobenthos_locaties),
           path = file_name)

```



