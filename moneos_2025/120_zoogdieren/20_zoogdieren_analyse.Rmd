---
params:
  hoofdstuk: "120_zoogdieren"
knit: (function(inputFile, ...) {
        rmarkdown::render(inputFile,
                          output_dir = paste0(rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, "/output"))})
title: "MONEOS zoogdieren analyse"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE)
options(knitr.kable.NA = '')
```

```{r libraries}

library(tidyverse)
library(INBOtheme)
library(rprojroot)
library(lubridate)
library(readxl)
library("sf")
library("tmap")
library(kableExtra)
library(leaflet)
conflicted::conflicts_prefer(dplyr::filter)

```

```{r pad}
# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")
pad_geodata <- "I:/GIS/VNSC/"
pad_geodata2 <- "Z:/VNSC/gebiedsindeling_schelde_draft112014/gebiedsindeling_schelde112014/"
```

```{r data}
zoogdier_data_raw <- 
  read_csv(str_c(pad_data, "zoogdier_data_2010_2024.csv"))
```

# beschrijving van de data

-   Per waarneming zijn er `r ncol(zoogdier_data_raw)` informatievelden
    -   `r str_flatten(names(zoogdier_data_raw), collapse = "\n    - ")`
-   In totaal bevat de dataset in `r year(today())` `r nrow(zoogdier_data_raw)` waarnemingen
-   Er zitten data in van `r min(year(zoogdier_data_raw$datum))` tot en met `r max(year(zoogdier_data_raw$datum))`
-   De dataset bevat waarnemingen van `r str_flatten(unique(zoogdier_data_raw$naam_nl), collapse = ", ", last = " en ")`

# Aantal waarnemingen per soort per jaar

```{r aantal waarnemingen}

n_seeings <- 
  zoogdier_data_raw %>% 
  group_by(naam_nl, Jaar = year(datum)) %>% 
  count() %>% 
  spread(key = naam_nl, value = n) %>% 
  mutate_all(~replace(., is.na(.), 0)) 
# Voor rapport wordt andere tabel gemaakt, zie chunk aantal_waarnemingen2
# n_seeings %>% 
#   write_csv(paste0(pad_tabellen, "aantal_waarnemingen.csv"))

kbl(n_seeings, 
             caption = "Aantal waarnemingen per soort per jaar") %>% 
  kable_styling(full_width = FALSE, position = "left")

```

<br/> <br/>

Tot en met rapportage 2021 werden alle waarnemingen opgenomen in de data-analyse. Hieronder wordt de dataset beperkt tot goedgekeurde waarnemingen. Voor bever en otter zijn de verschillen niet groot en/of de trends gelijkaardig, maar voor bruinvis en zeehonden zijn er zeker na 2016 weinig gevalideerde waarnemingen. We beperken de dataset voor de analyse tot gevalideerde data voor bever en otter, voor bruinvis en zeehonden behouden we alle data. De datalevering bevat alle waarnemingen, ook de niet gevalideerde.

```{r aantal goedgekeurde waarnemingen}
n_seeings_goedgekeurd <- 
  zoogdier_data_raw %>% 
  filter(str_detect(status, "Goedgekeurd")) %>% 
  group_by(naam_nl, Jaar = year(datum)) %>% 
  count() %>% 
  spread(key = naam_nl, value = n) %>% 
  mutate_all(~replace(., is.na(.), 0)) 
# wordt niet gebruikt in rapport
# n_seeings_goedgekeurd %>% 
#   write_csv(paste0(pad_tabellen, "aantal_waarnemingen_goedgekeurd.csv"))

kbl(n_seeings_goedgekeurd, 
             caption = "Aantal goedgekeurde waarnemingen per soort per jaar") %>% 
  kable_styling(full_width = FALSE, position = "left")
```

```{r}
# voor bever en otter enkel goedgekeurde waarnemingen
zoogdier_data <- 
  zoogdier_data_raw %>% 
  filter(case_when(naam_nl %in% c("Europese Bever", "Europese Otter") ~ str_detect(status, "Goed"),
                   .default = status == status
                   ))
```

# Bever waarnemingen van sporen tegenover dierwaarnemingen

## Alle data

```{r beverspoordier}
# aantal beverwaarnemingen
bever0 <- zoogdier_data_raw[zoogdier_data_raw$naam_nl == "Europese Bever",]
nb0 <- nrow(bever0)
# bever-spoorwaarnemingen
bever0_spoor <- bever0[(bever0$gedrag %in% c("bezet nest", "sporen")|
                  bever0$methode %in% c( "andere sporen", "prenten", "sporen", 
                                        "sporenbed", "uitwerpselen", 
                                        "verlaten nest", "vraatsporen")),]
nbsp0 <- nrow(bever0_spoor)
# niet duidelijk of het een waarneming van een dier of van een spoor is
bever0_onbepaald <- bever0[(bever0$gedrag %in% c("onbekend", "overige") &
                    bever0$methode %in% c( "NULL", "onbekend")) ,]
nbonb0 <- nrow(bever0_onbepaald)
# bever dierwaarnemingen
bever0_dier <- 
  bever0 %>% 
  anti_join(bever0_onbepaald, by = c("unieke_id")) %>% 
  anti_join(bever0_spoor, by = c("unieke_id"))
nbdier0 <- nrow(bever0_dier)

# niet beverwaarnemingen
niet_bever0 <- zoogdier_data_raw[zoogdier_data_raw$naam_nl != "Europese Bever",]
# aantal niet-beverwaarnemingen
nnb0 <- nrow(niet_bever0)
niet_bever0_spoor <- 
  niet_bever0[(niet_bever0$gedrag %in% c("bezet nest", "sporen")|
       niet_bever0$methode %in% c("andere sporen", "prenten", "sporen", 
                                 "sporenbed", "uitwerpselen", "verlaten nest",
                                 "vraatsporen")) ,]
nspnb0 <- nrow(niet_bever0_spoor)
```

In totaal zijn er `r nb0` beverwaarnemingen in de dataset, waarvan `r nbsp0` geen waarnemingen zijn van dieren, maar wel van sporen of een burcht (`r round(100*nbsp0/nb0, 0)` %). Bij de andere soorten nemen niet-dierwaarnemingen slechts `r round(100*nspnb0/nnb0, 0)` % in.

```{r sporen}
cap <- "Waarnemingen van beversporen"
count(bever0_spoor, methode, gedrag) %>% 
  kbl(caption = cap) %>% 
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"))
```

Tabel \@ref(tab:sporen) geeft alle combinaties van methode en gedrag die we bestempelen als niet-dierwaarnemingen. Er zitten enkele exotische combinaties tussen (andere sporen-in kolonie anders, prenten-zwemmend, sporenbed-foeragerend); het aantal dergelijke waarnemingen is wel erg laag.

Tabel \@ref(tab:onbepaald) geeft de combinaties van methode en gedrag waaruit we niet kunnen afleiden of het al dan niet om een effectieve dierwaarneming gaat.

```{r onbepaald}
cap <- "Waarnemingen van bever waarvan niet geweten is of het effectief om dierwaarnemingen dan wel om sporen of burchten gaat"
count(bever0_onbepaald, methode, gedrag) %>% 
  kbl(caption = cap) %>% 
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"))
```

Tabel \@ref(tab:dier) geeft de combinaties van methode en gedrag die we interpreteren als effectieve dierwaarnemingen. Ook in deze lijst komt wat exotisme (nestkast-onbekend, bodemval-(nabij) nest/burcht, ... ) voor.

```{r dier}
cap <- "Effectieve waarnemingen van bever"
count(bever0_dier, methode, gedrag) %>% 
  kbl(caption = cap) %>% 
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"))
```

## Goedgekeurde beverwaarnemingen

We doen nog even hetzelfde voor goedgekeurde beverwaarnemingen (en otterwaarnemingen)

```{r beverspoordier goedgek}
# aantal goedgekeurde beverwaarnemingen
bever <- zoogdier_data[zoogdier_data$naam_nl == "Europese Bever" &
                         str_detect(zoogdier_data$status, "Goedg"),]
nb <- nrow(bever)
# bever-spoorwaarnemingen
bever_spoor <- bever[(bever$gedrag %in% c("bezet nest", "sporen")|
                  bever$methode %in% c( "andere sporen", "prenten", "sporen", 
                                        "sporenbed", "uitwerpselen", 
                                        "verlaten nest", "vraatsporen")),]
nbsp <- nrow(bever_spoor)
# niet gespecifieerde waarnemingen
bever_onbepaald <- bever[(bever$gedrag %in% c("onbekend", "overige") &
                    bever$methode %in% c( "NULL", "onbekend")) ,]
nbonb <- nrow(bever_onbepaald)
# bever dierwaarnemingen
bever_dier <- 
  bever %>% 
  anti_join(bever_onbepaald, by = c("unieke_id")) %>% 
  anti_join(bever_spoor, by = c("unieke_id"))
nbdier <- nrow(bever_dier)

# niet beverwaarnemingen
niet_bever <- zoogdier_data[zoogdier_data$naam_nl != "Europese Bever",]
# aantal niet-beverwaarnemingen
nnb <- nrow(niet_bever)
niet_bever_spoor <- 
  niet_bever[(niet_bever$gedrag %in% c("bezet nest", "sporen")|
       niet_bever$methode %in% c("andere sporen", "prenten", "sporen", 
                                 "sporenbed", "uitwerpselen", "verlaten nest",
                                 "vraatsporen")) ,]
nspnb <- nrow(niet_bever_spoor)
```

```{r sporengoedg}
cap <- "Goedgekeurde waarnemingen van beversporen"
count(bever_spoor, methode, gedrag) %>% 
  kbl(caption = cap) %>% 
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"))
```

Er zitten bij de goedgekeurde waarnemingen nog steeds enkele exotische combinaties ("andere sporen"-"in kolonie anders", "prenten"-"zwemmend", "sporenbed"-"foeragerend").

```{r onbepaaldgoedgekeurd}
cap <- "Goedgekeurde waarnemingen van bever waarvan niet geweten is of het effectief om dierwaarnemingen dan wel om sporen of burchten gaat"
count(bever_onbepaald, methode, gedrag) %>%  
  kbl(caption = cap) %>% 
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"))
```

```{r diergoedg}
cap <- "Goedgekeurde effectieve waarnemingen van bever"
count(bever_dier, methode, gedrag) %>%  
  kbl(caption = cap) %>% 
  kable_styling(bootstrap_options = c("condensed", "striped", "hover"))
```

Onder de goedgekeurde beverwaarnemingen slaan ook `r round(100*nbsp/nb, 0)` % op sporen (`r nbsp` waarnemingen op een totaal van `r nb`). <br/> <br/>

# Aantal waarnemingen per soort per jaar (exclusief waarnemingen van sporen)

```{r aantalwaarnemingen2}
n_seeings <- 
  zoogdier_data %>% # voor otter en bever enkel geodgekeurde
  mutate(Jaar = year(datum)) %>% 
  summarise(.by = c(naam_nl, Jaar), n = n()) %>% 
  pivot_wider(names_from = naam_nl, names_sort = TRUE,
              values_from = n, values_fill = 0) %>% 
   arrange(Jaar)
cap <- "Aantal waarnemingen per soort per jaar in de hier geanalyseerde dataset"
n_seeings %>% 
  kbl(caption = cap) %>% 
  kable_styling(full_width = FALSE, position = "left",
                bootstrap_options = c("condensed", "striped"))
```

```{r aantalzichtwaarnemingen, include=FALSE}
(n_bever_zichtwaarneming <- 
  bever_dier %>% 
  count(naam_nl, Jaar = year(datum)) %>% 
  pivot_wider(names_from = naam_nl, values_from = n))
n_bever_zichtwaarneming %>% 
  write_csv(paste0(pad_tabellen, "/n_bever_zichtwaarneming.csv"))

cap <- "Aantal goedgekeurde zichtwaarnemingen van bever per jaar (exclusief waarnemingen van sporen)."
n_bever_zichtwaarneming %>% 
  kbl(caption = cap, align = "lc") %>% 
  kable_styling(position = "left") %>% 
  column_spec(1:2, width = "7cm")
```

<br/> <br/>

```{r aantalzichtwaarnemingen2}
n_waarnemingen <- 
  n_seeings %>% 
  inner_join(n_bever_zichtwaarneming, by = ("Jaar")) %>% 
  mutate(`Europese Bever` = paste0(`Europese Bever.x`, " (", 
                                   `Europese Bever.y`, ")")) %>% 
  select(Jaar, `Europese Bever`, `Europese Otter`, `Gewone Bruinvis`, `Gewone Zeehond`,
         `Grijze Zeehond`, `Zeehond onbekend`)
n_waarnemingen %>% 
  write_csv(paste0(pad_tabellen, "aantal_waarnemingen.csv"))
cap <- "Aantal waarnemingen per soort per jaar, voor bever staat het aantal zichtwaarnemingen van dieren tussen hakkejes. Voor bever en otter enkel goedgekeurde waarnemingen, voor de overige soorten alle waarnemigen."
n_waarnemingen %>% 
  kbl(caption = cap, align = "lcccccc") %>% 
  kable_styling(full_width = FALSE, position = "left")
```

<br/> <br/>

```{r aantalindividuen}
n_indiv <- 
  zoogdier_data %>% 
  filter(!(gedrag %in% c("sporen", "bezet nest")),
         !(methode %in% c( "andere sporen", "prenten", "sporen", "sporenbed",
                           "uitwerpselen", "verlaten nest", "vraatsporen"))) %>%
  mutate(Jaar = year(datum)) %>%
  summarise(.by = c(naam_nl, Jaar), n = sum(aantal))
# categorieën in veld gedrag zijn van naam gewijzigd tov 2022
n_indiv_death <- 
  zoogdier_data %>% 
  filter(gedrag %in% c("dood", "slachtoffer verdrinking", "slachtoffer verkeer")) %>% 
  mutate(Jaar = year(datum)) %>%
  summarise(.by = c(naam_nl, Jaar), n_death = sum(aantal))
n_indiv_with_dead <- 
  n_indiv %>% 
  left_join(n_indiv_death, by = c("naam_nl", "Jaar")) %>% 
  mutate(string = ifelse(is.na(n_death), 
                         as.character(n), 
                         paste0(n, " (", n_death, "†)"))) %>% 
  select(Jaar, naam_nl, string) %>% 
  pivot_wider(names_from = naam_nl, names_sort = TRUE, 
              values_from = string, values_fill = "0") %>% 
  arrange(Jaar)

n_indiv_with_dead %>% 
  write_csv(paste0(pad_tabellen, "/aantal_ind.csv"))

cap <- "Aantal ingevoerde individuen per jaar (exclusief waarnemingen van sporen). Voor bever en otter enkel goedgekeurde waarnemingen, voor de overige soorten alle waarnemigen."
n_indiv_with_dead %>% 
  kbl(align = "lccccccc",
      caption = cap) %>% 
  kable_styling(full_width = FALSE, position = "left")
```

<br/> <br/>

```{r 120_fig_aantal_indiv}
fig_1 <- 
  n_indiv %>% 
  complete(naam_nl, Jaar, fill = list(n = 0)) %>% # fill out missing years
  mutate(facet = case_when(naam_nl %in% c("Europese Bever", "Gewone Bruinvis") ~ 
                     "Bever en bruinvis",
                   .default = "Otter en zeehonden")) %>%  # for facetting of graph
  ggplot(aes(x = Jaar, y = n, color = str_to_sentence(naam_nl))) +
  geom_line(lwd = 1) +
  scale_x_continuous(breaks = seq(2010, 2023, by =1)) +
  theme(axis.title = element_blank(),
        legend.title = element_blank(),
        legend.position = "bottom") +
  facet_wrap(facets = ~facet, scales = "free") +
  scale_x_continuous(breaks = seq(2010, 2024, by = 2))

fig_1
ggsave(paste0(pad_figuren, "120_fig1_aantal_ind.jpg"), width = 8, height = 4)
```

# Verspreidingskaartjes

Onderstaande verspreidingskaartje zijn gebaseerd op de gevalideerde waarnemingen van bever en otter en alle waarnemingen van bruinvis, gewone zeehond, grijze zeehond en zeehon-onbekend in waarnemingen.be.

```{r geodata, include=FALSE}
utm1 <- st_read(str_c(pad_geodata, "NOPplus_UTM1.shp"))
utm1_c <- st_centroid(utm1) %>% 
  select(-c(Shape_Leng, Shape_Area))
Schelde_boundaries <- st_read(str_c(pad_geodata2, "Boundaries.shp"))
pad_geodata
pad_geodata2
getijrivieren <- st_read(str_c(pad_geodata2, "getij_afh_zones.shp"))
buurlanden <- st_read(str_c(pad_geodata2, "buurlanden.shp"))
```

```{r kaartdata}
(soort_nUTM1 <- 
  zoogdier_data %>% 
  filter(str_detect(status, "Goedg")) %>% 
  group_by(Jaar = year(datum), naam_nl) %>% 
  summarise(n = n_distinct(utm1),
            .groups = "drop"))
write_csv(soort_nUTM1, file = str_c(pad_data, "soort_nUTM1.csv"))
```

```{r mapbackground}
bbox <- st_bbox(utm1_c) + c(-500, -500, 500, 500)
map_basis <- 
  tm_shape(buurlanden, bbox = bbox) + tm_borders() + tm_fill(col = "lightyellow") +
  tm_shape(Schelde_boundaries) + 
    tm_borders(col = "blue", fill_alpha = 0.5) +
    tm_fill(fill = "dodgerblue") +
   tm_shape(getijrivieren) + tm_lines(col = "blue", col_alpha = 0.5) +
  tm_shape(utm1) +
    tm_borders(lwd = 0.25, col = "grey30")
```

```{r maps-nieuw-valid, eval=FALSE}
# make list of tibbles each tibble has unique naam_nl en Jaar, voor gevalideerde waarnemingen van bever en otter.
zoogd_grouped <- 
  zoogdier_data %>% 
  mutate(Jaar = year(datum), TAG = utm1,
         naam_nl = str_to_sentence(naam_nl)) %>% 
  summarise(.by = c(naam_nl, Jaar, TAG),
            aantal = sum(aantal), radius = sum(aantal)^0.5) %>% # aantal waarnemingen per UTM1-hok, soort en jaar
  group_by(naam_nl, Jaar)

# make list of tibbles for each group in zoogd_grouped; each tibble gives the amount of seeings for a certain year-specias
utm_n_list <-
  zoogd_grouped%>% 
  group_split(.keep = TRUE)
groupkeys <-  # get names of eacht tibble ("naam-nl_jaar")
  group_keys(zoogd_grouped) %>% 
    mutate(naam_jaar = str_c(naam_nl, " ", Jaar)) %>% 
    select(naam_jaar)
names(utm_n_list) <- groupkeys$naam_jaar # names tiblles in list

# make list of simple features
utm_n_list2 <- map(utm_n_list, merge, utm1_c) # merge to utm centroid
utm_n_list_sf <- map(utm_n_list2, st_as_sf, sf_column_name = "geometry") # make sf
# utm_n_list_sf[[16]][[2]][1]

# function to make list of tmaps
mapf <- function(x){
  title <- str_c(x[[2]][1], " ", x[[3]][1])
  m <- 
    map_basis + 
    tm_shape(x) + 
    tm_symbols(fill = "red", col = "black",
               size = "radius", 
               size.scale = 
                 tm_scale_continuous(limits = c(0,7), 
                                     outliers.trunc = c(FALSE, TRUE), 
                                     ticks = c(1, 2, 3, 5, 7),
                                     labels = c("1", "4", "9", "49", ">=49")), 
                 size.legend = tm_legend(title = title,
                                         bg.color = "white", bg.alpha = 0.5,
                                         position = tm_pos_in(pos.h = "right"), 
                                         title.size = 1.2, text.size = 0.8)
                 )
  return(m)
}

# test
# mapf(utm_n_list_sf[[16]])
# mapf(utm_n_list_sf[["Europese Otter_2012"]])

utm_tmmap_list <- map(utm_n_list_sf, mapf) # make tmap objects

utm_tmmap_list[[2]]
utm_tmmap_list[[23]]
utm_tmmap_list[["Europese Bever_2024"]]
# utm_tmmap_list[["Grijze Zeehond_2019"]]

# save all maps 
for(x in names(utm_tmmap_list)){
  a <- utm_tmmap_list[[x]]
  tmap_save(a, filename = str_c(pad_figuren, x, ".png"))
}
# utm_tmmap_list[["Europese Bever_2020"]] %>%
#   tmap_save(filename = str_c(pad_figuren, "Europese Bever_2020", ".png"))
# hieronder een poging om bovenstaand for-loop met purrr::map te doen, maar deze code (allebeid) bewaart herhaaldelijk "Zeehond onbekend_2021"
# map(utm_tmmap_list[], tmap_save, filename = str_c(pad_figuren, x, ".png"))
# map(utm_tmmap_list, tmap_save, filename = str_c(pad_figuren, x, ".png"))

```

```{r mapbever2019, fig.cap="Aantal waarnemingen van Europese bever per UTM-km-hok in 2019."}
knitr::include_graphics(paste0(pad_figuren, "Europese Bever_2019.png"))
```

```{r mapbever2020, fig.cap="Aantal waarnemingen van Europese bever per UTM-km-hok in 2020."}
knitr::include_graphics(paste0(pad_figuren, "Europese Bever_2020.png"))
```

```{r mapbever2021, fig.cap="Aantal waarnemingen van Europese bever per UTM-km-hok in 2021."}
knitr::include_graphics(paste0(pad_figuren, "Europese Bever_2021.png"))
```

```{r mapbever2022, fig.cap="Aantal waarnemingen van Europese bever per UTM-km-hok in 2022."}
knitr::include_graphics(paste0(pad_figuren, "Europese Bever_2022.png"))
```

```{r mapbever2023, fig.cap="Aantal waarnemingen van Europese bever per UTM-km-hok in 2023."}
knitr::include_graphics(paste0(pad_figuren, "Europese Bever_2023.png"))
```

```{r mapbever2024, fig.cap="Aantal waarnemingen van Europese bever per UTM-km-hok in 2023."}
knitr::include_graphics(paste0(pad_figuren, "Europese Bever_2024.png"))
```

```{r bezette utm-hokken}
# for one species
# a <- soort_nUTM1 %>%
#   filter(naam_nl == "Europese Bever") %>%
#   ggplot(aes(x = Jaar, y = n)) +
#   geom_point() +
#   geom_line() +
#   labs(y = "aantal km-hokken met waarnemingen") +
#   scale_x_continuous(breaks = seq(2010, 2024, by = 2))
# a %>% ggsave(filename = paste0(pad_figuren, "bever_utm.png"))

# for all species
plot1 <- function(x){
  ggplot(data = x, aes(x = Jaar, y = n)) +
  geom_point() +
  geom_line() +
  labs(y = "aantal km-hokken met waarnemingen") +
  scale_x_continuous(breaks = seq(2010, 2024, by = 2))}

# group by species
soort_nUTM1_grouped <- 
  soort_nUTM1  %>% 
  group_by(naam_nl)
# make list with tibbles for each species
soort_nUTM1_list <-
  soort_nUTM1_grouped%>% 
  group_split(.keep = TRUE)
# add names 
groupkeys <-  # get names for each tibble ("naam-nl")
  group_keys(soort_nUTM1_grouped)
names(soort_nUTM1_list) <- group_keys(soort_nUTM1_grouped)$naam_nl
# make list of ggplots
utm_year_plot_list <- map(.x = soort_nUTM1_list, .f = plot1)
utm_year_plot_list[["Europese Bever"]]
# save plots
map2(.x =utm_year_plot_list,
     .y =names(utm_year_plot_list),
     ~ ggsave(
       filename = str_c(pad_figuren, "n_utm", .y, ".png"),
       plot = .x))
```

```{r recente-utm}
bever_evol <- 
  utm1 %>% 
  left_join(bever, by= c("TAG" = "utm1")) %>% 
  filter(naam_nl == "Europese Bever") %>% 
  mutate(Jaar = year(datum)) %>% 
  group_by(TAG) %>% 
  summarise(EersteJaar = min(Jaar), AantalJaar = n_distinct(Jaar)) %>% 
  mutate(EersteJaarf = factor(EersteJaar, levels = c(2010:2024)),
         EersteJaarCat = 
           case_when(EersteJaar < 2014 ~ "2010-2013",
                     EersteJaar < 2018 ~ "2014-2017",
                     EersteJaar < 2022 ~ "2018-2021",
                     .default = as.character(EersteJaar))) %>% 
  arrange((EersteJaar))
pal <- cols4all::c4a("-brewer.yl_or_br", n = 6)
(kolononisatie_fig <- 
  map_basis +
  tm_shape(bever_evol) + 
  tm_fill(fill = "EersteJaarCat",
          fill.scale = 
            tm_scale_categorical(values = pal,
                                 labels = 
                                   c("2010-2013", "2014-2017", "2018-2021", 
                                     "2022", "2023", "2024")), 
          fill.legend = tm_legend(position = tm_pos_in("left"),
                                  title = "Eerste waarnemingsjaar")
          ))
tmap_save(tm = kolononisatie_fig, 
          filename = paste0(pad_figuren, "bever_kolonisatie.png"))
```

```{r utm-evol, include=FALSE, eval=FALSE}
utm1 %>% 
  st_join(bever_evol, by = c("TAG" = "utm1")) %>% 
  filter(!is.na(EersteJaar))

pal <- cols4all::c4a("brewer.yl_or_br", n = 15)
map_basis +
  (bever_evol %>% 
  filter(!is.na(EersteJaar)) %>% 
  tm_shape() + 
  tm_fill(fill = "EersteJaarf", 
          fill.scale = 
            tm_scale_categorical(values = pal, labels = c(2010:2024)),
          fill.legend = tm_legend(position = tm_pos_out("right"))))
```

# Verspreidingskaartjes otter

```{r mapotter2021, fig.cap="Aantal waarnemingen van Europese otter per UTM-km-hok in 2021."}
knitr::include_graphics(paste0(pad_figuren, "Europese Otter_2021.png"))
```

```{r mapotter2022, fig.cap="Aantal waarnemingen van Europese otter per UTM-km-hok in 2022."}
knitr::include_graphics(paste0(pad_figuren, "Europese Otter_2022.png"))
```

```{r mapotter2023, fig.cap="Aantal waarnemingen van Europese otter per UTM-km-hok in 2023."}
knitr::include_graphics(paste0(pad_figuren, "Europese Otter_2023.png"))
```

```{r mapotter2024, fig.cap="Aantal waarnemingen van Europese otter per UTM-km-hok in 2020."}
knitr::include_graphics(paste0(pad_figuren, "Europese Otter_2024.png"))
```

Bij merendeel van de waarnemingen is methode niet ingevuld. Waarschijnlijk zijn meeste waarnemingen van Joris Everaert met cameraval, maar is dit uit veiligheidsoverwegingen niet ingegeven.

```{r methode}
zoogdier_data %>% 
  filter(str_detect(status, "Goedg"),
         naam_nl == "Europese Otter") %>% 
  count(Jaar = year(datum), methode)
```

```{r bezette utm-hokken_otter}
soort_nUTM1 %>% 
  filter(naam_nl == "Europese Otter") %>% 
  ggplot(aes(x = Jaar, y = n)) +
  geom_point() +
  geom_line() +
  labs(y = "aantal bezette km-hokken") +
  scale_x_continuous(breaks = seq(2010, 2022, by = 2)) +
  scale_y_continuous(breaks = seq(0, 14, by = 5), minor_breaks = seq(0, 14, by =2))
ggsave(filename = paste0(pad_figuren, "otter_utm.png"))
```

# Gewone zeehond

```{r tabel gewone zeehond}
GewoneZeehond2024 <- 
  zoogdier_data %>% 
  filter(naam_nl == "Gewone Zeehond",
         year(datum) == 2024) %>% 
  select(Datum = datum, Aantal = aantal, Gedrag = gedrag, Gebied = gebied, 
         Gemeente = gemeente, Deelgemeente = deelgemeente) %>% 
  arrange(Datum) 
GewoneZeehond2024 %>% 
  kbl(align = "lcllll", caption = "Tabel XX: overzicht van alle waarnemingen van gewone zeehond in 2024 in de Zeeschelde en haar bijrivieren.") %>% 
  kable_styling(full_width = TRUE, bootstrap_options = c("condensed")) %>% 
  column_spec(1, width = "2.5cm") %>% 
  column_spec(2, width = "1.5cm") %>% 
  column_spec(3, width = "2.5cm")

GewoneZeehond2024 %>%
  write_csv(paste0(pad_tabellen, "/zeehond2024.csv"))
```

<br/>

```{r make sf}
# zeehond_data_sf <- 
#   zoogdier_data %>% 
#   filter(naam_nl == "Gewone Zeehond",
#          year(datum) == 2022) %>% 
#   select(datum, aantal, gedrag, methode, x, y) %>% 
#   st_as_sf(coords = c("x", "y"), crs =31370) %>% 
#   st_transform(crs = 4326)
```

```{r map zeehond}
# leaflet() %>% 
  # addTiles() %>% 
  # addCircleMarkers(data = zeehond_data_sf,
  #                  radius = 3, label = ~datum)
```

<br/> <br/>

# Grijze zeehond

```{r tabel grijze zeehond}
GrijzeZeehond2024 <- 
  zoogdier_data %>% 
  filter(naam_nl == "Grijze Zeehond",
         year(datum) == 2024) %>% 
  select(Datum = datum, Aantal = aantal, Gedrag = gedrag, Gebied = gebied, 
         Gemeente = gemeente, Deelgemeente = deelgemeente) %>% 
  arrange(Datum) 
GrijzeZeehond2024 %>% 
  kbl(align = "lcllll", caption = "Tabel XX: overzicht van alle waarnemingen van grijze zeehond in 2024 in de Zeeschelde en haar bijrivieren.") %>% 
  kable_styling(full_width = TRUE, bootstrap_options = c("condensed")) %>% 
  column_spec(1, width = "2.5cm") %>% 
  column_spec(2, width = "1.5cm") %>% 
  column_spec(3, width = "2.5cm")

GrijzeZeehond2024 %>%
  write_csv(paste0(pad_tabellen, "/grijzezeehond2024.csv"))
```

<br/>

```{r make sf2}
# grijzezeehond_data_sf <- 
#   zoogdier_data %>% 
#   filter(naam_nl == "Grijze Zeehond",
#          year(datum) == 2022) %>% 
#   select(datum, aantal, gedrag, methode, x, y) %>% 
#   st_as_sf(coords = c("x", "y"), crs =31370) %>% 
#   st_transform(crs = 4326)
```

```{r map grijzezeehond}
# leaflet() %>% 
#   addTiles() %>% 
#   addCircleMarkers(data = grijzezeehond_data_sf,
#                    radius = 3, label = ~datum)
```

<br/>

```{r tabel bruinvis}
Bruinvis2024 <- 
  zoogdier_data %>% 
  filter(naam_nl == "Gewone Bruinvis",
         year(datum) == 2024) %>% 
  select(Datum = datum, Aantal = aantal, Gedrag = gedrag, Gebied = gebied, 
         Gemeente = gemeente, Deelgemeente = deelgemeente) %>% 
  arrange(Datum) 
Bruinvis2024 %>% 
  kbl(align = "lcllll", caption = "Tabel XX: overzicht van alle waarnemingen van bruinvis in 2024 in de Zeeschelde en haar bijrivieren.") %>% 
  kable_styling(full_width = TRUE, bootstrap_options = c("condensed")) %>% 
  column_spec(1, width = "2.5cm") %>% 
  column_spec(2, width = "1.5cm") %>% 
  column_spec(3, width = "2.5cm")

Bruinvis2024 %>%
  write_csv(paste0(pad_tabellen, "/bruinvis2024.csv"))
```

<br/>

```{r make sf3}
# bruinvis_data_sf <- 
#   zoogdier_data %>% 
#   filter(naam_nl == "Gewone Bruinvis",
#          year(datum) == 2022) %>% 
#   select(datum, aantal, gedrag, methode, x, y) %>% 
#   st_as_sf(coords = c("x", "y"), crs =31370) %>% 
#   st_transform(crs = 4326)
```

```{r map bruinvis}
# leaflet() %>% 
#   addTiles() %>% 
#   addCircleMarkers(data = bruinvis_data_sf,
#                    radius = 3, label = ~datum)
```

<br/>
