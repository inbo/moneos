---
params:
  hoofdstuk: "090_vissen"
knit: (function(inputFile, encoding) {
        rmarkdown::render(inputFile,
                          encoding=encoding,
                          output_dir = paste0(rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, "/output"))})
title: "analyse visdata ankerkuil"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

```


```{r libraries}

library(tidyverse)
library(lubridate)
library(readxl)
library(writexl)
# library(yarrr)
library(wesanderson)
library(gridExtra)
library(cowplot)

library(INBOtheme)
library(inbodb)

library(rprojroot) ## workaround pad

```


```{r pad}

# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")

```


```{r excel sheets}

sheets <- NULL

```


```{r EMSE tabellen}

sleutelsoorten_EMSE <-
  read_xlsx(str_c(pad_data, "sleutelsoorten EMSE.xlsx"))

func_groepen_EMSE <-
  read_xlsx(str_c(pad_data, "functionele groepen.xlsx")) %>% 
  mutate(Soort = str_to_lower(Soort))

levels_indeling <-
  c("Mar/Est -- Benth", "Mar/Est -- Omn", "Mar/Est -- Pisc", "Mar/Est -- Plankt",
    "Diadr -- Benth", "Diadr -- Omn", "Diadr -- Pisc",
    "Zoetw -- Benth", "Zoetw -- Omn", "Zoetw -- Pisc")

locatie_scheldezone <- 
  tibble(locatie = c("Doel", "Antwerpen", "Steendorp", "Branst"),
         scheldezone = c("SG", "SG", "OH", "ZL"))

levels_scheldezone <-
  c("SG", "OH", "ZL", "ZK")

levels_scheldezone_full <-
  c(SG = "saliniteitsgradient", OH = "oligohalien", ZL = "zoet lang", ZK = "zoet kort")
  # c("saliniteitsgradient", "oligohalien", "zoet lang", "zoet kort")

# levels_scheldezone_refactor <- c(SG = "saliniteitsgradient", OH = "oligohalien", ZL = "zoet lang", ZK = "zoet kort")

```

##### datasets voor aantal en gewicht:

<!-- -   *G:/Mijn Drive/INBODATA/PROJECTEN/PRJ_SCHELDE/VNSC/Rapportage_INBO/2022/090_vissen/data/ankerkuil_aantallen_2012_2021.csv* -->
<!-- -   *G:/Mijn Drive/INBODATA/PROJECTEN/PRJ_SCHELDE/VNSC/Rapportage_INBO/2022/090_vissen/data/ankerkuil_gewicht_2012_2021.csv* -->

-   *G:/Mijn Drive/INBODATA/PROJECTEN/PRJ_SCHELDE/VNSC/Rapportage_INBO/2022/090_vissen/data/ankerkuil_VLIZ_2012_2021.csv*

```{r inlezen-data}

soortenlijst <- 
  read_xlsx(str_c(pad_data, "soorten_Zeeschelde.xlsx"), sheet = "EMSE")

# ankerkuil_aantal1 <- 
#   read_delim(paste0(pad_data, "ankerkuil_aantallen_2012_2021.csv"),
#              delim = ";")
# 
# ankerkuil_gewicht1 <- 
#   read_delim(paste0(pad_data, "ankerkuil_gewicht_2012_2021.csv"),
#              delim = ";")

ankerkuil_aantal <- 
  read_xlsx(str_c(pad_data, "ankerkuil_Zeeschelde_VLIZ_2012_2021.xlsx"),
            sheet = "campagnes") %>% 
  select(ID_afvissing, locatie, datum, jaar, seizoen, getijde, volume) %>% 
  left_join(read_xlsx(str_c(pad_data, "ankerkuil_VLIZ_2012_2021.xlsx"),
                      sheet = "locaties") %>% 
              select(locatie, OMES, EMSE_niveau3)) %>% 
  left_join(read_xlsx(str_c(pad_data, "ankerkuil_VLIZ_2012_2021.xlsx"),
                      sheet = "aantallen")) %>% 
  select(-ID_afvissing, -datum, -getijde) %>% 
  group_by(locatie, OMES, EMSE_niveau3, jaar, seizoen) %>% 
  summarise(across(everything(), ~sum(., na.rm = TRUE)))

ankerkuil_gewicht <- 
  read_xlsx(str_c(pad_data, "ankerkuil_VLIZ_2012_2021.xlsx"),
            sheet = "campagnes") %>% 
  select(ID_afvissing, locatie, datum, jaar, seizoen, getijde, volume) %>% 
  left_join(read_xlsx(str_c(pad_data, "ankerkuil_VLIZ_2012_2021.xlsx"),
                      sheet = "locaties") %>% 
              select(locatie, OMES, EMSE_niveau3)) %>% 
  left_join(read_xlsx(str_c(pad_data, "ankerkuil_VLIZ_2012_2021.xlsx"),
                      sheet = "gewicht")) %>% 
  select(-ID_afvissing, -datum, -getijde) %>% 
  group_by(locatie, OMES, EMSE_niveau3, jaar, seizoen) %>% 
  summarise(across(everything(), ~sum(., na.rm = TRUE)))

data_ankerkuil <- 
  ankerkuil_aantal %>% 
  pivot_longer(cols = `tiendoornige stekelbaars`:last_col(),
               names_to = "soort",
               values_to = "aantal") %>%
  left_join(ankerkuil_gewicht %>% 
              select(-volume) %>% 
              pivot_longer(cols = `tiendoornige stekelbaars`:last_col(),
                           names_to = "soort",
                           values_to = "gewicht")) %>% 
  mutate(gewicht = if_else(aantal == 0, 0, gewicht),
         seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar")),
         locatie = factor(locatie, levels = c(c("Doel", "Antwerpen", "Steendorp", "Branst")))) %>%
  # filter(!str_detect(soort, "garnaal|garnalen|gammarus|krab|kreeft|inktvis|octopus|zeekat")) %>%
  group_by(soort) %>% 
  mutate(anyN = any(aantal > 0)) %>% 
  ungroup() %>% 
  filter(anyN) %>% 
  select(-anyN) %>% 
  left_join(soortenlijst %>% 
              select(-opmerking))


vroegste_jaar <-
  data_ankerkuil %>% 
  pull(jaar) %>% 
  min()

laatste_jaar <-
  data_ankerkuil %>% 
  pull(jaar) %>% 
  max()

mult_kub <- 1000
prop_lim <- 0.1

```


```{r kleurcodes soorten}

set.seed(90)

my_pal_wes <- 
  c(wes_palette("Darjeeling1", 
                type = "continuous", 
                n = length(unique(soortenlijst$soort))) %>% 
      unname() %>%
      sample(), 
    "darkslategrey")
names(my_pal_wes) <-
  c(unique(soortenlijst$soort), "rest")

```


```{r enkel-vissen}

soorten <- 
  data_ankerkuil %>% 
  distinct(soort) %>% 
  pull(soort)

# soorten_invertebraten <-
#   c("wolhandkrab", "grijze garnalen", "steurgarnalen", "gammarus", "noordzeekrab", "japanse steurgarnaal", "penseelkrab")

soorten_invertebraten <-
  soorten %>% 
  keep(~ str_detect(., "garnaal|garnalen|gammarus|krab|kreeft|inktvis|octopus|zeekat")) 

soorten_vis <-
  setdiff(soorten, soorten_invertebraten) %>% 
  {.[order(.)]}

data_ankerkuil <- 
  data_ankerkuil %>% 
  filter(soort %in% soorten_vis)

```


```{r aantal-en-gewicht-per-kub}

data_ankerkuil <- 
  data_ankerkuil %>% 
  mutate(aantal_per_kub = aantal/volume,
         gewicht_per_kub = gewicht/volume)

```


```{r indeling EMSE rapportage}

data_ankerkuil %>% 
  distinct(salgroep)

data_ankerkuil %>% 
  distinct(dieet)

data_ankerkuil <- 
  data_ankerkuil %>% 
  mutate(salgroep_detail = salgroep,
         salgroep = case_when(
           salgroep_detail %in% c("mariene migranten", "mariene dwaalgasten", "estuarien residenten") ~ "mariene en estuariene soorten",
           salgroep_detail %in% c("diadromen") ~ "diadrome soorten",
           salgroep_detail %in% c("zoetwatersoorten") ~ "zoetwatersoorten"
         ),
         indeling = case_when(
           salgroep == "mariene en estuariene soorten" & dieet == "benthivoren" ~ "Mar/Est -- Benth",
           salgroep == "mariene en estuariene soorten" & dieet == "piscivoren" ~ "Mar/Est -- Pisc",
           salgroep == "mariene en estuariene soorten" & dieet == "planktivoren" ~ "Mar/Est -- Plankt",
           salgroep == "mariene en estuariene soorten" & dieet == "omnivoren" ~ "Mar/Est -- Omn",
           salgroep == "diadrome soorten" & dieet == "benthivoren" ~ "Diadr -- Benth",
           salgroep == "diadrome soorten" & dieet == "piscivoren" ~ "Diadr -- Pisc",
           salgroep == "diadrome soorten" & dieet == "omnivoren" ~ "Diadr -- Omn",
           salgroep == "zoetwatersoorten" & dieet == "benthivoren" ~ "Zoetw -- Benth",
           salgroep == "zoetwatersoorten" & dieet == "piscivoren" ~ "Zoetw -- Pisc",
           salgroep == "zoetwatersoorten" & dieet == "omnivoren" ~ "Zoetw -- Omn"),
         indeling = factor(indeling, levels = levels_indeling),
         in_indeling = !is.na(indeling)) %>% 
  left_join(sleutelsoorten_EMSE %>% select(-scheldezone) %>% rename(indeling_SL = indeling))

indeling_EMSE <-
  data_ankerkuil %>% 
  distinct(soort, salgroep, dieet, in_indeling, indeling, indeling_SL)

# levels(data_ankerkuil$indeling)
# levels(indeling_EMSE$indeling)

```

#### relatie aantal - gewicht

```{r relatie-aantal-gewicht}

# data_ankerkuil %>%
#   ggplot(aes(aantal, gewicht)) +
#   geom_point() +
#   geom_smooth(span = 10, se = FALSE) +
#   facet_wrap(~soort,
#              scales = "free",
#              ncol = 5)

data_ankerkuil %>% 
  ggplot(aes(aantal + 1, gewicht + 1)) +
  geom_point() +
  geom_smooth(span = 10, se = FALSE) +
  scale_x_log10(breaks = c(0,1,10,100,1000,10000,100000,1000000,10000000) + 1, labels = function(x) x-1) +
  scale_y_log10(breaks = c(0,1,10,100,1000,10000,100000,1000000,10000000) + 1, labels = function(x) x-1) +
  labs(x = "aantal",
       y = "gewicht") +
  facet_wrap(~soort, 
             scales = "free",
             ncol = 8)

# # ggsave(paste0(pad_figuren, "relatie_aantal_gewicht.jpg"))

```


#### aantal soorten

```{r aantal-soorten}

# aantal_soorten_seizoen_locatie <- 
#   data_ankerkuil %>% 
#   filter(aantal > 0) %>% 
#   distinct(jaar, seizoen, locatie, soort) %>% 
#   count(jaar, seizoen, locatie, name = "soorten")
# 
# aantal_soorten_seizoen_locatie %>% 
#   ggplot(aes(jaar, soorten, fill = ordered(jaar), color = ordered(jaar))) +
#   geom_col(position = position_dodge(width = 0.8),
#            width = 0.7,
#            alpha = 0.8) +
#   geom_text(aes(y = soorten + 2, label = soorten),
#             position = position_dodge(width = 0.8),
#             size = 4, color = "steelblue4") +
#   scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
#   # labs(fill = "jaar",
#   #      color = "jaar") +
#   guides(fill="none",
#          color = "none") +
#   facet_grid(seizoen ~ locatie)
# 
# ggsave(paste0(pad_figuren, "aantal_soorten_seizoen_locatie.jpg"))


aantal_soorten_seizoen_locatie <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, seizoen, locatie, soort) %>% 
  count(jaar, seizoen, locatie, name = "soorten") %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, locatie, soort) %>% 
              count(jaar, locatie, name = "soorten") %>% 
              mutate(seizoen = "totaal over seizoenen")) %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, seizoen, soort) %>% 
              count(jaar, seizoen, name = "soorten") %>% 
              mutate(locatie = "totaal over locaties")) %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, soort) %>% 
              count(jaar, name = "soorten") %>% 
              mutate(seizoen = "totaal over seizoenen",
                     locatie = "totaal over locaties")) %>% 
  mutate(seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar", "totaal over seizoenen")),
         locatie = factor(locatie, levels = c("Doel", "Antwerpen", "Steendorp", "Branst", "totaal over locaties")))

aantal_soorten_seizoen_locatie %>% 
  ggplot(aes(jaar, soorten)) +
  geom_col(position = position_dodge(width = 0.8),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 3, label = soorten),
            position = position_dodge(width = 0.8),
            size = 3, color = "steelblue4") +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # labs(fill = "jaar",
  #      color = "jaar") +
  # guides(fill="none",
  #        color = "none") +
  facet_grid(seizoen ~ locatie) +
  theme(strip.text = element_text(size = 12))

ggsave(paste0(pad_figuren, "aantal_soorten_seizoen_locatie.jpg"), width = 10, height = 8)


aantal_soorten_seizoen <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, seizoen, locatie, soort) %>% 
  count(jaar, seizoen, locatie, name = "soorten") %>% 
  group_by(jaar, seizoen) %>%
  summarise(soorten = round(mean(soorten))) %>% 
  ungroup() %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, locatie, soort) %>% 
              count(jaar, locatie, name = "soorten") %>% 
              group_by(jaar) %>% 
              summarise(soorten = round(mean(soorten))) %>% 
              ungroup() %>% 
              mutate(seizoen = "totaal over seizoenen")) %>% 
  mutate(seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar", "totaal over seizoenen")))

aantal_soorten_seizoen %>% 
  ggplot(aes(seizoen, soorten, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(width = 0.8),
           width = 0.6,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 1, label = soorten),
            position = position_dodge(width = 0.8),
            size = 2, color = "steelblue4") +
  labs(fill = "jaar",
       color = "jaar")

ggsave(paste0(pad_figuren, "aantal_soorten_seizoen.jpg"), width = 8, height = 4)


aantal_soorten_locatie <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, seizoen, locatie, soort) %>% 
  count(jaar, seizoen, locatie, name = "soorten") %>% 
  group_by(jaar, locatie) %>%
  summarise(soorten = round(mean(soorten))) %>% 
  ungroup() %>% 
  bind_rows(data_ankerkuil %>% 
              filter(aantal > 0) %>% 
              distinct(jaar, seizoen, soort) %>% 
              count(jaar, seizoen, name = "soorten") %>% 
              group_by(jaar) %>% 
              summarise(soorten = round(mean(soorten))) %>% 
              ungroup() %>% 
              mutate(locatie = "totaal over locaties")) %>% 
  mutate(locatie = factor(locatie, levels = c("Doel", "Antwerpen", "Steendorp", "Branst", "totaal over locaties")))

aantal_soorten_locatie %>% 
  ggplot(aes(locatie, soorten, fill = ordered(jaar), color = ordered(jaar))) +
  geom_col(position = position_dodge(width = 0.8),
           width = 0.6,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 1, label = soorten),
            position = position_dodge(width = 0.8),
            size = 2, color = "steelblue4") +
  labs(fill = "jaar",
       color = "jaar")

ggsave(paste0(pad_figuren, "aantal_soorten_locatie.jpg"), width = 8, height = 4)


aantal_soorten_totaal <- 
  data_ankerkuil %>% 
  filter(aantal > 0) %>% 
  distinct(jaar, soort) %>% 
  count(jaar, name = "soorten")

aantal_soorten_totaal %>% 
  ggplot(aes(jaar, soorten)) +
  geom_col(position = position_dodge(width = 0.8),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  geom_text(aes(y = soorten + 2, label = soorten),
            position = position_dodge(width = 0.8),
            size = 3, color = "steelblue4") +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # labs(fill = "jaar",
  #      color = "jaar") +
  guides(fill="none",
         color = "none")

ggsave(paste0(pad_figuren, "aantal_soorten_totaal.jpg"), width = 6, height = 4)

```


#### overzicht gevangen soorten

```{r overzicht-gevangen-soorten}

tabel_gevangen_soorten <-
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar,
         aantal > 0) %>% 
  mutate(seizoen_locatie = factor(paste(seizoen, locatie, sep = "_"),
                                  levels = sapply(c("voorjaar", "zomer", "najaar"),
                                                  function(x) paste(x, c("Doel", "Antwerpen", "Steendorp", "Branst"), sep = "_")) %>%
                                    c())) %>%
  select(seizoen_locatie, soort) %>% 
  mutate(aanwezig = "x") %>% 
  spread(seizoen_locatie, aanwezig, fill = "")

knitr::kable(tabel_gevangen_soorten)

sheets[["gevangen_soorten"]] <- tabel_gevangen_soorten
  

# write_xlsx(list(gevangen_soorten = tabel_gevangen_soorten),
#            paste0(pad_tabellen, "tabellen_vissen.xlsx"))

```



```{r overzicht-aantal-soorten}

tabel_aantal_soorten <-
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar,
         aantal > 0) %>%
  distinct(seizoen, locatie, soort) %>% 
  count(seizoen, locatie, name = "soorten") %>% 
  bind_rows(data_ankerkuil %>% 
              filter(jaar == laatste_jaar,
                     aantal > 0) %>% 
              distinct(locatie, soort) %>% 
              count(locatie, name = "soorten") %>% 
              mutate(seizoen = "totaal over seizoenen")) %>% 
  bind_rows(data_ankerkuil %>% 
              filter(jaar == laatste_jaar,
                     aantal > 0) %>% 
              distinct(seizoen, soort) %>% 
              count(seizoen, name = "soorten") %>% 
              mutate(locatie = "totaal over locaties")) %>% 
  bind_rows(data_ankerkuil %>% 
              filter(jaar == laatste_jaar,
                     aantal > 0) %>% 
              distinct(soort) %>% 
              count(name = "soorten") %>% 
              mutate(seizoen = "totaal over seizoenen",
                     locatie = "totaal over locaties")) %>% 
  mutate(seizoen = factor(seizoen, levels = c("voorjaar", "zomer", "najaar", "totaal over seizoenen")),
         locatie = factor(locatie, levels = c("Doel", "Antwerpen", "Steendorp", "Branst", "totaal over locaties"))) %>% 
  pivot_wider(locatie, names_from = seizoen, values_from = soorten)

knitr::kable(tabel_aantal_soorten)

sheets[["aantal_soorten"]] <- tabel_aantal_soorten
  


# write_xlsx(list(gevangen_soorten = tabel_gevangen_soorten),
#            paste0(pad_tabellen, "tabellen_vissen.xlsx"))

```


#### relatief aantal gevangen individuen

```{r test kleurcode, eval=FALSE}

relatief_aantal <- 
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar) %>% 
  group_by(seizoen, locatie) %>%
  mutate(relatief_aantal = aantal/sum(aantal),
         relatief_gewicht = gewicht/sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(soort) %>% 
  mutate(soort2 = ifelse(any(relatief_aantal >= prop_lim | relatief_gewicht >= prop_lim), soort, "rest")) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie, soort2) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie) %>% 
  mutate(soort2 = soort2,
         aantal = round(aantal/sum(aantal)*100)) %>% 
  ungroup() %>% 
  rename(soort = soort2) %>% 
  mutate(soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest")))

for(s in 51:100) {

  set.seed(s)
  
  my_pal_wes <- 
    c(wes_palette("Darjeeling1", 
                  type = "continuous", 
                  n = length(unique(soortenlijst$soort))) %>% 
        unname() %>%
        sample(), 
      "darkslategrey")
  names(my_pal_wes) <-
    c(unique(soortenlijst$soort), "rest")
  
  the_pal <- 
    my_pal_wes[names(my_pal_wes) %in% unique(relatief_aantal$soort)]
  
  pl <-
    relatief_aantal %>% 
    mutate(aantal = if_else(aantal == 0, NA_real_, aantal)) %>% 
    ggplot(aes(x ="", y = aantal, fill = soort)) +
    geom_col(position = "fill") +
    # geom_text(aes(label = soort),
    #            size = 3) +
    geom_text(aes(label = aantal, size = aantal),
              position = position_fill(vjust = 0.5),
              show.legend = FALSE) +
    coord_polar("y", start=0) +
    facet_grid(locatie ~ seizoen) +
    labs(title = str_c("seed = ", s),
         x = NULL,
         y = NULL) +
    scale_x_discrete(breaks = NULL) +
    scale_y_continuous(breaks = NULL) +
    scale_fill_manual(values = the_pal) +
    theme(
      # legend.position = "bottom",
      legend.title = element_blank())
  print(pl)
  
}

```


```{r relatief-aantal-gevangen-individuen, fig.height=6, fig.width=6}

relatief_aantal <- 
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar) %>% 
  group_by(seizoen, locatie) %>%
  mutate(relatief_aantal = aantal/sum(aantal),
         relatief_gewicht = gewicht/sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(soort) %>% 
  mutate(soort2 = ifelse(any(relatief_aantal >= prop_lim | relatief_gewicht >= prop_lim), soort, "rest")) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie, soort2) %>% 
  summarise(aantal = sum(aantal)) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie) %>% 
  mutate(soort2 = soort2,
         aantal = round(aantal/sum(aantal)*100)) %>% 
  ungroup() %>% 
  rename(soort = soort2) %>% 
  mutate(soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest")))

# my_pal_wes <- 
#   c(wes_palette("Darjeeling1", 
#                 type = "continuous", 
#                 n = length(levels(relatief_aantal$soort)) - 1) %>% 
#       unname(), 
#     "darkslategrey")
# names(my_pal_wes) <-
#   levels(relatief_aantal$soort)

the_pal <- 
  my_pal_wes[names(my_pal_wes) %in% unique(relatief_aantal$soort)]

relatief_aantal %>% 
  mutate(aantal = if_else(aantal == 0, NA_real_, aantal)) %>% 
  ggplot(aes(x ="", y = aantal, fill = soort)) +
  geom_col(position = "fill") +
  # geom_text(aes(label = soort),
  #            size = 3) +
  geom_text(aes(label = aantal, size = aantal),
            position = position_fill(vjust = 0.5),
            show.legend = FALSE) +
  coord_polar("y", start=0) +
  facet_grid(locatie ~ seizoen) +
  labs(x = NULL,
       y = NULL) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  scale_fill_manual(values = the_pal) +
  theme(
    # legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "relatief_aantal_gevangen_individuen.jpg"))

```


#### relatieve biomassa gevangen individuen

```{r relatieve-biomassa-gevangen-individuen, fig.height=6, fig.width=6}

relatief_gewicht <- 
  data_ankerkuil %>% 
  filter(jaar == laatste_jaar) %>% 
  group_by(seizoen, locatie) %>%
  mutate(relatief_aantal = aantal/sum(aantal),
         relatief_gewicht = gewicht/sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(soort) %>% 
  mutate(soort2 = ifelse(any(relatief_aantal >= prop_lim | relatief_gewicht >= prop_lim), soort, "rest")) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie, soort2) %>% 
  summarise(gewicht = sum(gewicht)) %>% 
  ungroup() %>% 
  group_by(seizoen, locatie) %>% 
  mutate(soort2 = soort2,
         gewicht = round(gewicht/sum(gewicht)*100)) %>% 
  ungroup() %>% 
  rename(soort = soort2) %>% 
  mutate(soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest")))

# my_pal_wes <- 
#   c(wes_palette("Darjeeling1", 
#                 type = "continuous", 
#                 n = length(levels(relatief_gewicht$soort)) - 1) %>% 
#       unname(), 
#     "darkslategrey")
# names(my_pal_wes) <-
#   levels(relatief_gewicht$soort)

the_pal <- 
  my_pal_wes[names(my_pal_wes) %in% unique(relatief_aantal$soort)]

relatief_gewicht %>% 
  mutate(gewicht = if_else(gewicht == 0, NA_real_, gewicht)) %>% 
  ggplot(aes(x ="", y = gewicht, fill = soort)) +
  geom_col(position = "fill") +
  # geom_text(aes(label = soort),
  #            size = 3) +
  geom_text(aes(label = gewicht, size = gewicht),
            position = position_fill(vjust = 0.5),
            show.legend = FALSE) +
  coord_polar("y", start=0) +
  facet_grid(locatie ~ seizoen) +
  labs(x = NULL,
       y = NULL) +
  scale_x_discrete(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  scale_fill_manual(values = the_pal) +
  theme(
    # legend.position = "bottom",
        legend.title = element_blank())

ggsave(paste0(pad_figuren, "relatieve_biomassa_gevangen_individuen.jpg"))

```


#### aantallen EMSE

```{r aantallen EMSE}

gemiddeld_aantal_EMSE <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(in_indeling) %>% 
  group_by(jaar, scheldezone, seizoen, locatie, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = sum(aantal_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
  ungroup() %>% 
  add_row(tibble(aantal_per_kub = NA, 
                 salgroep = "diadrome soorten", 
                 indeling = "Diadr -- Benth", 
                 jaar = vroegste_jaar:laatste_jaar) %>% 
            expand_grid(scheldezone = c("SG", "OH", "ZL"))) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full))

gemiddeld_aantal_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  mutate(aantal_per_kub = aantal_per_kub*mult_kub) %>%
  # ggplot(aes(jaar, aantal_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
  ggplot(aes(jaar, aantal_per_kub)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  # geom_linerange(aes(ymin = 0, ymax = aantal_per_kub),
  #                size = 4) +
  # geom_text(aes(y = aantal_per_kub + 0.3, label = aantal_per_kub), 
  #           position = position_dodge(width = 0.925),
  #           size = 3) +
  # scale_fill_viridis_c() +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) + 
  # guides(fill = "none",
  #        color = "none") +
  # facet_grid(scheldezone ~ indeling, scales = "free_y") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "aantallen_EMSE_marien.jpg"), width = 7, height = 6)


gemiddeld_aantal_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  mutate(aantal_per_kub = aantal_per_kub*mult_kub) %>%
  ggplot(aes(jaar, aantal_per_kub)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "diadrome soorten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "aantallen_EMSE_diadroom.jpg"), width = 8, height = 6)


gemiddeld_aantal_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  mutate(aantal_per_kub = aantal_per_kub*mult_kub) %>%
  ggplot(aes(jaar, aantal_per_kub)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "zoetwater soorten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "aantallen_EMSE_zoet.jpg"), width = 8, height = 6)


# gemiddeld_aantal_niet_EMSE <- 
#   data_ankerkuil %>% 
#   filter(!in_indeling,
#          !is.na(dieet)) %>% 
#   group_by(jaar, seizoen, locatie, salgroep, dieet) %>%
#   summarise(aantal_per_kub = sum(aantal_per_kub)) %>% 
#   ungroup() %>% 
#   group_by(jaar, salgroep, dieet) %>%
#   summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
#   ungroup()
# 
# gemiddeld_aantal_niet_EMSE %>% 
#   mutate(aantal_per_kub = aantal_per_kub*mult_kub) %>%
#   ggplot(aes(jaar, aantal_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
#   geom_col(position = position_dodge(),
#            width = 0.7,
#            alpha = 0.8) +
#   # geom_linerange(aes(ymin = 0, ymax = aantal_per_kub),
#   #                size = 4) +
#   # geom_text(aes(y = aantal_per_kub + 0.3, label = aantal_per_kub), 
#   #           position = position_dodge(width = 0.925),
#   #           size = 3) +
#   # scale_fill_viridis_c() +
#   scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
#   # scale_y_log10() +
#   labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
#   guides(fill = "none",
#          color = "none") +
#   facet_wrap(salgroep ~ dieet, scales = "free_y")
# 
# ggsave(paste0(pad_figuren, "aantallen_niet_EMSE.jpg"), width = 4, height = 3)

```


#### gewicht EMSE

```{r gewicht EMSE}

gemiddeld_gewicht_EMSE <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(in_indeling) %>% 
  group_by(jaar, scheldezone, seizoen, locatie, salgroep, dieet, indeling) %>%
  summarise(gewicht_per_kub = sum(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  summarise(gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  add_row(tibble(gewicht_per_kub = NA, 
                 salgroep = "diadrome soorten", 
                 indeling = "Diadr -- Benth", 
                 jaar = vroegste_jaar:laatste_jaar) %>% 
            expand_grid(scheldezone = c("SG", "OH", "ZL"))) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full))

gemiddeld_gewicht_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  mutate(gewicht_per_kub = gewicht_per_kub*mult_kub) %>%
  # ggplot(aes(jaar, gewicht_per_kub, fill = ordered(jaar), color = ordered(jaar))) +
  ggplot(aes(jaar, gewicht_per_kub)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "biomassa_EMSE_marien.jpg"), width = 7, height = 6)


gemiddeld_gewicht_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  mutate(gewicht_per_kub = gewicht_per_kub*mult_kub) %>%
  ggplot(aes(jaar, gewicht_per_kub)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "diadrome soorten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "biomassa_EMSE_diadroom.jpg"), width = 8, height = 6)


gemiddeld_gewicht_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  mutate(gewicht_per_kub = gewicht_per_kub*mult_kub) %>%
  ggplot(aes(jaar, gewicht_per_kub)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "zoetwater soorten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "biomassa_EMSE_zoet.jpg"), width = 8, height = 6)

```


#### diversiteit EMSE

```{r diversiteit EMSE}

gemiddeld_diversiteit_EMSE <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(in_indeling) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, scheldezone, soort, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub)) %>% 
  summarise(N = n(),
            H_sh = -sum(relatief_aantal*log(relatief_aantal)),
            H_gs = 1-sum(relatief_aantal^2),
            D_sh = exp(H_sh),
            D_gs = 1/(1-H_gs),
            E_sh = H_sh/log(N)) %>%
  ungroup() %>% 
  add_row(tibble(N = NA, H_sh = NA, H_gs = NA, D_sh = NA, D_gs = NA,
                 salgroep = "diadrome soorten", 
                 indeling = "Diadr -- Benth", 
                 jaar = vroegste_jaar:laatste_jaar) %>% 
            expand_grid(scheldezone = c("SG", "OH", "ZL"))) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full))

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "estuariene soorten en mariene migranten",
       y = "aantal soorten") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_N_EMSE_marien.jpg"), width = 8, height = 8)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "diadrome soorten",
       y = "aantal soorten") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_N_EMSE_diadroom.jpg"), width = 8, height = 6)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "zoetwater soorten",
       y = "aantal soorten") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_N_EMSE_zoet.jpg"), width = 8, height = 6)


gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, H_sh)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "estuariene soorten en mariene migranten",
       y = "shannon diversity index H") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_H_shannon_EMSE_marien.jpg"), width = 8, height = 8)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  ggplot(aes(jaar, H_sh)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "diadrome soorten",
       y = "shannon diversity index H") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_H_shannon_EMSE_diadroom.jpg"), width = 8, height = 6)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, H_sh)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(title = "zoetwater soorten",
       y = "shannon diversity index H") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_H_shannon_EMSE_zoet.jpg"), width = 8, height = 6)


gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, D_sh)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "estuariene soorten en mariene migranten",
       y = "shannon true diversity D") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_D_shannon_EMSE_marien.jpg"), width = 8, height = 8)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  ggplot(aes(jaar, D_sh)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "diadrome soorten",
       y = "shannon true diversity D") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_D_shannon_EMSE_diadroom.jpg"), width = 8, height = 6)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, D_sh)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(title = "zoetwater soorten",
       y = "shannon true diversity D") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_D_shannon_EMSE_zoet.jpg"), width = 8, height = 6)


gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.25) +
  geom_col(aes(y = D_sh),
           color = "steelblue4",
           size = 0.5,
           position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(# title = "estuariene soorten en mariene migranten",
       y = "S -- D") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_S_D_EMSE_marien.jpg"), width = 7, height = 6)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.25) +
  geom_col(aes(y = D_sh),
           color = "steelblue4",
           size = 0.5,
           position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(# title = "diadrome soorten",
       y = "S -- D") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_S_D_EMSE_diadroom.jpg"), width = 7, height = 5)

gemiddeld_diversiteit_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.25) +
  geom_col(aes(y = D_sh),
           color = "steelblue4",
           size = 0.5,
           position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(# title = "zoetwater soorten",
       y = "S -- D") +
  facet_grid(indeling ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_S_D_EMSE_zoet.jpg"), width = 7, height = 5)

```


#### relatieven aantallen EMSE

```{r relatie aantallen vs aantal soorten}

relatieve_aantallen_EMSE <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(in_indeling) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, scheldezone, soort, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub),
         relatief_gewicht = gewicht_per_kub/sum(gewicht_per_kub)) %>% 
  # mutate(max_aantal = relatief_aantal == max(relatief_aantal),
  #        max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  mutate(max_aantal = relatief_aantal >= prop_lim,
         max_gewicht = relatief_gewicht >= prop_lim) %>%
  ungroup() %>% 
  group_by(soort) %>% 
  # mutate(soort = ifelse(any(max_aantal | max_gewicht), soort, "rest")) %>%
  mutate(soort = ifelse(any(max_aantal), soort, "rest")) %>%
  ungroup() %>% 
  # mutate(soort = if_else(max_aantal | max_gewicht, soort, "rest")) %>%
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = relatief_aantal/sum(relatief_aantal)) %>% 
  ungroup() %>% 
  add_row(tibble(salgroep = "diadrome soorten", 
                 indeling = "Diadr -- Benth", 
                 jaar = vroegste_jaar:laatste_jaar) %>% 
            expand_grid(scheldezone = c("SG", "OH", "ZL"))) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest"))) %>% 
  left_join(gemiddeld_diversiteit_EMSE)

# relatieve_aantallen_EMSE %>% 
#   distinct(soort) %>% pull(soort)


# my_pal_yarr <- 
#   c(piratepal(palette = "info2", 
#             trans = 1,
#             plot.result = F,
#             length.out = length(levels(relatieve_aantallen_EMSE$soort))-1) %>% 
#   unname(), 
#   "grey")

# my_pal_wes <- 
#   c(wes_palette("Darjeeling1", 
#                 type = "continuous", 
#                 n = length(levels(relatieve_aantallen_EMSE$soort)) - 1) %>% 
#       unname() %>% 
#       sample(), 
#     "darkslategrey")
# names(my_pal_wes) <-
#   levels(relatieve_aantallen_EMSE$soort)


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*N, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = "aantal soorten",
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, relatief_aantal*N, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(title = "estuariene soorten en mariene migranten",
       y = "aantal soorten") +
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.1,1,0.05)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_aantallen_EMSE_marien.jpg"), width = 11, height = 7, bg = "white")


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*N, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = "aantal soorten",
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  ggplot(aes(jaar, relatief_aantal*N, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(title = "diadrome soorten",
       y = "aantal soorten") +
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.1,1,0.05)),
          ncol = 3, rel_widths = c(1.6,0.05,0.4))

ggsave(paste0(pad_figuren, "relatieve_aantallen_EMSE_diadroom.jpg"), width = 11, height = 7, bg = "white")


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*N, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = "aantal soorten",
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, relatief_aantal*N, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(title = "zoetwater soorten",
       y = "aantal soorten") +
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.1,1,0.05)),
          ncol = 3, rel_widths = c(1.6,0.05,0.4))

ggsave(paste0(pad_figuren, "relatieve_aantallen_EMSE_zoet.jpg"), width = 11, height = 7, bg = "white")

```


```{r relatie aantallen vs totale aantallen}

relatieve_aantallen_EMSE <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(in_indeling) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, scheldezone, soort, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub),
         relatief_gewicht = gewicht_per_kub/sum(gewicht_per_kub)) %>% 
  # mutate(max_aantal = relatief_aantal == max(relatief_aantal),
  #        max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  mutate(max_aantal = relatief_aantal >= prop_lim,
         max_gewicht = relatief_gewicht >= prop_lim) %>%
  ungroup() %>% 
  group_by(soort) %>% 
  # mutate(soort = ifelse(any(max_aantal | max_gewicht), soort, "rest")) %>%
  mutate(soort = ifelse(any(max_aantal), soort, "rest")) %>%
  ungroup() %>% 
  # mutate(soort = if_else(max_aantal | max_gewicht, soort, "rest")) %>%
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = relatief_aantal/sum(relatief_aantal),
         relatief_gewicht = relatief_gewicht/sum(relatief_gewicht)) %>% 
  ungroup() %>% 
  add_row(tibble(salgroep = "diadrome soorten", 
                 indeling = "Diadr -- Benth", 
                 jaar = vroegste_jaar:laatste_jaar) %>% 
            expand_grid(scheldezone = c("SG", "OH", "ZL"))) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest"))) %>% 
  select(-aantal_per_kub, -gewicht_per_kub) %>% 
  left_join(gemiddeld_aantal_EMSE)

# relatieve_aantallen_EMSE %>% 
#   distinct(soort) %>% pull(soort)


# my_pal_yarr <- 
#   c(piratepal(palette = "info2", 
#             trans = 1,
#             plot.result = F,
#             length.out = length(levels(relatieve_aantallen_EMSE$soort))-1) %>% 
#   unname(), 
#   "grey")

# my_pal_wes <- 
#   c(wes_palette("Darjeeling1", 
#                 type = "continuous", 
#                 n = length(levels(relatieve_aantallen_EMSE$soort)) - 1) %>% 
#       unname() %>% 
#       sample(), 
#     "darkslategrey")
# names(my_pal_wes) <-
#   levels(relatieve_aantallen_EMSE$soort)


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3)),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_aantallen_tot_aantal_EMSE_marien.jpg"), width = 10, height = 6, bg = "white")


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3)),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  # filter(jaar > 2014) %>% 
  ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "diadrome soorten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.1,1,0.05)),
          ncol = 3, rel_widths = c(1.6,0.05,0.4))

ggsave(paste0(pad_figuren, "relatieve_aantallen_tot_aantal_EMSE_diadroom.jpg"), width = 9.5, height = 5, bg = "white")


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3)),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "zoetwater soorten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.6,0.05,0.4))

ggsave(paste0(pad_figuren, "relatieve_aantallen_tot_aantal_EMSE_zoet.jpg"), width = 9.5, height = 5, bg = "white")

```


```{r relatie biomassa vs totale biomassa}

relatieve_aantallen_EMSE <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(in_indeling) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, scheldezone, soort, salgroep, dieet, indeling) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub),
         relatief_gewicht = gewicht_per_kub/sum(gewicht_per_kub)) %>% 
  # mutate(max_aantal = relatief_aantal == max(relatief_aantal),
  #        max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  mutate(max_aantal = relatief_aantal >= prop_lim,
         max_gewicht = relatief_gewicht >= prop_lim) %>%
  ungroup() %>% 
  group_by(soort) %>% 
  # mutate(soort = ifelse(any(max_aantal | max_gewicht), soort, "rest")) %>%
  mutate(soort = ifelse(any(max_aantal), soort, "rest")) %>%
  ungroup() %>% 
  # mutate(soort = if_else(max_aantal | max_gewicht, soort, "rest")) %>%
  group_by(jaar, scheldezone, salgroep, dieet, indeling) %>%
  mutate(relatief_aantal = relatief_aantal/sum(relatief_aantal),
         relatief_gewicht = relatief_gewicht/sum(relatief_gewicht)) %>% 
  ungroup() %>% 
  add_row(tibble(salgroep = "diadrome soorten", 
                 indeling = "Diadr -- Benth", 
                 jaar = vroegste_jaar:laatste_jaar) %>% 
            expand_grid(scheldezone = c("SG", "OH", "ZL"))) %>% 
  mutate(indeling = factor(indeling, levels = levels_indeling),
         scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest"))) %>% 
  select(-aantal_per_kub, -gewicht_per_kub) %>% 
  left_join(gemiddeld_gewicht_EMSE)

# my_pal_wes <- 
#   c(wes_palette("Darjeeling1", 
#                 type = "continuous", 
#                 n = length(levels(relatieve_aantallen_EMSE$soort)) - 1) %>% 
#       unname() %>% 
#       sample(), 
#     "darkslategrey")
# names(my_pal_wes) <-
#   levels(relatieve_aantallen_EMSE$soort)


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]")),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "mari")) %>% 
  ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_biomassa_tot_biomassa_EMSE_marien.jpg"), width = 10, height = 6, bg = "white")


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]")),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "diadr")) %>% 
  ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "diadrome soorten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.1,1,0.05)),
          ncol = 3, rel_widths = c(1.6,0.05,0.4))

ggsave(paste0(pad_figuren, "relatieve_biomassa_tot_biomassa_EMSE_diadroom.jpg"), width = 9.5, height = 5, bg = "white")


data_split <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  group_by(indeling) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(indeling, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]")),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_EMSE %>% 
  filter(str_detect(salgroep, "zoet")) %>% 
  ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "zoetwater soorten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(indeling ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$indeling)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.6,0.05,0.4))

ggsave(paste0(pad_figuren, "relatieve_biomassa_tot_biomassa_EMSE_zoet.jpg"), width = 9.5, height = 5, bg = "white")

```


#### sleutelsoorten EMSE 

```{r sleutelsoorten aantal}

data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(soort %in% sleutelsoorten_EMSE$soort,
         str_detect(salgroep, "mari")) %>% 
  left_join(sleutelsoorten_EMSE %>% select(soort, scheldezone_rap = scheldezone)) %>%
#  filter(map2_lgl(scheldezone_rap, scheldezone, ~str_detect(.x, .y))) %>% 
  group_by(jaar, soort, scheldezone) %>% 
  summarise(aantal_per_kub = mean(aantal_per_kub)*mult_kub) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full)) %>% 
  ggplot(aes(jaar, aantal_per_kub, color = scheldezone, fill = scheldezone)) +
  geom_col(position = position_dodge(width = 0.9),
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) + 
  facet_wrap(~soort,
             scales = "free_y",
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1),
        legend.position = "top")

ggsave(paste0(pad_figuren, "aantallen_sleutelsoorten_EMSE_marien.jpg"), width = 6, height = 8)


data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(soort %in% sleutelsoorten_EMSE$soort,
         str_detect(salgroep, "diadr")) %>% 
  left_join(sleutelsoorten_EMSE %>% select(soort, scheldezone_rap = scheldezone)) %>%
#  filter(map2_lgl(scheldezone_rap, scheldezone, ~str_detect(.x, .y))) %>% 
  group_by(jaar, soort, scheldezone) %>% 
  summarise(aantal_per_kub = mean(aantal_per_kub)*mult_kub) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full)) %>% 
  ggplot(aes(jaar, aantal_per_kub, color = scheldezone, fill = scheldezone)) +
  geom_col(position = position_dodge(width = 0.9),
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(# title = "diadrome soorten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) + 
  facet_wrap(~soort,
             scales = "free_y",
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1),
        legend.position = "top")

ggsave(paste0(pad_figuren, "aantallen_sleutelsoorten_EMSE_diadroom.jpg"), width = 7, height = 7)


data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(soort %in% sleutelsoorten_EMSE$soort,
         str_detect(salgroep, "zoet")) %>% 
  left_join(sleutelsoorten_EMSE %>% select(soort, scheldezone_rap = scheldezone)) %>%
#  filter(map2_lgl(scheldezone_rap, scheldezone, ~str_detect(.x, .y))) %>% 
  group_by(jaar, soort, scheldezone) %>% 
  summarise(aantal_per_kub = mean(aantal_per_kub)*mult_kub) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full)) %>% 
  ggplot(aes(jaar, aantal_per_kub, color = scheldezone, fill = scheldezone)) +
  geom_col(position = position_dodge(width = 0.9),
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_x_continuous(breaks = vroegste_jaar:laatste_jaar) +
  labs(# title = "zoetwatersoorten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) + 
  facet_wrap(~soort,
             scales = "free_y",
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1),
        legend.position = "top")

ggsave(paste0(pad_figuren, "aantallen_sleutelsoorten_EMSE_zoet.jpg"), width = 6, height = 8)

```


```{r sleutelsoorten biomassa}

data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(soort %in% sleutelsoorten_EMSE$soort,
         str_detect(salgroep, "mari")) %>% 
  left_join(sleutelsoorten_EMSE %>% select(soort, scheldezone_rap = scheldezone)) %>%
#  filter(map2_lgl(scheldezone_rap, scheldezone, ~str_detect(.x, .y))) %>% 
  group_by(jaar, soort, scheldezone) %>% 
  summarise(gewicht_per_kub = mean(gewicht_per_kub)*mult_kub) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full)) %>% 
  ggplot(aes(jaar, gewicht_per_kub, color = scheldezone, fill = scheldezone)) +
  geom_col(position = position_dodge(width = 0.9),
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_wrap(~soort,
             scales = "free_y",
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1),
        legend.position = "top")

ggsave(paste0(pad_figuren, "biomassa_sleutelsoorten_EMSE_marien.jpg"), width = 6, height = 8)


data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(soort %in% sleutelsoorten_EMSE$soort,
         str_detect(salgroep, "diadr")) %>% 
  left_join(sleutelsoorten_EMSE %>% select(soort, scheldezone_rap = scheldezone)) %>%
#  filter(map2_lgl(scheldezone_rap, scheldezone, ~str_detect(.x, .y))) %>% 
  group_by(jaar, soort, scheldezone) %>% 
  summarise(gewicht_per_kub = mean(gewicht_per_kub)*mult_kub) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full)) %>% 
  ggplot(aes(jaar, gewicht_per_kub, color = scheldezone, fill = scheldezone)) +
  geom_col(position = position_dodge(width = 0.9),
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  labs(# title = "diadrome soorten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_wrap(~soort,
             scales = "free_y",
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1),
        legend.position = "top")

ggsave(paste0(pad_figuren, "biomassa_sleutelsoorten_EMSE_diadroom.jpg"), width = 7, height = 7)


data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(soort %in% sleutelsoorten_EMSE$soort,
         str_detect(salgroep, "zoet")) %>% 
  left_join(sleutelsoorten_EMSE %>% select(soort, scheldezone_rap = scheldezone)) %>%
#  filter(map2_lgl(scheldezone_rap, scheldezone, ~str_detect(.x, .y))) %>% 
  group_by(jaar, soort, scheldezone) %>% 
  summarise(gewicht_per_kub = mean(gewicht_per_kub)*mult_kub) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full)) %>% 
  ggplot(aes(jaar, gewicht_per_kub, color = scheldezone, fill = scheldezone)) +
  geom_col(position = position_dodge(width = 0.9),
           size = 0.5,
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_x_continuous(breaks = vroegste_jaar:laatste_jaar) +
  labs(# title = "zoetwatersoorten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_wrap(~soort,
             scales = "free_y",
             ncol = 2) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.25, hjust = 1),
        legend.position = "top")

ggsave(paste0(pad_figuren, "biomassa_sleutelsoorten_EMSE_zoet.jpg"), width = 6, height = 8)

```


#### aantallen en biomassa per saliniteit en dieet

```{r aantallen en biomassa per saliniteit}

gemiddeld_aantal_saliniteit <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  group_by(jaar, scheldezone, seizoen, locatie, salgroep) %>%
  summarise(aantal_per_kub = sum(aantal_per_kub),
            gewicht_per_kub = sum(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full))


relatieve_aantallen_saliniteit <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, scheldezone, soort, salgroep) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub),
         relatief_gewicht = gewicht_per_kub/sum(gewicht_per_kub)) %>% 
  # mutate(max_aantal = relatief_aantal == max(relatief_aantal),
  #        max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  mutate(max_aantal = relatief_aantal >= prop_lim,
         max_gewicht = relatief_gewicht >= prop_lim) %>%
  ungroup() %>% 
  group_by(soort) %>% 
  # mutate(soort = ifelse(any(max_aantal | max_gewicht), soort, "rest")) %>%
  mutate(soort = ifelse(any(max_aantal), soort, "rest")) %>%
  ungroup() %>% 
  # mutate(soort = if_else(max_aantal | max_gewicht, soort, "rest")) %>%
  group_by(jaar, scheldezone, salgroep) %>%
  mutate(relatief_aantal = relatief_aantal/sum(relatief_aantal),
         relatief_gewicht = relatief_gewicht/sum(relatief_gewicht)) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest"))) %>% 
  select(-aantal_per_kub, -gewicht_per_kub) %>% 
  left_join(gemiddeld_aantal_saliniteit) %>% 
  mutate(salgroep = factor(salgroep, levels = c("mariene en estuariene soorten", "diadrome soorten", "zoetwatersoorten")))


data_split <-
  relatieve_aantallen_saliniteit %>% 
  group_by(salgroep) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(salgroep, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3)),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_saliniteit %>% 
  ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  facet_grid(salgroep ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$salgroep)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_aantallen_tot_aantal_salgroep.jpg"), width = 12, height = 7, bg = "white")


ggp_all <-
  relatieve_aantallen_saliniteit %>% 
  ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(salgroep ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$salgroep)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_biomassa_tot_biomassa_salgroep.jpg"), width = 12, height = 7, bg = "white")

```


```{r aantallen en biomassa per dieet}

gemiddeld_aantal_dieet <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(!is.na(dieet)) %>% 
  group_by(jaar, scheldezone, seizoen, locatie, dieet) %>%
  summarise(aantal_per_kub = sum(aantal_per_kub),
            gewicht_per_kub = sum(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, dieet) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full))


relatieve_aantallen_dieet <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(aantal > 0,
         !is.na(dieet)) %>% 
  group_by(jaar, scheldezone, soort, dieet) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub),
            gewicht_per_kub = mean(gewicht_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, dieet) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub),
         relatief_gewicht = gewicht_per_kub/sum(gewicht_per_kub)) %>% 
  # mutate(max_aantal = relatief_aantal == max(relatief_aantal),
  #        max_gewicht = relatief_gewicht == max(relatief_gewicht)) %>%
  mutate(max_aantal = relatief_aantal >= prop_lim,
         max_gewicht = relatief_gewicht >= prop_lim) %>%
  ungroup() %>% 
  group_by(soort) %>% 
  # mutate(soort = ifelse(any(max_aantal | max_gewicht), soort, "rest")) %>%
  mutate(soort = ifelse(any(max_aantal), soort, "rest")) %>%
  ungroup() %>% 
  # mutate(soort = if_else(max_aantal | max_gewicht, soort, "rest")) %>%
  group_by(jaar, scheldezone, dieet) %>%
  mutate(relatief_aantal = relatief_aantal/sum(relatief_aantal),
         relatief_gewicht = relatief_gewicht/sum(relatief_gewicht)) %>% 
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         soort = factor(soort, 
                        levels = unique(soort) %>% 
                          sort() %>% 
                          setdiff("rest") %>% 
                          c(., "rest"))) %>% 
  select(-aantal_per_kub, -gewicht_per_kub) %>% 
  left_join(gemiddeld_aantal_dieet) %>% 
  mutate(dieet = factor(dieet, levels = c("benthivoren", "omnivoren", "piscivoren", "planktivoren")))


data_split <-
  relatieve_aantallen_dieet %>% 
  group_by(dieet) %>% 
  nest()

data_split <-
  data_split %>% 
  mutate(legend = 
           map2(dieet, data, 
                function(ind, dat) {
                  pal_split <- 
                    my_pal_wes[names(my_pal_wes) %in% unique(dat$soort)]
                  plt <-
                    dat %>% 
                    ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort)) +
                    geom_col(position = position_stack(),
                             width = 0.7,
                             alpha = 0.9) +
                    scale_x_continuous(breaks = 
                                         seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
                    scale_fill_manual(values = pal_split) +
                    labs(y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3)),
                         fill = ind) + 
                    guides(fill=guide_legend(nrow=4)) +
                    theme(#rect = element_blank(),
                          # rect = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.justification = c(0,1),
                          # legend.title = element_text(size = 8),
                          # legend.text = element_text(size = 8),
                          # legend.background = element_rect(fill = 'transparent', colour = NA_character_),
                          legend.box.background = element_rect(fill = 'transparent', colour = NA_character_))
                  plt %>% 
                    get_legend()
                  }))
# data_split$legend

ggp_all <-
  relatieve_aantallen_dieet %>% 
  ggplot(aes(jaar, relatief_aantal*aantal_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. aantal ind. / ", !!mult_kub, m^3))) +
  facet_grid(dieet ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$dieet)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_aantallen_tot_aantal_dieet.jpg"), width = 10, height = 6, bg = "white")


ggp_all <-
  relatieve_aantallen_dieet %>% 
  ggplot(aes(jaar, relatief_gewicht*gewicht_per_kub*mult_kub, fill = soort, color = soort)) +
  geom_col(width = 0.7,
           alpha = 0.9,
           size = 0.1) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar %% 2 == 0, vroegste_jaar, vroegste_jaar + 1), laatste_jaar, 2)) +
  # scale_y_log10() +
  # scale_fill_brewer(palette = "Paired") +
  scale_fill_manual(values = my_pal_wes) +
  scale_color_manual(values = my_pal_wes) +
  labs(# title = "estuariene soorten en mariene migranten",
       y = expr(paste("gem. biomassa [g/", !!mult_kub, m^3, "]"))) + 
  facet_grid(dieet ~ scheldezone, scales = "free_y") +
  theme(legend.position = "none")


plot_grid(ggp_all,
          NULL,
          plot_grid(NULL,
                    plot_grid(plotlist = data_split$legend[sort.list(data_split$dieet)],
                    align = "h", ncol = 1),
                    NULL,
                    ncol = 1, rel_heights = c(0.07,1,0.1)),
          ncol = 3, rel_widths = c(1.2,0.05,0.5))

ggsave(paste0(pad_figuren, "relatieve_biomassa_tot_biomassa_dieet.jpg"), width = 10, height = 6, bg = "white")

```


#### diversiteit per saliniteit en dieet

```{r diversiteit per saliniteit}

gemiddeld_diversiteit_salgroep <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(aantal > 0) %>% 
  group_by(jaar, scheldezone, soort, salgroep) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, salgroep) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub)) %>% 
  summarise(N = n(),
            H_sh = -sum(relatief_aantal*log(relatief_aantal)),
            H_gs = 1-sum(relatief_aantal^2),
            D_sh = exp(H_sh),
            D_gs = 1/(1-H_gs),
            E_sh = H_sh/log(N)) %>%
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         salgroep = factor(salgroep, levels = c("mariene en estuariene soorten", "diadrome soorten", "zoetwatersoorten")))


gemiddeld_diversiteit_salgroep %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.25) +
  geom_col(aes(y = D_sh),
           color = "steelblue4",
           size = 0.5,
           position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = "S -- D") +
  facet_grid(salgroep ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_S_D_salgroep.jpg"), width = 10, height = 7)

```


```{r diversiteit per dieet}

gemiddeld_diversiteit_dieet <- 
  data_ankerkuil %>% 
  left_join(locatie_scheldezone) %>% 
  filter(aantal > 0,
         !is.na(dieet)) %>% 
  group_by(jaar, scheldezone, soort, dieet) %>%
  summarise(aantal_per_kub = mean(aantal_per_kub)) %>% 
  ungroup() %>% 
  group_by(jaar, scheldezone, dieet) %>%
  mutate(relatief_aantal = aantal_per_kub/sum(aantal_per_kub)) %>% 
  summarise(N = n(),
            H_sh = -sum(relatief_aantal*log(relatief_aantal)),
            H_gs = 1-sum(relatief_aantal^2),
            D_sh = exp(H_sh),
            D_gs = 1/(1-H_gs),
            E_sh = H_sh/log(N)) %>%
  ungroup() %>% 
  mutate(scheldezone = factor(scheldezone, levels = levels_scheldezone),
         scheldezone = recode_factor(scheldezone, !!!levels_scheldezone_full),
         dieet = factor(dieet, levels = c("benthivoren", "omnivoren", "piscivoren", "planktivoren")))


gemiddeld_diversiteit_dieet %>% 
  ggplot(aes(jaar, N)) +
  geom_col(position = position_dodge(),
           color = "steelblue4",
           size = 0.5,
           width = 0.7,
           alpha = 0.25) +
  geom_col(aes(y = D_sh),
           color = "steelblue4",
           size = 0.5,
           position = position_dodge(),
           width = 0.7,
           alpha = 0.8) +
  scale_x_continuous(breaks = seq(ifelse(vroegste_jaar%%2 == 0, vroegste_jaar, vroegste_jaar+1), laatste_jaar, 2)) +
  # scale_y_log10() +
  labs(y = "S -- D") +
  facet_grid(dieet ~ scheldezone, scales = "free_y")

ggsave(paste0(pad_figuren, "diversiteit_S_D_dieet.jpg"), width = 7, height = 6)

```

#### wegschrijven tabellen en metadata

```{r wegschrijven tabellen}

write_xlsx(sheets,
           paste0(pad_tabellen, "tabellen_vissen.xlsx"))

```


```{r meta-data}

meta_data <- 
  enframe(c(vroegste_jaar = vroegste_jaar,
            laatste_jaar = laatste_jaar,
            aantal_soorten = 
              data_ankerkuil %>% 
              filter(!is.na(aantal),
                     aantal > 0) %>% 
              distinct(soort) %>% 
              nrow(),
            aantal_soorten_laatste_jaar = 
              data_ankerkuil %>% 
              filter(!is.na(aantal),
                     aantal > 0,
                     jaar == laatste_jaar) %>% 
              distinct(soort) %>% 
              nrow()),
          name = "naam", value = "waarde")

meta_data %>% 
  write_delim(paste0(pad_data, "vissen_meta_data.csv"),
              delim = ";")

```
