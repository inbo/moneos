---
params:
  hoofdstuk: "130_sedimentatie_erosie"
knit: (function(inputFile, ...) {
        rmarkdown::render(inputFile,
                          output_dir = paste0(rmarkdown::yaml_front_matter(inputFile)$params$hoofdstuk, "/output"))})
title: "figuren historiek MONEOS raaien"
output: word_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, cache=FALSE)

```


```{r libraries}

library(tidyverse)
library(readxl)
library(INBOtheme)
library(rprojroot)

conflicted::conflicts_prefer(dplyr::filter)

```


```{r pad}

# inlezen van variabelen
# pad naar data : pad_data
# pad naar tabellen : pad_tabellen
# pad naar figuren : pad_figuren

source(find_root_file("../pad.R", criterion = is_rstudio_project))

pad_data <- maak_pad(params$hoofdstuk, "data")
pad_figuren <- maak_pad(params$hoofdstuk, "figuren")
pad_tabellen <- maak_pad(params$hoofdstuk, "tabellen")

```


```{r data}

jaar <- 2023
campagne <- "C2022"

data_MONEOS <- 
  read_xlsx(path = str_c(pad_data, "TOPOdata_MONEOSraai_INBO_2023.xlsx"),
            sheet = "TOPOdata_MONEOSRAAIEN_INBO")
data_NA <-
  read_xlsx(path = str_c(pad_data, "toevoeging_NA_grafieken_2023.xlsx"))

raai_campagne <- 
  data_MONEOS %>% 
  distinct(MeetCampagneJaar, Salzone, Omes, DATUM, REEKSCODE, Campagne)

data_NA <-
  data_NA %>% 
  left_join(raai_campagne) %>% 
  drop_na()

data_MONEOS <-
  data_MONEOS %>% 
  bind_rows(data_NA)
 
year_colors <-
  tibble(Year = unique(year(data_MONEOS$DATUM))) %>% 
  arrange(Year) %>% 
  mutate(Colour = c(rev(terrain.colors(n()+1))[c(-1,-2)], 'red'))

```


```{r selectie vaste MONEOS raaien met metingen in laatste jaar}

data_MONEOS <-
  data_MONEOS %>% 
  group_by(REEKSCODE) %>% 
  mutate(meting = any(MeetCampagneJaar == campagne)) %>% 
  ungroup() %>% 
  filter(Campagne == "MONEOS",
         meting == TRUE) %>% 
  select(-meting)


raaicodes <- 
  data_MONEOS %>% 
  distinct(REEKSCODE) %>% 
  pull()

```


```{r ecotoopgrenzen}

tbl_waterstanden <-
  read_xlsx(path = str_c(pad_data, "ecotoopgrenzen.xlsx"))

data_MONEOS <-
  data_MONEOS %>% 
  left_join(tbl_waterstanden)

data_MONEOS <-
  data_MONEOS %>%
  group_by(REEKSCODE, DATUM) %>% 
  mutate(habpres = any(!is.na(Habitat))) %>% 
  ungroup() %>% 
  mutate(ecotoop = 
           case_when(
             habpres ~ Habitat,
             HOOGTE__MT > waterstand_HW85 ~ "schor",
             HOOGTE__MT <= waterstand_HW85 ~ "slik")) %>%
  mutate(ecotoop = 
           case_when(
            HOOGTE__MT < waterstand_LW30 ~ "subtidaal",
            TRUE ~ ecotoop)) %>% 
  select(-habpres)


ecotoopgrenzen <-
  data_MONEOS %>% 
  group_by(REEKSCODE, afstand_grens, Salzone) %>% 
  summarise(bovengrens = unique(afstand_begin),
            bovengrens_meting = min(distance_prof[MeetCampagneJaar == campagne & distance_prof >= (bovengrens + 5)]) - 5,
            bovengrens_schor = min(distance_prof[ecotoop == "schor"], na.rm = TRUE),
            grens_schor = max(distance_prof[ecotoop == "schor" & MeetCampagneJaar == campagne], na.rm = TRUE),
            grens_subtidaal = max(distance_prof[ecotoop == "slik" & MeetCampagneJaar == campagne], na.rm = TRUE)) %>% 
  ungroup() %>% 
  select(REEKSCODE, afstand_grens, Salzone, 
         bovengrens, bovengrens_meting, bovengrens_schor, grens_schor, grens_subtidaal) %>% 
  mutate(across(everything(), ~ifelse(is.infinite(.), NA, .)))
  
```


```{r}

raaien <- 
  data_MONEOS %>% 
  distinct(REEKSCODE, afstand_grens, Salzone, Omes)

```


```{r selectie tot bovengrens}

data_MONEOS <-
  data_MONEOS %>% 
  filter(distance_prof >= afstand_begin)

data_MONEOS %>% 
  distinct(ecotoop)

```


```{r functie figuren}

# naam <- "APa"
# dat_raai <-
#   data_MONEOS %>% 
#   filter(REEKSCODE == naam)

fig_raai <- 
  function(naam, dat_raai, ecotoop = "", subtidaal_grens = TRUE) {
    
    cat(str_c("raai: ", naam, "\n"))
    
    dat_raai <-
      dat_raai %>% 
      mutate(Year = year(DATUM),
             Month = month(DATUM),
             Datum = factor(DATUM)) %>% 
      arrange(Datum, distance_prof)
    # RKSC <-
    #   unique(dat_raai$REEKSCODE)
    RKSC <-
      naam
    
    # dat_last <-
    #   dat %>%
    #   filter(!is.na(Campagne) & Campagne == campagne)
    colors <- 
      dat_raai %>% 
      distinct(Year, Datum) %>% 
      arrange(Datum) %>% 
      left_join(year_colors)
    p <- 
      ggplot(dat_raai, aes(distance_prof, HOOGTE__MT, group = Datum, colour = Datum))
    if(subtidaal_grens) {
      p <-
        p +  
        geom_vline(data = ecotoopgrenzen %>% filter(REEKSCODE == RKSC),
                   aes(xintercept = grens_subtidaal),
                   linetype = 2, color = "lightblue", linewidth = 2)
    }
    
    p <-
      p +  
      # geom_vline(data = ecotoopgrenzen %>% filter(REEKSCODE == RKSC),
      #            aes(xintercept = bovengrens),
      #            linetype = 1, color = "grey50", linewidth = 2) +
      # geom_vline(data = ecotoopgrenzen %>% filter(REEKSCODE == RKSC),
      #            aes(xintercept = bovengrens_schor),
      #            linetype = 2, color = "darkgreen", linewidth = 2) +
      geom_vline(data = ecotoopgrenzen %>% filter(REEKSCODE == RKSC),
                 aes(xintercept = grens_schor),
                 linetype = 2, color = "darkgreen", linewidth = 2) +
      # geom_vline(data = ecotoopgrenzen %>% filter(REEKSCODE == RKSC),
      #            aes(xintercept = grens_laag_middelhoog),
      #            linetype = 3, color = "grey50", linewidth = 1.5) +
      # geom_vline(data = ecotoopgrenzen %>% filter(REEKSCODE == RKSC),
      #            aes(xintercept = grens_middelhoog_hoog),
      #            linetype = 3, color = "grey50", linewidth = 1.5) +
      geom_line(linewidth = 1) + 
      geom_point(size = 2) + 
      # geom_line(data = dat_last, size = 1) +
      # geom_point(data = dat_last, size = 2) +
      scale_x_continuous(breaks = pretty(dat_raai$distance_prof, 20)) +
      scale_y_continuous(breaks = pretty(dat_raai$HOOGTE__MT, 5)) +
      scale_colour_manual(values = colors$Colour) +
      labs(title = ifelse(str_length(ecotoop) == 0, naam, str_c(naam, "  -  ", ecotoop)),
           x = "Afstand tot de dijk (m)",
           y = "Hoogte (m T.A.W.)") + 
      theme_bw() + 
      theme(plot.title = element_text(size = 20, hjust = 0.5),
            axis.title = element_text(size = 18),
            axis.text = element_text(size = 15),
            legend.title = element_text(size = 20), 
            legend.text = element_text(size = 14),
            panel.border = element_blank(),
            panel.grid.minor = element_blank(), 
            panel.grid.major = element_line(colour = "grey")) 
    
    p
  }

```


```{r figuren historiek}

# data_fig <-
#   Afst %>% 
#   left_join(data_MONEOS,
#             relationship = "many-to-many") %>% 
#       filter(distance_prof >= Afstand_begin)
# 
# figuren_MONEOS <-
#   data_fig %>% 
#   # filter(REEKSCODE == "KPb") %>% 
#   group_by(Naam) %>% 
#   nest() %>% 
#   mutate(fig = map2(Naam, data, ~fig_raai(.x, .y)))
# 
# walk2(str_c("Vast_", figuren_MONEOS$Naam), figuren_MONEOS$fig, 
#       ~ggsave(.y, file=str_c(pad_figuren, "vast/", .x, "_", campagne, ".png"), 
#               width=16, height=8, dpi= 350))

figuren_MONEOS <-
  data_MONEOS %>% 
  group_by(REEKSCODE) %>% 
  nest() %>% 
  mutate(fig = map2(REEKSCODE, data, ~fig_raai(.x, .y)))

figuren_MONEOS$fig[[1]]

walk2(figuren_MONEOS$REEKSCODE, figuren_MONEOS$fig, 
      ~ggsave(.y, file=str_c(pad_figuren, "vast/", .x, ".png"), 
              width=16, height=8, dpi= 350))


figuren_MONEOS_slik <-
  data_MONEOS %>% 
  filter(distance_prof >= afstand_slik) %>% 
  group_by(REEKSCODE) %>% 
  nest() %>% 
  mutate(fig = map2(REEKSCODE, data, ~fig_raai(.x, .y, ecotoop = "slik")))

figuren_MONEOS_slik$fig[[1]]

figuren_MONEOS_slik %>% 
  {.; walk2(str_c(.$REEKSCODE, "_slik"), .$fig, 
        ~ggsave(.y, file=str_c(pad_figuren, "vast/", .x, ".png"), 
                width=16, height=8, dpi= 350))}


figuren_MONEOS_schor <-
  data_MONEOS %>% 
  filter(distance_prof <= afstand_schor) %>% 
  group_by(REEKSCODE) %>% 
  nest() %>% 
  mutate(fig = map2(REEKSCODE, data, ~fig_raai(.x, .y, ecotoop = "schor", subtidaal_grens = FALSE)))

figuren_MONEOS_schor$fig[[1]]

figuren_MONEOS_schor %>% 
  {.; walk2(str_c(.$REEKSCODE, "_schor"), .$fig, 
        ~ggsave(.y, file=str_c(pad_figuren, "vast/", .x, ".png"), 
                width=16, height=8, dpi= 350))}


# data_opt <-
#   data_MONEOS %>% 
#   anti_join(Afst) %>% 
#   mutate(Naam = REEKSCODE)
# 
# figuren_opt <-
#   data_opt %>% 
#   group_by(Naam) %>% 
#   nest() %>% 
#   mutate(fig = map2(Naam, data, ~fig_raai(.x, .y)))
# 
# # figuren_opt$fig
# 
# walk2(str_c("Optioneel_", figuren_opt$Naam), figuren_opt$fig, 
#       ~ggsave(.y, file=str_c(pad_figuren, "optioneel/", .x, "_", campagne, ".png"), 
#               width=16, height=8, dpi= 350))

```

